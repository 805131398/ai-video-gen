# AI 视频生成器客户端 - 开发指南

## 项目概述

基于 Electron + React + TypeScript 的桌面应用，用于 AI 视频生成和项目管理。

## 技术栈

- **桌面框架**: Electron 28
- **前端框架**: React 18 + TypeScript
- **构建工具**: Vite 5
- **UI 组件**: Radix UI + Tailwind CSS 4
- **数据库**: better-sqlite3（本地 SQLite）
- **状态管理**: Zustand

## 开发环境准备

### 前置要求

- Node.js 18+
- pnpm 8+

### 安装依赖

```bash
cd client
pnpm install
```

> **注意**: `postinstall` 脚本会自动检查并构建 Electron 原生模块，无需手动操作。

### 常用命令

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 启动 Vite 开发服务器（仅前端） |
| `pnpm build` | 构建前端生产版本 |
| `pnpm electron:dev` | 启动 Electron 开发模式（前端 + Electron） |
| `pnpm electron:build` | 构建桌面应用安装包 |
| `pnpm rebuild:native` | 手动重新构建原生模块 |

## Electron 原生模块说明

本项目使用 `better-sqlite3` 作为本地数据库，这是一个需要原生编译的 Node.js 模块。

### 为什么需要特殊处理？

1. Electron 内置的 Node.js 版本与系统 Node.js 不同
2. 原生模块必须针对特定 Electron 版本编译
3. pnpm 默认阻止运行构建脚本（安全特性）

### 自动化处理

项目已配置 `scripts/ensure-native-modules.js` 脚本，会在以下情况自动运行：

- `pnpm install` 后（通过 `postinstall` 钩子）
- 脚本会智能检测模块是否已编译，只在必要时重新构建

### 手动重新构建

如果遇到模块加载错误，可以手动运行：

```bash
pnpm rebuild:native
```

或直接使用 electron-rebuild：

```bash
npx electron-rebuild -f -w better-sqlite3
```

## 项目结构

```
client/
├── electron/              # Electron 主进程代码
│   ├── main.js           # 主进程入口
│   ├── database.js       # 数据库初始化
│   └── ipc/              # IPC 通信处理
├── src/
│   ├── components/       # React 组件
│   │   ├── project/      # 项目相关组件
│   │   └── ui/           # UI 组件
│   ├── pages/            # 页面组件
│   ├── services/         # API 服务
│   ├── stores/           # Zustand 状态管理
│   └── types/            # TypeScript 类型定义
├── scripts/              # 构建和维护脚本
│   └── ensure-native-modules.js  # 原生模块检查脚本
├── docs/                 # 项目文档
└── dist/                 # 构建输出（自动生成）
```

## 常见问题

### 1. 运行时报错 "Could not locate the bindings file"

**原因**: 原生模块未正确编译

**解决**:
```bash
pnpm rebuild:native
```

### 2. pnpm install 后模块未构建

**原因**: pnpm 阻止了构建脚本

**解决**:
```bash
# 方法1：运行手动构建脚本
pnpm rebuild:native

# 方法2：批准并重新安装
pnpm approve-builds better-sqlite3
pnpm install
```

### 3. Electron 版本升级后模块失效

**解决**:
```bash
# 更新 scripts/ensure-native-modules.js 中的 ELECTRON_VERSION
# 然后重新构建
pnpm rebuild:native
```

## 开发建议

1. **首次克隆项目**: 运行 `pnpm install` 即可，原生模块会自动构建
2. **切换分支**: 如果 Electron 版本变化，运行 `pnpm rebuild:native`
3. **CI/CD**: 确保构建环境有编译工具（Python、C++ 编译器）
4. **跨平台开发**: 不同平台需要分别编译原生模块

## 编译要求

### macOS
- Xcode Command Line Tools
- Python 3

### Windows
- Visual Studio Build Tools
- Python 3

### Linux
- build-essential
- Python 3
