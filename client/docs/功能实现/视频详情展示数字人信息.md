# 视频详情展示数字人信息

## 问题描述

1. 视频详情抽屉中没有展示使用了哪个数字人生成视频，用户无法排查参考形象是否正确
2. 生成的视频没有保存到本地静态资源文件夹（`syncSceneVideoToLocal` 从未被调用）
3. 视频生成完成后，轮询服务用 `status.metadata || {}` 覆盖了原始 metadata，丢失数字人参考信息

## 修复内容

### 1. 视频资源本地同步（SceneVideos.tsx）

- 添加 `useEffect` 监听 videos 变化，对已完成的视频自动调用 `syncSceneVideoToLocal()`
- 使用 `useRef<Set>` 防止重复触发

### 2. 服务端 metadata 保存（generate-video/route.ts）

- 重构 `getCharacterImage()` 返回 `CharacterImageResult` 对象（包含 imageUrl、characterId、characterName、digitalHumanId、source）
- 无论 storyboard 还是普通模式，都保存完整的数字人信息到 metadata：
  - `mode`: 生成模式
  - `useCharacterImage`: 是否使用角色形象
  - `referenceImage`: 参考图 URL
  - `characterId`: 角色 ID
  - `characterName`: 角色名称
  - `digitalHumanId`: 数字人 ID
  - `imageSource`: 来源（digital_human / avatar）
  - `aspectRatio`: 宽高比
  - `hd`: 是否高清

### 3. 轮询服务 metadata 合并（video-polling-service.ts）

- 完成时先读取原始 metadata，再与 AI 服务返回的 metadata 合并（`{ ...originalMetadata, ...aiMetadata }`）
- 防止数字人信息被覆盖丢失

### 4. 客户端展示（VideoDetailDrawer.tsx）

- 新增"参考形象"区块（紫色主题），展示：
  - 数字人/角色头像缩略图（使用 ImageWithFallback 组件）
  - 角色名称
  - 图片来源（数字人形象 / 角色头像）
- 仅在 `useCharacterImage` 且有相关信息时显示
- 优化 promptType 显示，支持 storyboard 后缀

## 涉及文件

- `client/src/pages/SceneVideos.tsx` - 添加本地同步逻辑
- `client/src/components/scene-videos/VideoDetailDrawer.tsx` - 展示数字人信息
- `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts` - 保存完整 metadata
- `web/src/lib/services/video-polling-service.ts` - metadata 合并逻辑
