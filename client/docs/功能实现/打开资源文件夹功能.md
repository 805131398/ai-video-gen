# 添加"打开文件夹"功能

## 实现日期
2026-02-01

## 功能描述

在个人中心的"应用设置"标签页中，添加"打开文件夹"按钮，允许用户直接打开系统文件管理器查看静态资源文件夹。

## 功能位置

**页面路径**：`/profile` → 应用设置标签 → 存储使用情况卡片

**按钮位置**：在"刷新"按钮旁边

## 实现细节

### 1. Electron 主进程 (main.ts)

添加 IPC 处理器 `resources:openFolder`：

```typescript
// 打开资源文件夹
ipcMain.handle('resources:openFolder', async () => {
  const { getSetting } = await import('./database');

  // 尝试从设置中读取自定义路径
  const customPath = getSetting('storage_path');
  const resourcesRoot = customPath || path.join(app.getPath('userData'), 'resources');

  // 确保目录存在
  if (!fsSync.existsSync(resourcesRoot)) {
    await fs.mkdir(resourcesRoot, { recursive: true });
  }

  // 打开文件夹
  await shell.openPath(resourcesRoot);

  return { success: true, path: resourcesRoot };
});
```

**关键功能**：
- 读取用户配置的自定义存储路径
- 如果没有配置，使用默认路径
- 确保目录存在，不存在则创建
- 使用 `shell.openPath()` 打开系统文件管理器

### 2. Preload 脚本 (preload.ts)

暴露 API 给渲染进程：

```typescript
resources: {
  // ... 其他方法
  openFolder: () => ipcRenderer.invoke('resources:openFolder'),
}
```

### 3. 前端组件 (StorageUsageDisplay.tsx)

添加"打开文件夹"按钮和处理函数：

```tsx
const handleOpenFolder = async () => {
  try {
    if (window.electron?.resources?.openFolder) {
      const result = await window.electron.resources.openFolder();
      if (result.success) {
        toast({
          title: '已打开文件夹',
          description: result.path,
        });
      }
    } else {
      toast({
        title: '功能不可用',
        description: '请在 Electron 环境中使用此功能',
        variant: 'destructive',
      });
    }
  } catch (error) {
    console.error('打开文件夹失败:', error);
    toast({
      title: '打开失败',
      description: '无法打开资源文件夹',
      variant: 'destructive',
    });
  }
};
```

**UI 布局**：

```tsx
<div className="flex gap-2">
  <Button variant="outline" size="sm" onClick={handleRefresh}>
    <RefreshCw className="w-4 h-4 mr-2" />
    刷新
  </Button>

  <Button variant="outline" size="sm" onClick={handleOpenFolder}>
    <FolderOpen className="w-4 h-4 mr-2" />
    打开文件夹
  </Button>
</div>
```

## 用户体验

### 操作流程

1. 用户进入"个人中心" → "应用设置"标签
2. 在"存储使用情况"卡片中看到两个按钮：
   - **刷新**：重新计算存储使用情况
   - **打开文件夹**：打开资源文件夹
3. 点击"打开文件夹"按钮
4. 系统文件管理器自动打开，显示资源文件夹

### 打开的路径

- **自定义路径**（如果配置）：用户在应用设置中配置的路径
  - 例如：`/Users/zhanghao/Desktop/ai-video-resource`
- **默认路径**（未配置）：`{userData}/resources`
  - macOS: `~/Library/Application Support/ai-video-gen-client/resources`
  - Windows: `%APPDATA%/ai-video-gen-client/resources`
  - Linux: `~/.config/ai-video-gen-client/resources`

### 文件夹结构

```
resources/
└── projects/
    └── {projectId}/
        └── characters/
            └── {characterId}/
                ├── avatar.jpg              # 角色参考图
                └── digital-humans/
                    ├── {humanId1}.jpg      # 数字人图片
                    ├── {humanId2}.jpg
                    └── ...
```

## 错误处理

### 1. 目录不存在
- **处理**：自动创建目录
- **用户体验**：无感知，直接打开新创建的空文件夹

### 2. 权限不足
- **处理**：捕获错误，显示 Toast 提示
- **用户体验**：显示"打开失败"提示

### 3. 非 Electron 环境
- **处理**：检查 `window.electron` 是否存在
- **用户体验**：显示"功能不可用"提示

## 技术要点

### 1. 使用 shell.openPath()

```typescript
import { shell } from 'electron';
await shell.openPath(resourcesRoot);
```

**优势**：
- 跨平台支持（macOS、Windows、Linux）
- 自动使用系统默认文件管理器
- 异步操作，不阻塞主进程

### 2. 目录存在性检查

```typescript
if (!fsSync.existsSync(resourcesRoot)) {
  await fs.mkdir(resourcesRoot, { recursive: true });
}
```

**说明**：
- 使用同步的 `existsSync` 检查
- 使用异步的 `mkdir` 创建（带 `recursive` 选项）
- 确保用户始终能打开文件夹

### 3. Toast 通知

```typescript
toast({
  title: '已打开文件夹',
  description: result.path,
});
```

**用户反馈**：
- 成功：显示打开的路径
- 失败：显示错误原因

## 修改的文件

1. **electron/main.ts**
   - 添加 `resources:openFolder` IPC 处理器
   - 导入 `shell` 模块
   - 添加 `fsSync` 导入

2. **electron/preload.ts**
   - 暴露 `openFolder` API

3. **src/components/profile/StorageUsageDisplay.tsx**
   - 添加 `handleOpenFolder` 函数
   - 添加"打开文件夹"按钮
   - 导入 `FolderOpen` 图标和 `useToast` hook

## 测试建议

### 功能测试

1. **默认路径测试**：
   - 不配置自定义路径
   - 点击"打开文件夹"
   - 验证打开的是 `{userData}/resources`

2. **自定义路径测试**：
   - 配置自定义路径
   - 点击"打开文件夹"
   - 验证打开的是自定义路径

3. **目录不存在测试**：
   - 删除资源文件夹
   - 点击"打开文件夹"
   - 验证自动创建并打开

4. **权限测试**：
   - 设置只读权限的父目录
   - 点击"打开文件夹"
   - 验证错误提示

### 跨平台测试

- ✅ macOS: Finder
- ⬜ Windows: 文件资源管理器
- ⬜ Linux: 默认文件管理器

## 后续优化建议

1. **右键菜单**：在文件列表中添加"在文件夹中显示"选项
2. **快捷键**：添加键盘快捷键（如 Cmd+Shift+O）
3. **路径复制**：添加"复制路径"按钮
4. **文件统计**：显示各类型文件的数量和大小
5. **清理建议**：智能识别可清理的文件
