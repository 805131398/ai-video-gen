# 数字人图片循环请求和外键约束问题修复

## 修复日期
2026-02-01

## 更新记录

### 2026-02-01 - 修复自定义存储路径不生效

**问题**：配置了自定义存储路径后，资源仍然保存到默认路径。

**原因**：
- 设置保存时使用的 key 是 `storage_path_type` 和 `storage_custom_path`
- 但 `resources.ts` 中读取时使用的是错误的 key `storage_path`
- 导致无法读取到用户配置的自定义路径

**解决方案**：
```typescript
// 修复前（错误）
const customPath = getSetting('storage_path');

// 修复后（正确）
const pathType = getSetting('storage_path_type');
const customPath = getSetting('storage_custom_path');

if (pathType === 'custom' && customPath) {
  return customPath;
}
```

**修改文件**：
- `client/electron/resources.ts` - 修复 `getResourcesRoot()` 函数
- `client/electron/main.ts` - 修复 `resources:openFolder` 处理器

---

## 问题描述

### 1. HTTP 404 循环请求
**现象**：后端日志显示大量重复的 HTTP 404 错误，图片下载失败后不断重试。

```
Error downloading resource: Error: Failed to download: HTTP 404
Error downloading resource: Error: Failed to download: HTTP 404
...（循环出现）
```

**原因**：
- 浏览器的 `<img>` 标签在加载失败后会自动重试
- ImageWithFallback 组件虽然显示了错误提示，但 img 标签的 src 仍然是失败的 URL
- 浏览器会不断尝试加载这个 404 的 URL，导致循环请求

### 2. 外键约束失败
**现象**：保存数字人时出现外键约束错误。

```
Error saving digital human: SqliteError: FOREIGN KEY constraint failed
```

**原因**：
- `digital_humans` 表的 `character_id` 字段是外键，引用 `project_characters` 表的 `id`
- 在保存数字人时，对应的 character 可能不存在或已被删除
- 没有进行外键存在性检查，直接尝试插入导致约束失败

## 解决方案

### 1. 修复循环请求问题

**修改文件**：`client/src/components/ImageWithFallback.tsx`

**关键改动**：
1. 添加 `currentSrc` 状态来管理当前的图片 URL
2. 在图片加载失败时，将 `currentSrc` 设置为空字符串
3. 这样浏览器就不会继续尝试加载失败的 URL

```tsx
export default function ImageWithFallback({ src, alt, className, fallbackMessage }) {
  const [hasError, setHasError] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [currentSrc, setCurrentSrc] = useState(src); // 新增

  // 当 src 改变时，重置状态
  useEffect(() => {
    setHasError(false);
    setIsLoading(true);
    setCurrentSrc(src); // 重置为新的 src
  }, [src]);

  const handleError = () => {
    setHasError(true);
    setIsLoading(false);
    setCurrentSrc(''); // 关键：清空 src，避免浏览器重试
  };

  // ...

  return (
    <>
      {/* ... */}
      <img
        src={currentSrc} // 使用 currentSrc 而不是 src
        alt={alt}
        className={`${className} ${isLoading ? 'hidden' : ''}`}
        onError={handleError}
        onLoad={handleLoad}
      />
    </>
  );
}
```

### 2. 修复外键约束问题

**修改文件**：`client/electron/database.ts`

**关键改动**：
在保存数字人之前，先检查 character 是否存在。

```tsx
export function saveDigitalHuman(digitalHuman: any) {
  if (!db) return false;
  try {
    // 先检查 character 是否存在
    const checkStmt = db.prepare('SELECT id FROM project_characters WHERE id = ?');
    const character = checkStmt.get(digitalHuman.characterId);

    if (!character) {
      console.error('Error saving digital human: Character not found:', digitalHuman.characterId);
      return false;
    }

    // 如果 character 存在，继续保存数字人
    const stmt = db.prepare(`
      INSERT OR REPLACE INTO digital_humans (
        id, character_id, image_url, prompt, is_selected, created_at
      ) VALUES (?, ?, ?, ?, ?, ?)
    `);
    stmt.run(
      digitalHuman.id,
      digitalHuman.characterId,
      digitalHuman.imageUrl,
      digitalHuman.prompt,
      digitalHuman.isSelected ? 1 : 0,
      digitalHuman.createdAt
    );
    return true;
  } catch (error) {
    console.error('Error saving digital human:', error);
    return false;
  }
}
```

## 图片存储机制说明

### 本地存储路径
数字人图片会下载到本地存储：

```
{userData}/resources/projects/{projectId}/characters/{characterId}/digital-humans/{resourceId}.jpg
```

### 访问方式
- **本地文件**：通过 `file://` 协议访问
- **远程 URL**：如果本地文件不存在，降级使用远程 URL

### 下载流程
1. 前端调用 `window.electron.resources.download(params)`
2. Electron 主进程下载图片到本地
3. 保存下载记录到数据库（状态：pending → downloading → completed/failed）
4. 前端通过 `getLocalResourceUrl()` 获取显示 URL

```tsx
export function getLocalResourceUrl(localPath: string | null, remoteUrl: string): string {
  // 优先使用本地路径
  if (localPath) {
    return `file://${localPath}`;
  }

  // 降级使用远程 URL
  return remoteUrl;
}
```

## 修复效果

### 修复前
- ❌ 图片加载失败后，浏览器不断重试，产生大量 404 请求
- ❌ 后端日志被 404 错误刷屏
- ❌ 保存数字人时可能因外键约束失败
- ❌ 性能受影响，网络请求浪费

### 修复后
- ✅ 图片加载失败后，立即停止请求
- ✅ 显示友好的错误提示
- ✅ 保存数字人前检查 character 是否存在
- ✅ 避免无效的数据库操作
- ✅ 后端日志清晰，性能提升

## 相关文件

- **ImageWithFallback.tsx** - 图片加载失败处理组件
- **database.ts** - 数据库操作（Electron 主进程）
- **resources.ts** - 资源下载管理（Electron 主进程）
- **localDataService.ts** - 本地数据服务（前端）

## 测试建议

1. **循环请求测试**：
   - 使用无效的图片 URL
   - 观察浏览器网络面板，确认只请求一次
   - 观察后端日志，确认没有重复的 404 错误

2. **外键约束测试**：
   - 尝试保存数字人时，确保 character 存在
   - 删除 character 后，尝试保存数字人，应该返回错误而不是崩溃

3. **图片显示测试**：
   - 正常情况：图片正常显示
   - 加载失败：显示错误提示，不再重试
   - 切换图片：新图片正常加载

## 后续优化建议

1. **重试机制**：为失败的下载添加手动重试按钮
2. **缓存清理**：定期清理失效的本地缓存
3. **下载队列**：限制并发下载数量，避免资源耗尽
4. **错误上报**：收集图片加载失败的统计信息
5. **预加载**：在生成数字人后立即开始下载
