# 资源本地缓存通用机制

## 概述

Electron 客户端提供了一套通用的资源本地缓存系统，支持将远程 URL 资源（图片、视频、音频等）下载到本地，通过自定义协议 `local-resource://` 安全访问，并在 SQLite 中跟踪下载状态。

## 架构

```
渲染进程 (React)
  │  window.electron.resources.download(params)
  │  window.electron.resources.getStatus(type, id)
  ▼
Preload (contextBridge)
  │  ipcRenderer.invoke('resources:download', params)
  ▼
主进程 IPC Handler
  │  registerResourceHandlers()
  ▼
Service Layer (resources/service.ts)
  │  downloadResource() / copyLocalFile()
  ▼
SQLite (resource_downloads 表)
```

## 核心 API

### `window.electron.resources.download(params)`

下载远程资源到本地。

**参数：**

```typescript
{
  url: string;            // 远程资源 URL
  resourceType: string;   // 资源类型（决定存储目录）
  resourceId: string;     // 资源唯一标识
  projectId?: string;     // 项目 ID
  characterId?: string;   // 角色 ID（character_avatar / digital_human / sora_video 需要）
  sceneId?: string;       // 场景 ID（scene_video / video_thumbnail 需要）
  conversationId?: string;// 对话 ID（chat_resource 需要）
  customSavePath?: string;// 自定义保存目录（另存为场景）
}
```

**返回值：**

```typescript
{ success: true, localPath: string, cached?: boolean }  // 成功
{ success: false, error: string, downloading?: boolean } // 失败或下载中
```

**特性：**
- 自动去重：同一 `(resourceType, resourceId)` 不会重复下载
- 文件校验：已完成的下载会检查文件是否存在，丢失则重新下载
- 进度跟踪：下载过程中更新 `downloaded_size`

### `window.electron.resources.getStatus(resourceType, resourceId)`

查询资源下载状态。

```typescript
// 返回值
{
  status: 'pending' | 'downloading' | 'completed' | 'failed';
  progress: number;     // 0-100
  localPath: string;    // 本地绝对路径
  error?: string;       // 失败原因
}
```

### `window.electron.resources.copyLocalFile(sourcePath, params)`

将本地文件复制到资源目录（用于用户上传场景）。

### 其他 API

| API | 说明 |
|-----|------|
| `resources.retry(type, id)` | 重试失败的下载 |
| `resources.getRootPath()` | 获取资源根目录路径 |
| `resources.openFolder()` | 在系统文件管理器中打开资源目录 |
| `resources.readFileInfo(path)` | 读取文件信息 + SHA-256 哈希（供应商上传去重用） |

## 支持的资源类型

| 资源类型 | 存储路径 | 用途 |
|---------|---------|------|
| `character_avatar` | `projects/{pid}/characters/{cid}/avatar.{ext}` | 角色头像 |
| `digital_human` | `projects/{pid}/characters/{cid}/digital-humans/{id}.{ext}` | AI 生成的数字人图片 |
| `sora_video` | `projects/{pid}/characters/{cid}/sora-videos/{taskId}.{ext}` | Sora 生成的视频 |
| `scene_video` | `projects/{pid}/scenes/{sid}/video.{ext}` | 场景视频 |
| `video_thumbnail` | `projects/{pid}/scenes/{sid}/thumbnail.{ext}` | 视频缩略图 |
| `chat_resource` | `chat-resources/{conversationId}/{id}.{ext}` | AI 对话中的资源 |
| 其他 | `projects/{pid}/{id}.{ext}` 或 `global/{id}.{ext}` | 通用回退 |

## 存储目录结构

```
{userData}/resources/          ← 默认根目录（可在设置中自定义）
├── projects/{projectId}/
│   ├── characters/{characterId}/
│   │   ├── avatar.png
│   │   ├── digital-humans/
│   │   │   ├── {humanId1}.png
│   │   │   └── {humanId2}.png
│   │   └── sora-videos/
│   │       ├── {taskId1}.mp4
│   │       └── {taskId2}.mp4
│   └── scenes/{sceneId}/
│       ├── video.mp4
│       └── thumbnail.jpg
├── chat-resources/{conversationId}/
│   └── {resourceId}.png
└── global/
```

## `local-resource://` 协议

Electron 主进程注册的自定义协议，用于渲染进程安全访问本地文件。

**注册（main.ts）：**

```typescript
protocol.registerSchemesAsPrivileged([{
  scheme: 'local-resource',
  privileges: { secure: true, supportFetchAPI: true, bypassCSP: true, corsEnabled: true, stream: true }
}]);

protocol.handle('local-resource', (request) => {
  const filePath = decodeURIComponent(request.url.slice('local-resource://'.length));
  return net.fetch(`file://${filePath}`);
});
```

**使用：**

```tsx
// 图片
<img src={`local-resource://${localPath}`} />

// 视频
<video src={`local-resource://${localPath}`} controls />
```

## 数据库表

```sql
CREATE TABLE resource_downloads (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  resource_type TEXT NOT NULL,
  resource_id TEXT NOT NULL,
  remote_url TEXT NOT NULL,
  local_path TEXT,
  status TEXT NOT NULL,          -- pending | downloading | completed | failed
  error_message TEXT,
  file_size INTEGER,
  downloaded_size INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(resource_type, resource_id)
);
```

## 典型使用模式

### 下载后替换 URL 并持久化

```typescript
// 1. 下载远程资源
const result = await window.electron.resources.download({
  url: remoteUrl,
  resourceType: 'sora_video',
  resourceId: taskId,
  projectId,
  characterId,
});

// 2. 构造本地 URL
const localUrl = result.success
  ? `local-resource://${result.localPath}`
  : remoteUrl;

// 3. 替换数据中的 URL 并持久化
attributes.videoUrl = localUrl;
await updateCharacter(characterId, { attributes });
```

### 页面加载时检查并补缓存

```typescript
useEffect(() => {
  const cacheExisting = async () => {
    if (videoUrl && !videoUrl.startsWith('local-resource://')) {
      const result = await window.electron.resources.download({ url: videoUrl, ... });
      if (result.success) {
        // 更新状态和数据库
      }
    }
  };
  cacheExisting();
}, []);
```

## 已应用的场景

| 场景 | 文档 |
|------|------|
| AI 对话资源保存 | `AI对话资源保存功能.md` |
| 数字人图片缓存 | `数字人图片加载优化.md` |
| Sora 视频缓存 | `Sora视频本地缓存功能.md` |

## 扩展新资源类型

1. 在 `resources/service.ts` 的 `ensureResourceDirectory` 中添加目录映射
2. 在 `getResourcePath` 中添加文件名规则
3. 在渲染进程中调用 `window.electron.resources.download()` 传入新的 `resourceType`
