# 数字人图片加载优化

## 修复日期
2026-02-01

## 更新记录

### 2026-02-01 - Bug 修复
**问题**：当当前数字人形象加载失败后，选择新的数字人图片时，新图片不会显示在"当前数字人形象"区域。

**原因**：ImageWithFallback 组件在图片加载失败后，当 src 改变时没有重置错误状态（hasError 和 isLoading）。

**解决方案**：添加 useEffect 监听 src 变化，当 src 改变时重置状态。

```tsx
// 添加 useEffect 监听 src 变化
useEffect(() => {
  setHasError(false);
  setIsLoading(true);
}, [src]);
```

**修改文件**：`client/src/components/ImageWithFallback.tsx`

---

## 问题描述

在项目详情页面（`/projects/:id`）的数字人生成和历史记录区域，存在以下问题：

1. **图片加载失败无提示**：当数字人图片缓存失效或加载失败时，没有显示占位符或错误提示
2. **CSS 高度设置错误**：DigitalHumanHistory 组件中图片的 `min-h-[200px] max-h-[100px]` 设置不合理（最小高度大于最大高度）
3. **用户体验不佳**：图片加载失败时页面显示空白，用户不知道发生了什么

## 解决方案

### 1. 使用 ImageWithFallback 组件

在以下组件中引入并使用 `ImageWithFallback` 组件来处理图片加载失败的情况：

- **DigitalHumanHistory.tsx** - 历史数字人列表
- **DigitalHumanGenerator.tsx** - 当前选中的数字人形象

### 2. 修复 CSS 高度问题

将 DigitalHumanHistory 中的图片容器改为固定高度：

```tsx
// 修复前
<img
  src={human.imageUrl}
  alt={`数字人 ${human.id}`}
  className="w-full min-h-[200px] max-h-[100px] object-contain bg-gray-50"
/>

// 修复后
<div className="w-full h-[200px]">
  <ImageWithFallback
    src={human.imageUrl}
    alt={`数字人 ${human.id}`}
    className="w-full h-full object-contain bg-gray-50"
    fallbackMessage="数字人图片缓存已失效"
  />
</div>
```

### 3. 统一错误提示

所有数字人图片加载失败时，都会显示统一的错误提示：
- 图标：AlertCircle（警告图标）
- 主文字："图片加载失败"
- 副文字："数字人图片缓存已失效"

## 修改的文件

### 1. DigitalHumanHistory.tsx

**位置**：`client/src/components/project/DigitalHumanHistory.tsx`

**改动**：
- 导入 `ImageWithFallback` 组件
- 将 `<img>` 标签替换为 `<ImageWithFallback>` 组件
- 修复图片容器高度为固定 `h-[200px]`

```tsx
// 添加导入
import ImageWithFallback from '../ImageWithFallback';

// 替换图片显示
<div className="w-full h-[200px]">
  <ImageWithFallback
    src={human.imageUrl}
    alt={`数字人 ${human.id}`}
    className="w-full h-full object-contain bg-gray-50"
    fallbackMessage="数字人图片缓存已失效"
  />
</div>
```

### 2. DigitalHumanGenerator.tsx

**位置**：`client/src/components/project/DigitalHumanGenerator.tsx`

**改动**：
- 导入 `ImageWithFallback` 组件
- 将当前选中数字人的 `<img>` 标签替换为 `<ImageWithFallback>` 组件

```tsx
// 添加导入
import ImageWithFallback from '../ImageWithFallback';

// 替换图片显示
<ImageWithFallback
  src={selectedHuman.imageUrl}
  alt={characterName}
  className="w-full max-h-[300px] object-contain rounded-lg shadow-md cursor-pointer transition-transform hover:scale-[1.02] bg-white"
  fallbackMessage="数字人图片缓存已失效"
/>
```

## ImageWithFallback 组件功能

该组件提供以下功能：

1. **加载状态**：显示加载动画（脉冲效果的 ImageOff 图标）
2. **错误处理**：图片加载失败时显示友好的错误提示
3. **占位符**：使用虚线边框的占位符，保持布局稳定
4. **自定义消息**：支持自定义错误提示文字
5. **状态重置**：当 src 改变时自动重置错误状态，确保新图片能正常加载

### 核心实现

```tsx
import { useState, useEffect } from 'react';

export default function ImageWithFallback({ src, alt, className, fallbackMessage }) {
  const [hasError, setHasError] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // 关键：当 src 改变时，重置状态
  useEffect(() => {
    setHasError(false);
    setIsLoading(true);
  }, [src]);

  const handleError = () => {
    setHasError(true);
    setIsLoading(false);
  };

  const handleLoad = () => {
    setIsLoading(false);
  };

  // ... 渲染逻辑
}
```

## 用户体验改进

### 修复前
- ❌ 图片加载失败时显示空白或破损图标
- ❌ 用户不知道发生了什么
- ❌ 布局可能错乱（高度设置冲突）

### 修复后
- ✅ 图片加载失败时显示清晰的错误提示
- ✅ 用户知道是图片缓存失效，可以联系管理员
- ✅ 布局稳定，固定高度容器
- ✅ 加载过程中显示加载动画

## 技术细节

### 图片容器高度设置

**历史数字人列表**：
- 固定高度：`h-[200px]`
- 对象适配：`object-contain`（保持比例，完整显示）
- 背景色：`bg-gray-50`（浅灰色背景）

**当前选中数字人**：
- 最大高度：`max-h-[300px]`
- 对象适配：`object-contain`
- 背景色：`bg-white`（白色背景）

### 错误提示样式

```tsx
<div className="bg-slate-50 rounded-lg flex flex-col items-center justify-center border-2 border-dashed border-slate-300">
  <AlertCircle className="w-8 h-8 text-amber-500 mb-2" />
  <div className="text-center px-3">
    <p className="text-xs text-slate-600 font-medium mb-1">图片加载失败</p>
    <p className="text-xs text-slate-500">{fallbackMessage}</p>
  </div>
</div>
```

## 测试建议

1. **正常加载测试**：
   - 生成新的数字人，确认图片正常显示
   - 选择历史数字人，确认图片正常显示

2. **错误处理测试**：
   - 修改图片 URL 为无效地址，确认显示错误提示
   - 断网情况下，确认显示加载失败提示

3. **布局测试**：
   - 不同屏幕尺寸下，确认图片容器高度一致
   - 多个历史数字人时，确认列表滚动正常

## 相关组件

- **ImageWithFallback.tsx** - 图片加载失败处理组件
- **CharacterCard.tsx** - 角色卡片（已使用 ImageWithFallback）
- **DigitalHumanHistory.tsx** - 数字人历史列表
- **DigitalHumanGenerator.tsx** - 数字人生成器

## 后续优化建议

1. **图片预加载**：在生成数字人后预加载图片，减少加载时间
2. **缓存策略**：优化图片缓存策略，减少失效情况
3. **重试机制**：图片加载失败时提供重试按钮
4. **缩略图**：历史列表使用缩略图，提升加载速度
5. **懒加载**：历史列表使用懒加载，优化性能
