# 角色管理路由分离设计方案

**日期**: 2026-02-01
**状态**: 设计阶段
**目标**: 将角色添加/编辑功能从列表页分离到独立路由页面

## 一、设计目标

将当前在 `ProjectDetail.tsx` 中通过 URL 参数控制的角色编辑功能，改为使用独立的路由页面，提升代码可维护性和用户体验。

### 当前问题
- `ProjectDetail.tsx` 职责过重，同时处理列表展示和详情编辑
- 使用 URL 参数 `?action=edit&characterId=xxx` 控制状态，不够直观
- 编辑状态和列表状态混在一起，代码复杂度高

### 改进目标
- 清晰的 URL 结构，每个页面职责单一
- 支持浏览器前进/后退导航
- 可以直接分享编辑页面链接
- 代码结构更清晰，易于维护

## 二、路由结构设计

### 新的路由结构
```
/projects/:id                                    # 项目详情（角色列表）
/projects/:id/characters/new                     # 新建角色
/projects/:id/characters/:characterId/edit       # 编辑角色
/projects/:id/characters/:characterId/edit#basic # 编辑角色 - 基本信息 tab
/projects/:id/characters/:characterId/edit#digital-human # 编辑角色 - 数字人 tab
```

### 页面组件结构
```
pages/
├── ProjectDetail.tsx              # 项目详情页（角色列表）- 简化
├── CharacterNew.tsx               # 新建角色页面 - 新增
└── CharacterEdit.tsx              # 编辑角色页面 - 新增

components/project/
├── CharacterCard.tsx              # 角色卡片（列表项）- 保持
├── CharacterForm.tsx              # 角色基本信息表单 - 保持
├── DigitalHumanGenerator.tsx      # 数字人生成器 - 保持
├── DigitalHumanHistory.tsx        # 数字人历史记录 - 保持
└── CharacterDetailEditor.tsx      # 角色详情编辑器 - 可能废弃
```

## 三、页面功能设计

### 3.1 ProjectDetail.tsx（角色列表页）

**简化后的职责**
- 加载项目信息和角色列表
- 显示角色卡片网格
- 提供"添加角色"按钮
- 处理角色删除操作

**移除的功能**
- 移除 `showDetailEditor` 状态
- 移除 `editingCharacter` 状态
- 移除 URL 参数处理逻辑（`searchParams`）
- 移除 `CharacterDetailEditor` 组件的渲染

**导航行为**
- "添加角色"按钮 → 跳转到 `/projects/:id/characters/new`
- 角色卡片"编辑"按钮 → 跳转到 `/projects/:id/characters/:characterId/edit`

### 3.2 CharacterNew.tsx（新建角色页面）

**功能**
- 显示角色基本信息表单（复用 `CharacterForm.tsx`）
- 提供"保存"和"保存并返回"两个按钮
- 提供"取消"按钮返回列表页

**保存行为**
- **"保存"按钮**:
  - 创建角色成功后，跳转到编辑页面的数字人 tab
  - 路径: `/projects/:id/characters/:characterId/edit#digital-human`
  - 目的: 方便用户继续生成数字人

- **"保存并返回"按钮**:
  - 创建角色成功后，返回项目详情页
  - 路径: `/projects/:id`
  - 目的: 完成创建流程，返回列表

**导航栏**
- 面包屑: 项目名称 > 角色管理 > 新建角色
- 返回按钮: 返回到 `/projects/:id`

### 3.3 CharacterEdit.tsx（编辑角色页面）

**功能**
- 使用 Tab 组件切换"基本信息"和"数字人"两个 tab
- Tab 状态通过 hash 反映在 URL 中（`#basic` 或 `#digital-human`）
- 默认显示基本信息 tab（如果没有 hash）

**Tab 1 - 基本信息**
- 显示角色基本信息表单（复用 `CharacterForm.tsx`）
- 提供"保存"和"保存并返回"按钮

**保存行为**
- **"保存"按钮**:
  - 更新角色信息
  - 停留在当前页面，显示成功提示
  - 目的: 方便用户继续编辑或切换到数字人 tab

- **"保存并返回"按钮**:
  - 更新角色信息
  - 返回项目详情页 `/projects/:id`
  - 目的: 完成编辑流程，返回列表

**Tab 2 - 数字人**
- 显示数字人生成器（复用 `DigitalHumanGenerator.tsx`）
- 显示数字人历史记录（复用 `DigitalHumanHistory.tsx`）
- 选择数字人后自动保存到角色的 `attributes.digitalHumanId`
- 不需要额外的保存按钮（选择即保存）

**导航栏**
- 面包屑: 项目名称 > 角色管理 > 编辑角色
- 返回按钮: 返回到 `/projects/:id`

## 四、导航流程

### 新建角色流程
```
列表页 (/projects/:id)
  ↓ 点击"添加角色"
新建页面 (/projects/:id/characters/new)
  ↓ 点击"保存"
编辑页面-数字人tab (/projects/:id/characters/:characterId/edit#digital-human)
  ↓ 选择数字人
  ↓ 点击返回
列表页 (/projects/:id)
```

### 编辑角色流程
```
列表页 (/projects/:id)
  ↓ 点击"编辑"
编辑页面-基本信息tab (/projects/:id/characters/:characterId/edit#basic)
  ↓ 修改信息
  ↓ 点击"保存"
停留在当前页面（显示成功提示）
  ↓ 切换到数字人tab
编辑页面-数字人tab (/projects/:id/characters/:characterId/edit#digital-human)
  ↓ 生成/选择数字人
  ↓ 点击返回
列表页 (/projects/:id)
```

## 五、技术实现要点

### 5.1 路由配置
```tsx
// 在 App.tsx 或路由配置文件中
<Route path="/projects/:id" element={<ProjectDetail />} />
<Route path="/projects/:id/characters/new" element={<CharacterNew />} />
<Route path="/projects/:id/characters/:characterId/edit" element={<CharacterEdit />} />
```

### 5.2 Tab 切换实现
```tsx
// CharacterEdit.tsx 中
const [activeTab, setActiveTab] = useState<'basic' | 'digital-human'>('basic');

useEffect(() => {
  // 从 hash 读取 tab 状态
  const hash = window.location.hash.slice(1);
  if (hash === 'digital-human') {
    setActiveTab('digital-human');
  } else {
    setActiveTab('basic');
  }
}, []);

const handleTabChange = (tab: 'basic' | 'digital-human') => {
  setActiveTab(tab);
  window.location.hash = tab;
};
```

### 5.3 保存按钮实现
```tsx
// 两个按钮的处理
const handleSave = async () => {
  await saveCharacter();
  // 停留在当前页面，显示成功提示
  toast.success('保存成功');
};

const handleSaveAndReturn = async () => {
  await saveCharacter();
  // 返回列表页
  navigate(`/projects/${projectId}`);
};
```

### 5.4 数据加载
- `CharacterNew.tsx`: 只需要加载项目信息
- `CharacterEdit.tsx`: 需要加载项目信息和角色详情
- 使用 `useParams` 获取路由参数
- 使用 `useNavigate` 进行页面跳转

## 六、UI/UX 设计要点

### 6.1 页面布局
- 顶部导航栏: 面包屑 + 返回按钮
- 主体内容区: 表单或 Tab 内容
- 底部操作栏: 保存按钮（固定在底部或跟随内容）

### 6.2 Tab 设计
- 使用 shadcn/ui 的 Tabs 组件
- 两个 tab: "基本信息" 和 "数字人"
- Tab 切换时更新 URL hash
- 视觉上清晰区分当前激活的 tab

### 6.3 按钮设计
- "保存": 主要按钮（primary）
- "保存并返回": 次要按钮（secondary）
- "取消": 文本按钮或次要按钮
- 按钮位置: 固定在页面底部或表单底部

### 6.4 响应式设计
- 移动端: Tab 可能需要改为下拉选择或滑动切换
- 按钮在移动端可能需要全宽显示

## 七、迁移计划

### 阶段 1: 创建新页面
1. 创建 `CharacterNew.tsx`
2. 创建 `CharacterEdit.tsx`
3. 添加路由配置

### 阶段 2: 实现新页面功能
1. 实现 `CharacterNew.tsx` 的表单和保存逻辑
2. 实现 `CharacterEdit.tsx` 的 Tab 切换和保存逻辑
3. 复用现有的 `CharacterForm`、`DigitalHumanGenerator` 等组件

### 阶段 3: 更新列表页
1. 简化 `ProjectDetail.tsx`
2. 移除编辑器相关状态和逻辑
3. 更新导航链接

### 阶段 4: 测试和清理
1. 测试所有导航流程
2. 测试保存和返回逻辑
3. 清理不再使用的代码（如 `CharacterDetailEditor.tsx`）

## 八、注意事项

1. **数据一致性**: 确保在不同页面间切换时，数据能正确加载和保存
2. **未保存提示**: 考虑在用户离开页面时，如果有未保存的更改，给予提示
3. **错误处理**: 处理角色不存在、加载失败等异常情况
4. **权限控制**: 确保用户有权限编辑该项目的角色
5. **浏览器兼容**: 测试 hash 路由在不同浏览器中的表现

## 九、后续优化

1. **面包屑导航**: 实现完整的面包屑导航组件
2. **快捷键**: 支持 Ctrl+S 保存等快捷键
3. **自动保存**: 考虑实现自动保存草稿功能
4. **历史记录**: 支持撤销/重做操作
