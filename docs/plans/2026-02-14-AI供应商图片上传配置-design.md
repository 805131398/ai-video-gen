# AI 供应商图片上传配置设计

> 日期: 2026-02-14
> 状态: 设计完成，待实施

## 背景

客户端做了资源本地化存储，在调用图生图/图生视频等 AI 接口时，部分供应商不支持 base64 格式，只接受网络图片 URL。需要在调用 AI 生成接口前，先将本地图片上传到对应供应商的图片托管服务，拿到 URL 后再调用生成接口。

## 核心决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 配置存储粒度 | 供应商级别独立表 | 一个供应商配一次，所有该供应商的模型复用 |
| 上传执行位置 | 客户端直传供应商 | 避免大文件经过服务端中转 |
| API Key 安全 | 按需获取，内存使用 | Key 只存服务端，客户端不落盘 |
| 上传记录缓存 | 客户端 SQLite | 就近存储，支持去重和缓存复用 |

## 数据模型

### 服务端：Prisma - AIProviderUploadConfig

```prisma
model AIProviderUploadConfig {
  id              String   @id @default(uuid())
  tenantId        String?  @map("tenant_id")
  providerName    String   @map("provider_name")     // "toapis", "runway", "kling" 等
  displayName     String   @map("display_name")      // 显示名称
  uploadUrl       String   @map("upload_url")        // 上传接口地址
  authType        String   @map("auth_type")         // "bearer", "api-key", "custom"
  apiKey          String   @map("api_key")           // 认证密钥
  responseUrlPath String   @map("response_url_path") // 响应中图片URL路径，如 "data.url"
  config          Json?                               // 额外配置（自定义 headers、字段名等）
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  @@map("ai_provider_upload_configs")
}
```

字段说明：
- `providerName`: 小写英文标识，与 AIModelConfig 的 providerName 对应
- `authType`: 认证方式。bearer → `Authorization: Bearer <key>`，api-key → `X-API-Key: <key>`，custom → 从 config 读取
- `responseUrlPath`: 点号分隔的 JSON 路径，如 `data.url` 解析 `response.data.url`
- `config`: 扩展字段 JSON，存放：
  - `fileFieldName`: 表单文件字段名（默认 "file"）
  - `extraHeaders`: 额外 HTTP headers
  - `extraFormFields`: 额外表单字段

### 客户端：SQLite - provider_upload_records

```sql
CREATE TABLE IF NOT EXISTS provider_upload_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  local_resource_hash TEXT NOT NULL,
  local_path TEXT,
  provider_name TEXT NOT NULL,
  remote_url TEXT NOT NULL,
  file_size INTEGER,
  mime_type TEXT,
  expires_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(local_resource_hash, provider_name)
)
```

- `local_resource_hash`: 文件内容 SHA-256 哈希，用于去重
- UNIQUE 约束确保同一文件对同一供应商只保留一条记录

## API 接口

### 管理接口（Admin CRUD）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/admin/upload-configs` | 列表查询 |
| POST | `/api/admin/upload-configs` | 新建配置 |
| GET | `/api/admin/upload-configs/[id]` | 单条详情 |
| PUT | `/api/admin/upload-configs/[id]` | 更新配置 |
| DELETE | `/api/admin/upload-configs/[id]` | 删除配置 |

### 凭证接口（客户端调用）

**GET /api/upload-configs/credential?providerName=toapis**

返回加密后的上传凭证：

```json
{
  "success": true,
  "data": {
    "providerName": "toapis",
    "uploadUrl": "https://toapis.com/v1/uploads/images",
    "authType": "bearer",
    "encryptedApiKey": "<AES-256-GCM 加密密文>",
    "iv": "<初始化向量>",
    "responseUrlPath": "data.url",
    "config": {
      "fileFieldName": "file"
    }
  }
}
```

加密方案：
- 算法: AES-256-GCM
- 密钥派生: PBKDF2(userSessionToken + 固定盐值)
- 客户端用同样方式派生密钥解密
- 解密后仅在内存中使用，不落盘

## 客户端上传流程

```
客户端需要上传图片给 AI 供应商
  ↓
计算本地文件 SHA-256 hash
  ↓
查询 provider_upload_records（hash + providerName）
  ↓ 命中 → HEAD 验证 remote_url 可用性（超时 3-5s）
  │         ↓ 200 → 直接返回 url
  │         ↓ 非200/超时 → 删除旧记录，继续走上传
  ↓ 未命中 ↓
GET /api/upload-configs/credential?providerName=xxx
  ↓
内存中用 PBKDF2 派生密钥，AES-256-GCM 解密 apiKey
  ↓
客户端直接 POST multipart/form-data 到供应商 uploadUrl
  ↓
用 responseUrlPath 解析响应 JSON 拿到图片 url
  ↓
存入 provider_upload_records（hash、localPath、providerName、remoteUrl）
  ↓
返回 url 给调用方使用
  ↓
内存中丢弃 apiKey
```

## 服务端适配器架构

```
web/src/lib/ai/upload/
├── types.ts                      # UploadResult, IUploadAdapter 类型定义
├── base-upload-adapter.ts        # 通用上传逻辑（适用大多数供应商）
├── adapters/
│   └── toapis-adapter.ts         # ToAPIs 特定实现
├── upload-adapter-factory.ts     # 根据 providerName 返回适配器
└── index.ts                      # 统一导出
```

核心接口：

```typescript
interface UploadResult {
  url: string
  providerName: string
  originalName?: string
  mimeType?: string
  size?: number
}

interface IUploadAdapter {
  upload(file: Buffer, filename: string, mimeType: string): Promise<UploadResult>
}
```

通用适配器 `BaseUploadAdapter` 根据 `AIProviderUploadConfig` 动态构建请求：
- 根据 `authType` 设置认证 header
- 根据 `config.fileFieldName` 设置 form 字段名
- 根据 `responseUrlPath` 解析响应

特殊供应商（如有非标准流程）继承 `BaseUploadAdapter` 覆写。

## Admin UI 设计

### 页面入口

在 `/admin/ai-config` 页面顶部加 Tab 切换：

```
[ 模型配置 ]    [ 图片上传配置 ]
```

Tab 样式复用现有模型类型 Tab 的 `border-b-2` 风格。

### 列表页

复用现有 Table 组件风格：

| 供应商 | 上传地址 | 认证方式 | API Key | 状态 | 操作 |
|--------|---------|---------|---------|------|------|
| ToAPIs | https://toapis.com/... | Bearer | sk-****abcd | 启用 | 编辑 删除 |

- API Key 显示/隐藏：复用 maskApiKey + Eye/EyeOff 按钮
- 状态：Badge 组件，启用/禁用
- 操作：Pencil（编辑）+ Trash2（删除）ghost icon buttons

### 编辑表单

使用 Card + CardHeader + CardContent 布局，与现有模型编辑页一致：

**基本信息 Card：**
- 供应商标识 (Input) + 显示名称 (Input) — 两列
- 上传地址 (Input) — 全宽
- 认证方式 (ChipSelector: Bearer / API-Key / 自定义) + API Key (Input password) — 两列
- 响应URL路径 (Input) + 启用开关 (Switch) — 两列

**高级配置 Card（可选）：**
- 文件字段名 (Input, 默认 "file")
- 额外 Headers (Input, JSON 格式)

所有 Label 使用 LabelWithTooltip 组件提供帮助信息。

### UI 组件复用清单

| 组件 | 来源 | 用途 |
|------|------|------|
| PageHeader | components/admin | 页面标题 + 操作按钮 |
| Table/TableHeader/... | components/ui/table | 列表数据展示 |
| Card/CardHeader/... | components/ui/card | 表单分组 |
| Input | components/ui/input | 文本输入 |
| Switch | components/ui/switch | 启用/禁用开关 |
| Badge | components/ui/badge | 状态标签 |
| Button | components/ui/button | 操作按钮 |
| LabelWithTooltip | ai-config/[id]/page.tsx | 带帮助提示的标签（需提取为公共组件） |
| ChipSelector | ai-config/[id]/page.tsx | 选项切换（需提取为公共组件） |
| toast (sonner) | — | 操作反馈 |

## 供应商接口示例

### ToAPIs

```typescript
// 上传
POST https://toapis.com/v1/uploads/images
Authorization: Bearer <api-key>
Content-Type: multipart/form-data

file: <图片文件>

// 响应
{
  "data": {
    "url": "https://cdn.toapis.com/xxx.png"
  }
}

// responseUrlPath: "data.url"
// authType: "bearer"
// fileFieldName: "file"
```

## 待定事项

- [ ] 上传触发时机（由调用方决定何时调用上传服务）
- [ ] 是否需要支持批量上传
- [ ] URL 过期策略（如果供应商有过期机制，需要在 config 中配置 TTL）
