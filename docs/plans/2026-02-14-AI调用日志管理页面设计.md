# AI 调用日志管理页面设计

## 日期
2026-02-14

## 目标
在后台管理面板新增 AI 调用日志查看功能，支持调试排障和用量审计两个场景。

## 设计方案

### 1. Schema 变更

`AIUsageLog` 新增字段：
- `taskId String? @map("task_id")` — 同一业务任务的多次 AI 调用共享同一个 taskId
- 添加 `@@index([taskId])` 索引

### 2. 新增 API

**`GET /api/admin/ai-logs`** — 日志列表
- 查询参数：`page`, `pageSize`, `startDate`, `endDate`, `modelType`, `status`, `userId`, `projectId`, `modelConfigId`, `keyword`(搜索 requestUrl/errorMessage), `taskId`
- 返回：`{ data: AIUsageLog[], total, page, pageSize }`
- 列表不返回 requestBody/responseBody 大字段
- 关联返回 user(name/email)、project(title)、modelConfig(providerName/modelName) 基本信息

**`GET /api/admin/ai-logs/[id]`** — 日志详情
- 返回单条完整日志，包含 requestBody、responseBody

**`GET /api/admin/ai-logs/filters`** — 筛选选项
- 返回用户列表、项目列表、模型配置列表（用于下拉选择器）

### 3. 新增页面：`/admin/ai-logs`

**筛选区域（一行）：**
- 时间范围（今天 / 7天 / 30天 / 自定义）
- 模型类型（TEXT / IMAGE / VIDEO / VOICE / 全部）
- 状态（成功 / 失败 / 全部）
- 用户下拉
- 项目下拉
- 模型配置下拉
- 关键词搜索（requestUrl / errorMessage）
- 任务ID搜索

**表格列：**
| 时间 | 模型类型 | 模型名称 | 用户 | 项目 | 请求URL | 任务ID | 延迟 | 费用 | 状态 | 操作 |

- 底部分页组件
- 失败行 errorMessage 做 tooltip

**详情抽屉（宽 ~60% 屏幕）：**
1. 基本信息卡片 — 两列网格：模型类型、模型名称、用户、项目、状态、延迟、费用、Tokens、时间、任务ID
2. 请求信息 — requestUrl + requestBody JSON 格式化
3. 响应信息 — responseBody JSON 格式化
4. 错误信息（仅失败时）— errorMessage 红色高亮
5. 任务ID 可点击，筛选同任务所有日志

### 4. 关联改动

- `ai-stats` 页面 "最近调用记录" 表格每行加 "详情" 链接，跳转到 `/admin/ai-logs?highlight={id}`
- `admin/layout.tsx` 菜单 "AI 视频" 分组下新增 "调用日志" → `/admin/ai-logs`
- `ai-usage-service.ts` 的 `LogAIUsageParams` 和 `withUsageLogging` 增加可选 `taskId` 参数

### 5. 技术选型
- 页面模式：纯客户端组件（参考 ai-stats）
- JSON 展示：`<pre>` + `JSON.stringify(data, null, 2)`
- 抽屉组件：shadcn/ui Sheet
- 遵循现有 admin 页面模式和组件库

## 涉及文件

| 操作 | 文件 |
|------|------|
| 修改 | `web/prisma/schema.prisma` — AIUsageLog 加 taskId |
| 新增 | `web/src/app/api/admin/ai-logs/route.ts` — 列表 API |
| 新增 | `web/src/app/api/admin/ai-logs/[id]/route.ts` — 详情 API |
| 新增 | `web/src/app/api/admin/ai-logs/filters/route.ts` — 筛选选项 API |
| 新增 | `web/src/app/admin/ai-logs/page.tsx` — 日志列表页面 |
| 修改 | `web/src/app/admin/ai-stats/page.tsx` — 加详情跳转链接 |
| 修改 | `web/src/app/admin/layout.tsx` — 菜单加调用日志 |
| 修改 | `web/src/lib/services/ai-usage-service.ts` — 加 taskId 支持 |
