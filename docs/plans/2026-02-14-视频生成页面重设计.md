# 视频生成页面重设计

## 背景

当前视频生成对话框存在以下问题：

1. 展示开发者视角的技术选项（smart_combine、故事板格式），用户看不懂
2. 场景编辑中填写的内容（描述、镜头、动作等）如何应用到视频生成对用户不透明
3. 点击即生成，没有机会审查/调整 AI 提示词
4. 角色和数字人信息完全不可见
5. 生成过程数据没有记录，无法追溯排查

## 设计方案

### 一、全页面生成视图

**路由**：`/projects/:id/script/:scriptId/scenes/:sceneId/generate`

从视频列表页的"生成新视频"按钮跳转到此页面（替代原来的弹窗）。

#### 页面布局（左右分栏）

```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回  /  剧本名  /  场景视频  /  生成视频               │
├──────────────────────────┬──────────────────────────────────┤
│  场景信息（左侧 ~40%）   │  提示词 & 生成（右侧 ~60%）      │
│                          │                                  │
│  ┌──────────────────┐    │  ┌────────────────────────────┐  │
│  │ 角色与表演        │    │  │ 视频提示词（自动生成）      │  │
│  │ 主角区块          │    │  │  textarea（可编辑）         │  │
│  │ 其他角色区块      │    │  │  [重新生成提示词]           │  │
│  └──────────────────┘    │  └────────────────────────────┘  │
│                          │                                  │
│  ┌──────────────────┐    │  ┌────────────────────────────┐  │
│  │ 场景描述          │    │  │ 生成选项                   │  │
│  │ 标题 / 时长       │    │  │  宽高比: [16:9 ▼]         │  │
│  │ description       │    │  │  时长: 10s (自动适配)      │  │
│  └──────────────────┘    │  └────────────────────────────┘  │
│                          │                                  │
│  ┌──────────────────┐    │  ▸ 高级设置（默认折叠）          │
│  │ 镜头 & 视觉       │    │    提示词类型 / 故事板格式 /    │
│  │ tag 标签展示      │    │    角色形象开关                 │
│  └──────────────────┘    │                                  │
│                          │  ┌────────────────────────────┐  │
│  [编辑场景 →]            │  │     [开始生成视频]          │  │
│                          │  └────────────────────────────┘  │
└──────────────────────────┴──────────────────────────────────┘
```

#### 左侧面板 — 场景信息（只读）

**卡片 1：角色与表演**

以角色为中心组织信息，将角色、动作、台词关联展示：

```
┌─ 主要角色 ─────────────────────────────┐
│ [数字人图] 角色名                       │
│  来源: 数字人形象                       │
│                                         │
│  入场: 从左侧走入诊室                  │
│  动作: 坐下翻看病历，抬头微笑          │
│  出场: 起身送患者到门口                │
│                                         │
│  "您最近恢复得怎么样？"                │
│  "看起来好多了，继续保持。"            │
└─────────────────────────────────────────┘

┌─ 其他角色 ─────────────────────────────┐
│ [头像] 患者（接受治疗）                 │
│  "谢谢医生，我感觉好很多。"            │
└─────────────────────────────────────────┘
```

- 主角区块：数字人/头像 + 名称 + 来源标签 + 三段动作 + 台词
- 其他角色：小头像 + 名称 + 角色描述 + 台词
- 台词按 `dialogues[].speaker` 自动匹配到对应角色
- 未关联角色时显示灰色"未关联角色"提示
- 动作当前属于场景级别（仅主角），数据结构预留未来多角色动作扩展

**卡片 2：场景描述**

- 标题 + 时长
- description 全文展示

**卡片 3：镜头 & 视觉**

- 用 tag 标签展示：`近景` `固定` `推镜头` `室内光` `暖色调`
- 自定义描述（如有）单独一行

**底部**：`编辑场景 →` 链接跳转到场景编辑页

#### 右侧面板 — 提示词与生成

**提示词区域**：
- 页面加载时自动调用 `preview-prompt` 接口生成提示词
- 加载中显示骨架屏
- 生成后填入可编辑的 textarea（约 8-10 行高度）
- textarea 下方 `[重新生成]` 按钮（重新调用接口，覆盖用户编辑）

**生成选项区域**：
- 宽高比：下拉（16:9 / 9:16 / 1:1 / 4:3 / 3:4）
- 时长：只读（继承场景 → 自动适配 10s/15s）

**高级设置（默认折叠）**：
- 提示词类型：智能组合 / AI 优化
- 故事板格式：开关
- 角色形象作为参考图：开关（开启时宽高比锁定）

**底部按钮**：
- `[开始生成视频]` — 调用 generate-video（带 customPrompt）
- 生成成功后自动跳转回视频列表页

---

### 二、API 变更

#### 新增：提示词预览接口

```
POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/preview-prompt

请求：
{
  promptType?: "smart_combine" | "ai_optimized",
  useStoryboard?: boolean,
  useCharacterImage?: boolean
}

响应：
{
  success: true,
  prompt: "生成的完整提示词文本...",
  characterInfo: {
    characterId?: string,
    characterName?: string,
    digitalHumanId?: string,
    referenceImage?: string,
    imageSource?: "digital_human" | "avatar"
  }
}
```

#### 修改：视频生成接口

```
POST .../generate-video

新增请求字段：
{
  customPrompt?: string   // 用户编辑后的提示词
  // 如果传了 customPrompt，直接使用，不再服务端重新生成
  // 其他字段保持不变
}
```

---

### 三、数据追踪

#### 3.1 服务端：AI 服务调用日志增强

现有 `AIUsageLog` 模型增加字段：

```prisma
model AIUsageLog {
  // ... 现有字段 ...
  requestUrl    String?  @map("request_url")         // AI 服务请求 URL
  requestBody   Json?    @map("request_body")         // 请求参数
  responseBody  Json?    @map("response_body")        // 响应内容
}
```

在视频生成、提示词生成等 AI 调用处记录完整的请求/响应。

#### 3.2 服务端：通用 API 请求日志

新增 `ApiRequestLog` 模型：

```prisma
model ApiRequestLog {
  id           String   @id @default(uuid())
  tenantId     String?  @map("tenant_id")
  userId       String?  @map("user_id")
  method       String                           // GET/POST/PUT/DELETE
  url          String                           // 请求路径
  requestBody  Json?    @map("request_body")    // 请求参数
  responseCode Int      @map("response_code")   // HTTP 状态码
  responseBody Json?    @map("response_body")   // 响应内容
  latencyMs    Int?     @map("latency_ms")      // 耗时
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([url])
  @@index([createdAt])
  @@map("api_request_logs")
}
```

通过 Next.js middleware 或包装函数统一记录。

#### 3.3 客户端：生成操作快照

本地 SQLite 新增 `generation_snapshots` 表：

```sql
CREATE TABLE generation_snapshots (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  script_id TEXT NOT NULL,
  scene_id TEXT NOT NULL,
  video_id TEXT,                    -- 生成成功后回填
  -- 快照数据
  original_prompt TEXT,             -- 服务端自动生成的原始提示词
  final_prompt TEXT,                -- 用户确认/编辑后的最终提示词
  prompt_type TEXT,                 -- smart_combine / ai_optimized
  use_storyboard INTEGER,
  use_character_image INTEGER,
  aspect_ratio TEXT,
  -- 关联的角色/数字人信息
  character_id TEXT,
  character_name TEXT,
  digital_human_id TEXT,
  reference_image TEXT,
  -- 场景快照（防止场景后续修改导致追溯困难）
  scene_content TEXT,               -- JSON: 生成时的完整 SceneContent
  -- 时间
  created_at TEXT DEFAULT (datetime('now'))
);
```

记录时机：用户点击"开始生成视频"时，在调用 API 前保存快照到本地。

---

### 四、页面数据流

```
进入生成页面
  ├→ getScene() → 左侧场景信息展示
  ├→ getProjectCharacters() → 左侧角色卡片（含数字人信息）
  └→ POST preview-prompt → 右侧 textarea 自动填充提示词

用户审查/编辑提示词，调整生成选项

点击"开始生成视频"
  ├→ 保存 generation_snapshot 到本地 SQLite
  └→ POST generate-video（带 customPrompt）
     → 跳转回视频列表页，开始轮询
```

---

### 五、路由变更

```tsx
// App.tsx 新增路由
<Route
  path="projects/:id/script/:scriptId/scenes/:sceneId/generate"
  element={<SceneVideoGenerate />}
/>
```

SceneVideos 页面的"生成新视频"按钮改为 `navigate` 跳转到生成页面（不再打开对话框）。

---

### 六、涉及文件

**新增**：
- `client/src/pages/SceneVideoGenerate.tsx` — 全页面生成视图
- `web/src/app/api/.../scenes/[sceneId]/preview-prompt/route.ts` — 提示词预览接口

**修改**：
- `client/src/pages/SceneVideos.tsx` — "生成新视频"按钮改为页面跳转
- `client/src/App.tsx` — 新增路由
- `web/src/app/api/.../generate-video/route.ts` — 支持 customPrompt
- `web/prisma/schema.prisma` — AIUsageLog 增字段 + 新增 ApiRequestLog
- `client/electron/database.ts` — 新增 generation_snapshots 表和操作方法
- `client/src/services/localDataService.ts` — 新增快照保存方法
- `client/src/types/index.ts` — 新增相关类型

**可删除**：
- `client/src/components/scene-videos/VideoGenerateDialog.tsx` — 被全页面替代
