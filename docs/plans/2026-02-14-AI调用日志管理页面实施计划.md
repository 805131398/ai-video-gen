# AI 调用日志管理页面 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 在后台管理面板新增 AI 调用日志查看页面，支持筛选/分页/详情抽屉/按任务关联查询。

**Architecture:** 新增 3 个 API 路由（列表、详情、筛选选项），1 个前端页面（客户端组件），修改 Prisma schema 增加 taskId 字段，修改 admin layout 增加菜单项，修改 ai-stats 增加跳转链接。

**Tech Stack:** Next.js App Router, Prisma 7, shadcn/ui (Sheet, Table, Select, Badge, Input, Button), Tailwind CSS v4, lucide-react icons

---

### Task 1: Schema — AIUsageLog 增加 taskId 字段

**Files:**
- Modify: `web/prisma/schema.prisma:681-705`

**Step 1: 修改 schema**

在 `AIUsageLog` 的 `responseBody` 字段后、`createdAt` 字段前，新增：

```prisma
  taskId       String?     @map("task_id")
```

在 `@@map("ai_usage_logs")` 前新增索引：

```prisma
  @@index([taskId])
```

完整 model 变为：
```prisma
model AIUsageLog {
  id            String      @id @default(uuid())
  tenantId      String?     @map("tenant_id")
  userId        String      @map("user_id")
  projectId     String?     @map("project_id")
  modelType     AIModelType @map("model_type")
  modelConfigId String      @map("model_config_id")
  inputTokens   Int?        @map("input_tokens")
  outputTokens  Int?        @map("output_tokens")
  cost          Decimal?    @db.Decimal(10, 6)
  latencyMs     Int?        @map("latency_ms")
  status        AILogStatus
  errorMessage  String?     @map("error_message") @db.Text
  requestUrl    String?     @map("request_url")
  requestBody   Json?       @map("request_body")
  responseBody  Json?       @map("response_body")
  taskId        String?     @map("task_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  tenant      Tenant?       @relation(fields: [tenantId], references: [id])
  user        User          @relation(fields: [userId], references: [id])
  project     Project?      @relation(fields: [projectId], references: [id])
  modelConfig AIModelConfig @relation(fields: [modelConfigId], references: [id])

  @@index([taskId])
  @@map("ai_usage_logs")
}
```

**Step 2: 生成 Prisma client & 推送到数据库**

```bash
cd web && pnpm db:generate && pnpm db:push
```

Expected: 无报错，schema 同步成功。

**Step 3: Commit**

```bash
git add web/prisma/schema.prisma
git commit -m "feat(schema): add taskId field to AIUsageLog for task-level tracing"
```

---

### Task 2: Service — ai-usage-service 增加 taskId 支持

**Files:**
- Modify: `web/src/lib/services/ai-usage-service.ts`

**Step 1: 修改 LogAIUsageParams 接口**

在 `errorMessage` 后新增：
```typescript
  taskId?: string;
```

**Step 2: 修改 logAIUsage 函数**

在 `prisma.aIUsageLog.create` 的 `data` 中新增：
```typescript
  taskId: params.taskId,
```

**Step 3: 修改 withUsageLogging 函数签名**

将 `Omit<LogAIUsageParams, "latencyMs" | "status" | "errorMessage">` 保持不变（taskId 已在 LogAIUsageParams 中，会自动传递）。

**Step 4: Commit**

```bash
git add web/src/lib/services/ai-usage-service.ts
git commit -m "feat(service): add taskId support to AI usage logging"
```

---

### Task 3: API — 筛选选项接口

**Files:**
- Create: `web/src/app/api/admin/ai-logs/filters/route.ts`

**Step 1: 创建筛选选项 API**

```typescript
import { NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

// GET /api/admin/ai-logs/filters - 获取筛选选项
export async function GET() {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: "未授权" }, { status: 401 });
    }

    const tenantId = session.user.tenantId;

    const [users, projects, modelConfigs] = await Promise.all([
      prisma.user.findMany({
        where: { tenantId },
        select: { id: true, name: true, email: true },
        orderBy: { name: "asc" },
      }),
      prisma.project.findMany({
        where: { tenantId },
        select: { id: true, title: true },
        orderBy: { updatedAt: "desc" },
        take: 100,
      }),
      prisma.aIModelConfig.findMany({
        where: { tenantId },
        select: { id: true, providerName: true, modelName: true, modelType: true },
        orderBy: { providerName: "asc" },
      }),
    ]);

    return NextResponse.json({
      data: { users, projects, modelConfigs },
    });
  } catch (error) {
    console.error("获取筛选选项失败:", error);
    return NextResponse.json({ error: "获取失败" }, { status: 500 });
  }
}
```

**Step 2: Commit**

```bash
git add web/src/app/api/admin/ai-logs/filters/route.ts
git commit -m "feat(api): add ai-logs filters endpoint"
```

---

### Task 4: API — 日志列表接口

**Files:**
- Create: `web/src/app/api/admin/ai-logs/route.ts`

**Step 1: 创建列表 API**

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

// GET /api/admin/ai-logs - 获取 AI 调用日志列表
export async function GET(request: NextRequest) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: "未授权" }, { status: 401 });
    }

    const tenantId = session.user.tenantId;
    const searchParams = request.nextUrl.searchParams;

    const page = parseInt(searchParams.get("page") || "1");
    const pageSize = parseInt(searchParams.get("pageSize") || "20");
    const startDate = searchParams.get("startDate");
    const endDate = searchParams.get("endDate");
    const modelType = searchParams.get("modelType");
    const status = searchParams.get("status");
    const userId = searchParams.get("userId");
    const projectId = searchParams.get("projectId");
    const modelConfigId = searchParams.get("modelConfigId");
    const keyword = searchParams.get("keyword");
    const taskId = searchParams.get("taskId");

    // Build where clause
    const where: any = { tenantId };

    if (startDate) {
      where.createdAt = { ...where.createdAt, gte: new Date(startDate) };
    }
    if (endDate) {
      where.createdAt = { ...where.createdAt, lte: new Date(endDate) };
    }
    if (modelType) {
      where.modelType = modelType;
    }
    if (status) {
      where.status = status;
    }
    if (userId) {
      where.userId = userId;
    }
    if (projectId) {
      where.projectId = projectId;
    }
    if (modelConfigId) {
      where.modelConfigId = modelConfigId;
    }
    if (taskId) {
      where.taskId = { contains: taskId, mode: "insensitive" };
    }
    if (keyword) {
      where.OR = [
        { requestUrl: { contains: keyword, mode: "insensitive" } },
        { errorMessage: { contains: keyword, mode: "insensitive" } },
      ];
    }

    const [logs, total] = await Promise.all([
      prisma.aIUsageLog.findMany({
        where,
        orderBy: { createdAt: "desc" },
        skip: (page - 1) * pageSize,
        take: pageSize,
        select: {
          id: true,
          modelType: true,
          inputTokens: true,
          outputTokens: true,
          cost: true,
          latencyMs: true,
          status: true,
          errorMessage: true,
          requestUrl: true,
          taskId: true,
          createdAt: true,
          user: { select: { name: true, email: true } },
          project: { select: { id: true, title: true } },
          modelConfig: { select: { providerName: true, modelName: true } },
        },
      }),
      prisma.aIUsageLog.count({ where }),
    ]);

    return NextResponse.json({
      data: logs.map((log) => ({
        ...log,
        cost: Number(log.cost),
      })),
      total,
      page,
      pageSize,
    });
  } catch (error) {
    console.error("获取日志列表失败:", error);
    return NextResponse.json({ error: "获取失败" }, { status: 500 });
  }
}
```

**Step 2: Commit**

```bash
git add web/src/app/api/admin/ai-logs/route.ts
git commit -m "feat(api): add ai-logs list endpoint with filtering and pagination"
```

---

### Task 5: API — 日志详情接口

**Files:**
- Create: `web/src/app/api/admin/ai-logs/[id]/route.ts`

**Step 1: 创建详情 API**

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

// GET /api/admin/ai-logs/[id] - 获取单条日志详情
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: "未授权" }, { status: 401 });
    }

    const { id } = await params;

    const log = await prisma.aIUsageLog.findUnique({
      where: { id },
      include: {
        user: { select: { name: true, email: true } },
        project: { select: { id: true, title: true } },
        modelConfig: { select: { providerName: true, modelName: true, modelType: true } },
      },
    });

    if (!log) {
      return NextResponse.json({ error: "日志不存在" }, { status: 404 });
    }

    return NextResponse.json({
      data: {
        ...log,
        cost: Number(log.cost),
      },
    });
  } catch (error) {
    console.error("获取日志详情失败:", error);
    return NextResponse.json({ error: "获取失败" }, { status: 500 });
  }
}
```

**Step 2: Commit**

```bash
git add "web/src/app/api/admin/ai-logs/[id]/route.ts"
git commit -m "feat(api): add ai-logs detail endpoint"
```

---

### Task 6: 前端 — AI 日志列表页面（使用 ui-ux-pro-max 设计）

**Files:**
- Create: `web/src/app/admin/ai-logs/page.tsx`

**说明：** 此任务使用 `/ui-ux-pro-max` 技能辅助设计。页面为纯客户端组件（"use client"），参考现有 `ai-stats/page.tsx` 模式。

**页面结构：**

1. **PageHeader** — 标题 "AI 调用日志"，描述 "查看所有 AI 模型调用记录，支持按任务追溯调用链"
2. **筛选区** — 两行：
   - 第一行：时间范围 Select、模型类型 Select、状态 Select
   - 第二行：用户 Select、项目 Select、模型配置 Select、关键词 Input、任务ID Input
3. **表格** — 列：时间 | 模型类型 | 模型名称 | 用户 | 项目 | 请求URL | 任务ID | 延迟 | 费用 | 状态 | 操作
4. **分页** — 使用现有 `Pagination` 组件
5. **详情抽屉** — 使用 shadcn/ui `Sheet`，宽度覆盖约 60%（自定义 className 覆盖 `sm:max-w-sm`）

**核心状态：**
```typescript
const [logs, setLogs] = useState<LogItem[]>([]);
const [total, setTotal] = useState(0);
const [page, setPage] = useState(1);
const [pageSize, setPageSize] = useState(20);
const [isLoading, setIsLoading] = useState(true);
const [selectedLog, setSelectedLog] = useState<LogDetail | null>(null);
const [isDetailOpen, setIsDetailOpen] = useState(false);
const [isDetailLoading, setIsDetailLoading] = useState(false);

// 筛选状态
const [timeRange, setTimeRange] = useState("week");
const [modelType, setModelType] = useState("all");
const [statusFilter, setStatusFilter] = useState("all");
const [userId, setUserId] = useState("all");
const [projectId, setProjectId] = useState("all");
const [modelConfigId, setModelConfigId] = useState("all");
const [keyword, setKeyword] = useState("");
const [taskIdSearch, setTaskIdSearch] = useState("");

// 筛选选项数据
const [filterOptions, setFilterOptions] = useState<FilterOptions | null>(null);
```

**数据流：**
- 页面加载时并行请求 `/api/admin/ai-logs` 和 `/api/admin/ai-logs/filters`
- 筛选变化时重新请求列表（debounce keyword 和 taskId 搜索 300ms）
- 点击"查看详情"时请求 `/api/admin/ai-logs/[id]`，打开 Sheet
- 点击任务ID时设置 taskIdSearch 筛选同任务日志

**详情抽屉内容：**
- SheetHeader：日志ID + 状态 Badge
- 基本信息：两列 grid，展示所有元数据
- 请求信息：requestUrl + requestBody（`<pre>` + `JSON.stringify(data, null, 2)`）
- 响应信息：responseBody（同上格式化）
- 错误信息（条件渲染）：红色背景卡片
- 任务关联：taskId 可点击，关闭抽屉 + 设置 taskIdSearch

**Step 1: 实现完整页面**

页面代码较长，直接实现完整功能。关键点：
- 使用 `import { Pagination } from "@/components/admin"` 复用分页
- 使用 `import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from "@/components/ui/sheet"`
- Sheet 自定义宽度：`<SheetContent className="!max-w-3xl !w-[60vw]">`
- JSON 展示区域用 `<pre className="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg overflow-auto max-h-96 text-xs">`

**Step 2: Commit**

```bash
git add web/src/app/admin/ai-logs/page.tsx
git commit -m "feat(admin): add AI call logs page with filters, pagination and detail drawer"
```

---

### Task 7: 修改 admin layout — 增加菜单项

**Files:**
- Modify: `web/src/app/admin/layout.tsx:19-44` (ai-video children 数组)

**Step 1: 在 ai-video children 中 ai-stats 后面新增**

```typescript
      {
        id: "ai-logs",
        label: "调用日志",
        icon: "ScrollText",
        href: "/admin/ai-logs",
      },
```

**Step 2: Commit**

```bash
git add web/src/app/admin/layout.tsx
git commit -m "feat(admin): add AI call logs menu item"
```

---

### Task 8: 修改 ai-stats — 增加跳转链接

**Files:**
- Modify: `web/src/app/admin/ai-stats/page.tsx`

**Step 1: 添加 Link import**

```typescript
import Link from "next/link";
import { ExternalLink } from "lucide-react";
```

**Step 2: 在"最近调用记录" CardHeader 中添加"查看全部"链接**

在 `<CardTitle className="text-base">最近调用记录</CardTitle>` 旁边添加：

```typescript
<CardHeader className="flex flex-row items-center justify-between">
  <CardTitle className="text-base">最近调用记录</CardTitle>
  <Link
    href="/admin/ai-logs"
    className="text-sm text-blue-500 hover:text-blue-700 flex items-center gap-1"
  >
    查看全部 <ExternalLink className="h-3 w-3" />
  </Link>
</CardHeader>
```

**Step 3: 在表格每行添加"详情"操作列**

TableHeader 最后增加：
```typescript
<TableHead className="w-[60px]"></TableHead>
```

TableBody 每行最后增加：
```typescript
<TableCell>
  <Link
    href={`/admin/ai-logs?highlight=${log.id}`}
    className="text-blue-500 hover:text-blue-700 text-xs"
  >
    详情
  </Link>
</TableCell>
```

**Step 4: Commit**

```bash
git add web/src/app/admin/ai-stats/page.tsx
git commit -m "feat(admin): add detail links from ai-stats to ai-logs page"
```

---

### Task 9: 验证与最终提交

**Step 1: 运行 lint 检查**

```bash
cd web && pnpm lint
```

Expected: 无错误。

**Step 2: 验证构建**

```bash
cd web && pnpm build
```

Expected: 构建成功。

**Step 3: 手动验证**

用户启动 `pnpm dev`，验证：
- [ ] `/admin/ai-logs` 页面可访问
- [ ] 筛选功能正常
- [ ] 分页正常
- [ ] 详情抽屉打开/关闭正常
- [ ] 任务ID 点击筛选正常
- [ ] `/admin/ai-stats` 页面"详情"链接跳转正常
- [ ] 侧边栏菜单显示"调用日志"

---

## 文件清单

| 序号 | 操作 | 文件 |
|------|------|------|
| 1 | 修改 | `web/prisma/schema.prisma` |
| 2 | 修改 | `web/src/lib/services/ai-usage-service.ts` |
| 3 | 新增 | `web/src/app/api/admin/ai-logs/filters/route.ts` |
| 4 | 新增 | `web/src/app/api/admin/ai-logs/route.ts` |
| 5 | 新增 | `web/src/app/api/admin/ai-logs/[id]/route.ts` |
| 6 | 新增 | `web/src/app/admin/ai-logs/page.tsx` |
| 7 | 修改 | `web/src/app/admin/layout.tsx` |
| 8 | 修改 | `web/src/app/admin/ai-stats/page.tsx` |
