# AiChat 视频生成直接调用设计

## 背景

AiToolManagement 中配置的 VideoGenConfig（endpoints/params/responseMapping）在 AiChat 中未被使用。
当前 AiChat 无论选什么类型模型，都走 `/chat/completions` 聊天接口。

## 设计决策

| 决策项 | 选择 |
|--------|------|
| 调用方式 | 直接调用视频生成 API（非 chat completion） |
| 输入交互 | 卡片式快捷操作，参数面板 + prompt 输入 |
| 进度展示 | 消息气泡 + 悬浮进度条 |
| 并发策略 | 单对话一个生成任务，多对话可并行 |
| 图生视频 | 支持，输入区上传图片按钮 |
| 结果展示 | 内嵌小播放器 + 点击全屏预览 |

## 架构变更

### 前端（AiChat.tsx）

- 检测 `selectedConfig.toolType === 'video_gen'` 切换视频模式
- 输入区上方渲染参数卡片（从 `extraConfig.endpoints.generate.params` 读取）
- 发送走新的 `video:generate` IPC 通道
- 新增悬浮进度条组件

### Electron 主进程（main.ts）

新增三个 IPC handler：

1. **`video:upload`** — 上传图片，返回 imageUrl
2. **`video:generate`** — 提交生成任务，返回 taskId
3. **`video:pollStatus`** — 轮询任务状态，返回 status/videoUrl/thumbnailUrl

### 数据流

```
用户输入 prompt + 调整参数 + (可选)上传图片
  → upload 接口拿到 imageUrl
  → generate 接口提交任务（prompt + params + imageUrl）
  → responseMapping 解析出 taskId
  → 轮询 status 接口（{taskId} 替换）
  → responseMapping 解析出 status / videoUrl / thumbnailUrl
  → 更新消息气泡为视频播放器
```

## UI 布局

### 参数面板（输入区上方）

- `select` → 下拉选择器
- `boolean` → 复选框
- `number` → 数字输入框
- `string` → 文本输入框
- `file` → 不显示（由上传按钮处理）
- 有 `remark` 的参数 hover 显示 tooltip

### 悬浮进度条（聊天区顶部，生成中显示）

显示：状态文字 + 进度条 + 取消按钮

### 消息气泡（完成后）

内嵌小尺寸视频播放器，点击全屏预览，下方显示 prompt 摘要和保存按钮。

## responseMapping 解析

```typescript
function getByPath(obj: any, path: string): any {
  return path.split('.').reduce((o, k) => o?.[k], obj);
}
```
