# 存储配置指南

## 概述

系统支持多种云存储服务，包括：
- 阿里云 OSS
- AWS S3
- 腾讯云 COS
- 本地存储（默认）

## 配置方式

### 方式一：管理后台配置（推荐）

通过管理后台界面动态配置存储服务，无需重启应用。

#### 访问路径

登录管理后台后，访问：`/admin/storage-providers`

#### 配置步骤

1. **进入存储配置页面**
   - 点击"新增存储配置"按钮

2. **填写基本信息**
   - 选择提供商类型（阿里云 OSS / AWS S3 / 腾讯云 COS）
   - 输入配置名称（便于识别，如"生产环境-阿里云OSS"）
   - 设置是否为默认存储
   - 设置是否启用

3. **填写存储配置**
   - 根据选择的提供商类型，填写相应的配置信息
   - 所有敏感信息（密钥）会以密码形式输入

4. **保存配置**
   - 点击"保存"按钮完成配置
   - 配置立即生效，无需重启应用

#### 功能特性

- **多配置管理**：支持配置多个存储服务
- **默认存储**：可设置一个配置为默认存储
- **启用/禁用**：可随时启用或禁用某个配置
- **编辑配置**：可修改已有配置的信息
- **删除配置**：可删除不再使用的配置（默认配置除外）

### 方式二：环境变量配置

在 `web/.env.local` 文件中配置存储相关的环境变量。

#### 1. 阿里云 OSS 配置

```bash
# 存储提供商类型
STORAGE_PROVIDER="ali-oss"

# 阿里云 OSS 配置
ALI_OSS_REGION="oss-cn-hangzhou"
ALI_OSS_ACCESS_KEY_ID="your-access-key-id"
ALI_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
ALI_OSS_BUCKET="your-bucket-name"
ALI_OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"  # 可选
```

#### 2. AWS S3 配置

```bash
# 存储提供商类型
STORAGE_PROVIDER="aws-s3"

# AWS S3 配置
AWS_S3_REGION="us-east-1"
AWS_S3_ACCESS_KEY_ID="your-access-key-id"
AWS_S3_SECRET_ACCESS_KEY="your-secret-access-key"
AWS_S3_BUCKET="your-bucket-name"
AWS_S3_ENDPOINT="https://s3.amazonaws.com"  # 可选，用于兼容 S3 的服务
```

#### 3. 腾讯云 COS 配置

```bash
# 存储提供商类型
STORAGE_PROVIDER="tencent-cos"

# 腾讯云 COS 配置
TENCENT_COS_REGION="ap-guangzhou"
TENCENT_COS_SECRET_ID="your-secret-id"
TENCENT_COS_SECRET_KEY="your-secret-key"
TENCENT_COS_BUCKET="your-bucket-name-appid"
```

#### 4. 本地存储配置（默认）

```bash
# 存储提供商类型
STORAGE_PROVIDER="local"

# 本地存储路径
STORAGE_PATH="./storage"
```

### 方式二：数据库配置（未来支持）

系统设计了 `StorageProvider` 数据表来支持动态配置存储服务，但目前此功能尚未在管理后台实现。

数据库表结构：
- `providerCode`: 提供商代码（ali-oss, aws-s3, tencent-cos）
- `providerName`: 提供商名称
- `config`: JSON 格式的配置信息
- `isDefault`: 是否为默认存储
- `isActive`: 是否启用

## 配置步骤

### 1. 创建或编辑配置文件

在 `web` 目录下创建或编辑 `.env.local` 文件：

```bash
cd web
cp .env.local.example .env.local
```

### 2. 填写存储配置

根据你选择的云存储服务，在 `.env.local` 中添加相应的配置项。

### 3. 获取云服务凭证

#### 阿里云 OSS
1. 登录阿里云控制台
2. 进入 OSS 管理控制台
3. 创建 Bucket 或使用现有 Bucket
4. 在访问控制 (RAM) 中创建 AccessKey

#### AWS S3
1. 登录 AWS 控制台
2. 进入 S3 服务
3. 创建 Bucket 或使用现有 Bucket
4. 在 IAM 中创建用户并获取访问密钥

#### 腾讯云 COS
1. 登录腾讯云控制台
2. 进入对象存储 COS 控制台
3. 创建存储桶或使用现有存储桶
4. 在访问管理中创建 API 密钥

### 4. 重启应用

配置完成后，重启开发服务器：

```bash
pnpm dev
```

## 配置优先级

系统会按以下优先级加载存储配置：

1. **数据库配置**（最高优先级）
   - 从 `StorageProvider` 表中加载默认配置
   - 支持多租户隔离
   - 可通过管理后台动态修改

2. **环境变量配置**（备用方案）
   - 当数据库中没有配置时使用
   - 适合开发环境和初始化场景

## 使用建议

- **开发环境**：使用环境变量配置，简单快捷
- **生产环境**：使用管理后台配置，便于管理和切换
- **多租户场景**：必须使用数据库配置，支持租户隔离



系统会自动按以下规则组织文件路径：

```
/{tenantId}/{businessType}/{YYYY-MM}/{uuid}.{ext}
```

- `tenantId`: 租户 ID
- `businessType`: 业务类型（如：avatar, video, image 等）
- `YYYY-MM`: 年月
- `uuid`: 唯一标识符
- `ext`: 文件扩展名

示例：
```
tenant-123/avatar/2026-01/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
```

## 注意事项

1. **安全性**：不要将 `.env.local` 文件提交到版本控制系统
2. **权限配置**：确保云服务账号有足够的权限（读、写、删除）
3. **跨域配置**：如果前端直接上传，需要在云服务中配置 CORS
4. **费用控制**：注意云存储的流量和存储费用

## 相关文件

- 配置工厂：`web/src/lib/storage/storage-factory.ts`
- 存储适配器：`web/src/lib/storage/adapters/`
- 上传 API：`web/src/app/api/storage/upload-url/route.ts`
- 数据模型：`web/prisma/schema.prisma` (StorageProvider 表)
- 管理后台：`web/src/app/admin/storage-providers/`
- Server Actions：`web/src/app/admin/storage-providers/actions.ts`

## API 使用示例

### 从数据库加载配置

```typescript
import { StorageFactory } from '@/lib/storage/storage-factory';

// 加载默认存储配置
await StorageFactory.initializeFromDatabase(tenantId);

// 或者使用自动降级（优先数据库，失败则使用环境变量）
await StorageFactory.initializeFromDatabaseOrEnv(tenantId);

// 获取适配器实例
const adapter = StorageFactory.getAdapter();
```

### 管理后台操作

```typescript
import {
  createStorageProvider,
  updateStorageProvider,
  setDefaultProvider,
  toggleProviderStatus,
  deleteStorageProvider,
} from '@/app/admin/storage-providers/actions';

// 创建新配置
await createStorageProvider({
  providerCode: 'ali-oss',
  providerName: '生产环境-阿里云OSS',
  config: {
    region: 'oss-cn-hangzhou',
    accessKeyId: 'xxx',
    accessKeySecret: 'xxx',
    bucket: 'my-bucket',
  },
  isDefault: true,
  isActive: true,
  createdById: userId,
});

// 设置默认存储
await setDefaultProvider(providerId, userId);

// 启用/禁用
await toggleProviderStatus(providerId, userId);
```
