# 单独生成模式 - 支持角色形象图生视频

**日期**: 2026-01-29
**类型**: 功能增强 + Bug 修复
**影响范围**: Web API + Client 前端

## 问题描述

之前的"单独生成模式"被描述为"纯文生视频"，但实际上应该支持使用角色形象进行图生视频，只是不使用故事板格式。

## 修改内容

### 后端修改

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

#### 修改前
```typescript
} else {
  // 使用普通格式
  prompt = await buildVideoPrompt({
    type: promptType,
    scene,
    characters: scene.script.project.characters,
  });
}
```

#### 修改后
```typescript
} else {
  // 使用普通格式
  prompt = await buildVideoPrompt({
    type: promptType,
    scene,
    characters: scene.script.project.characters,
  });

  // 单独生成模式也支持角色形象
  if (useCharacterImage && !finalReferenceImage) {
    finalReferenceImage = await getCharacterImage(
      scene,
      scene.script.project.characters
    );
  }
}
```

### 前端修改

**文件**:
- `client/src/pages/ProjectScript.tsx`
- `client/src/pages/ScriptEditor.tsx`

#### 提示文案修改

**修改前**:
```
✓ 单独生成模式：
使用普通格式生成视频，纯文生视频。适合没有角色形象或需要更灵活控制的场景。
```

**修改后**:
```
✓ 单独生成模式：
使用普通格式生成视频。有角色形象时自动使用图生视频方式，无角色形象时使用纯文生视频。适合需要更灵活控制的场景。
```

## 功能说明

### 两种模式的区别

#### 故事板模式
- **Prompt 格式**: 故事板格式（Shot 1: duration: Xsec...）
- **参考图**: 自动使用角色的数字人形象
- **适用场景**: 需要更连贯的视频效果，场景数量少

#### 单独生成模式
- **Prompt 格式**: 普通格式（镜头描述 + 场景描述 + 角色动作...）
- **参考图**: 自动使用角色的数字人形象（如果有）
- **适用场景**: 需要更灵活的控制，或场景数量多

### 参考图获取逻辑

两种模式都会自动获取角色形象作为参考图：

1. **优先级**:
   - 手动指定的 `referenceImage`（最高优先级）
   - 角色的已选中数字人形象
   - 角色头像
   - 无参考图（纯文生视频）

2. **条件**:
   - `useCharacterImage=true`（默认为 true）
   - 没有手动指定 `referenceImage`
   - 场景有关联的角色

## 代码逻辑

### 后端 API

```typescript
// 构建 prompt
if (useStoryboard) {
  // 故事板格式
  prompt = buildSceneStoryboardPrompt(scene);
  if (useCharacterImage && !finalReferenceImage) {
    finalReferenceImage = await getCharacterImage(scene, characters);
  }
} else {
  // 普通格式
  prompt = await buildVideoPrompt({ type: promptType, scene, characters });
  // 单独生成模式也支持角色形象
  if (useCharacterImage && !finalReferenceImage) {
    finalReferenceImage = await getCharacterImage(scene, characters);
  }
}

// 调用视频生成 API
const result = await videoClient.submit({
  prompt,
  imageUrl: finalReferenceImage, // 两种模式都可能有参考图
  duration: body.duration || scene.duration || 10,
  aspectRatio: body.aspectRatio || "16:9",
});
```

### 前端调用

```typescript
const result = await generateSceneVideo(id, scriptId, sceneId, {
  promptType: 'smart_combine',
  useStoryboard,              // true=故事板模式, false=单独生成模式
  useCharacterImage: true,    // 两种模式都默认使用角色形象
});
```

## 用户体验改进

### 修改前
- 用户误以为单独生成模式只能纯文生视频
- 无法在单独生成模式下使用角色形象

### 修改后
- 两种模式都支持使用角色形象
- 区别在于 prompt 格式和视频生成方式
- 用户可以根据需求选择合适的模式

## 测试建议

1. **有角色形象的场景**:
   - 测试故事板模式：验证使用角色形象 + 故事板格式
   - 测试单独生成模式：验证使用角色形象 + 普通格式

2. **无角色形象的场景**:
   - 测试故事板模式：验证纯文生视频 + 故事板格式
   - 测试单独生成模式：验证纯文生视频 + 普通格式

3. **手动指定参考图**:
   - 验证手动指定的参考图优先级最高
   - 验证在两种模式下都生效

4. **角色形象获取**:
   - 验证优先使用已选中的数字人形象
   - 验证回退到角色头像
   - 验证无形象时的纯文生视频

## 总结

本次修改让"单独生成模式"也支持使用角色形象进行图生视频：

- ✅ 后端添加角色形象获取逻辑
- ✅ 前端更新提示文案
- ✅ 两种模式都支持图生视频
- ✅ 区别在于 prompt 格式，不在于是否使用参考图
- ✅ 提升用户体验和功能灵活性

现在用户可以在两种模式下都享受到图生视频的优势，同时根据场景需求选择合适的 prompt 格式。
