# AI 生成场景提示词优化

**日期**: 2026-01-28
**类型**: Enhancement
**关联**: AI生成场景数据结构修复-2026-01-28.md

## 优化目标

将 AI 提示词从简化格式升级为完整结构化格式，让 AI 直接生成符合场景编辑器要求的完整数据，减少后端转换逻辑。

## 优化前后对比

### 优化前：简化提示词

```typescript
const systemPrompt = `...
- content 对象包含：
  - dialogue（台词）
  - action（动作描述）
  - camera（镜头描述）
  - characterIds（出场角色ID数组）
...`;
```

**问题**：
- AI 生成的数据结构简单，只有字符串字段
- 需要后端转换层将简化数据转换为完整结构
- 转换过程中可能丢失信息或产生不准确的默认值

### 优化后：完整结构化提示词

```typescript
const systemPrompt = `...
- content 对象必须包含以下完整结构：
  {
    "description": "场景描述（20-50字）",
    "sceneType": "场景类型（indoor/outdoor/special）",
    "characters": [
      {
        "characterId": "角色ID",
        "characterName": "角色名称",
        "action": "角色动作描述",
        "emotion": "情绪状态",
        "position": "画面位置（left/center/right）"
      }
    ],
    "dialogues": [
      {
        "characterId": "角色ID",
        "text": "台词内容",
        "speed": "语速（slow/normal/fast）",
        "tone": "语气"
      }
    ],
    "camera": {
      "type": "镜头类型（closeup/medium/full/wide）",
      "movement": "运镜方式（static/push/pull/follow）"
    },
    "visual": {
      "transition": "转场效果",
      "effects": ["视觉效果数组"],
      "subtitleStyle": "字幕样式"
    },
    "audio": {
      "bgm": "背景音乐类型",
      "soundEffects": ["音效数组"]
    }
  }
...`;
```

**优势**：
- ✅ AI 直接生成完整的结构化数据
- ✅ 减少后端转换逻辑
- ✅ 数据更准确，AI 可以根据场景内容智能选择合适的值
- ✅ 更灵活，AI 可以为不同场景生成不同的镜头、音乐等

## 实施细节

### 1. 更新提示词

**文件**: `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts`

**关键改进**：

#### 场景创作要点
```typescript
场景创作要点：
- 场景要连贯，符合剧本大概的故事线
- 台词要口语化，适合短视频，每句控制在 15-30 字
- 根据场景内容合理选择镜头类型和运镜方式
- 为每个场景选择合适的背景音乐和音效
- 场景类型根据描述判断：室内用 indoor，户外用 outdoor，特殊场景用 special
```

#### 完整示例
提供了完整的 JSON 示例，包含所有必需字段，帮助 AI 理解期望的输出格式。

### 2. 更新接口定义

```typescript
interface SceneContent {
  description: string;
  sceneType: 'indoor' | 'outdoor' | 'special';
  characters: Array<{...}>;
  dialogues: Array<{...}>;
  camera: {...};
  visual: {...};
  audio: {...};
}
```

### 3. 添加验证和降级逻辑

```typescript
function isCompleteSceneContent(content: any): boolean {
  return (
    content &&
    typeof content.description === 'string' &&
    typeof content.sceneType === 'string' &&
    Array.isArray(content.characters) &&
    Array.isArray(content.dialogues) &&
    content.camera &&
    typeof content.camera.type === 'string' &&
    typeof content.camera.movement === 'string' &&
    content.visual &&
    content.audio
  );
}
```

**降级策略**：
- 如果 AI 返回完整结构 → 直接使用
- 如果 AI 返回简化格式 → 使用转换层处理（降级方案）
- 记录警告日志，便于监控 AI 输出质量

```typescript
if (!isCompleteSceneContent(content)) {
  console.warn('AI 返回简化格式，使用转换层处理:', scene.title);
  content = transformAISceneToComplete(content, characters);
}
```

## 架构优势

### 智能降级
```
AI 生成
    ↓
验证结构
    ↓
完整? ──Yes──→ 直接使用
    ↓
   No
    ↓
转换层处理 ──→ 完整结构
```

**好处**：
1. **渐进式优化**: 可以逐步提升 AI 输出质量，不影响现有功能
2. **容错性强**: AI 输出不稳定时自动降级，保证功能可用
3. **可监控**: 通过日志监控 AI 输出质量，发现问题及时调整提示词

### 保留转换层的价值

虽然目标是让 AI 直接生成完整结构，但保留转换层代码有以下价值：

1. **降级方案**: AI 输出不稳定时的备用方案
2. **测试覆盖**: 转换层有完整的单元测试，保证数据转换正确性
3. **兼容性**: 支持旧版本 AI 模型或其他 AI 提供商

## 测试验证

### 单元测试
```bash
✓ src/lib/utils/scene-transformer.test.ts (4 tests) 3ms
  Test Files  1 passed (1)
  Tests       4 passed (4)
```

### TypeScript 编译
```bash
✓ 无 generate-scenes 相关编译错误
```

## 预期效果

### AI 生成质量提升

**之前**：
- 台词：简单字符串
- 镜头：文本描述（如"正面中景，温暖光线"）
- 音频：无
- 视觉：无

**现在**：
- 台词：结构化数组，包含角色、语速、语气
- 镜头：结构化对象，明确类型和运镜方式
- 音频：包含背景音乐和音效建议
- 视觉：包含转场和特效建议

### 场景编辑器回显

所有字段都能正确回显：
- ✅ 标题和时长
- ✅ 角色与台词（完整信息）
- ✅ 镜头与视觉（结构化数据）
- ✅ 音频设置（有建议值）

## 后续优化建议

### 1. 监控 AI 输出质量

添加监控指标：
```typescript
// 记录 AI 输出格式统计
const metrics = {
  totalScenes: scenes.length,
  completeScenes: scenes.filter(s => isCompleteSceneContent(s.content)).length,
  fallbackScenes: scenes.filter(s => !isCompleteSceneContent(s.content)).length,
};
console.log('AI 输出质量:', metrics);
```

### 2. A/B 测试

对比新旧提示词的效果：
- 生成质量
- 生成速度
- Token 消耗

### 3. 提示词微调

根据实际使用反馈，持续优化提示词：
- 调整字段说明的清晰度
- 增加更多示例
- 优化场景创作要点

### 4. 支持更多场景类型

扩展 `sceneType` 枚举：
- `virtual`: 虚拟场景
- `animation`: 动画场景
- `mixed`: 混合场景

## 总结

通过优化 AI 提示词，我们实现了：

1. ✅ **更准确的数据**: AI 直接生成完整结构，减少转换误差
2. ✅ **更智能的选择**: AI 根据场景内容智能选择镜头、音乐等
3. ✅ **更好的容错**: 验证 + 降级机制保证功能稳定
4. ✅ **更易维护**: 减少后端转换逻辑，代码更简洁

这是一个渐进式优化方案，既提升了 AI 输出质量，又保持了系统的稳定性和可维护性。
