# AI 模型配置页面 - 恢复独立编辑页面

**日期**: 2026-01-29
**类型**: Bug 修复
**影响范围**: Web 后台管理 - AI 模型配置

## 问题描述

AI 模型配置页面 (`/admin/ai-config`) 的列表页使用 Dialog 弹窗来处理新增和编辑操作，但实际上已经存在一个功能完整的独立编辑页面 (`/admin/ai-config/[id]/page.tsx`)，该页面包含了：

- 不同模型类型的适配器配置（TEXT、IMAGE、VIDEO、VOICE）
- API 格式选择器（OpenAI、Anthropic、通义千问、智谱、百度等）
- 图片生成提供商（DALL-E、Stable Diffusion、通义万相等）
- 视频生成提供商（Sora、Runway、可灵等）
- 语音生成提供商（OpenAI TTS、ElevenLabs、Azure TTS 等）
- 详细的高级配置参数

这些高级配置功能在 Dialog 弹窗版本中无法使用。

## 修复方案

### 1. 修改列表页 (`page.tsx`)

将列表页从使用 Dialog 弹窗改为跳转到独立编辑页面：

**修改内容**：
- 移除 Dialog 相关的导入和状态管理
- 添加 `useRouter` 用于页面跳转
- 将 `openCreateDialog`、`openEditDialog`、`openCopyDialog` 改为路由跳转函数
- 移除整个 Dialog 组件及其表单内容

**关键代码变更**：

```typescript
// 新增路由跳转函数
function handleCreate() {
  router.push("/admin/ai-config/new");
}

function handleEdit(id: string) {
  router.push(`/admin/ai-config/${id}`);
}

function handleCopy(id: string) {
  router.push(`/admin/ai-config/new?copyFrom=${id}`);
}
```

### 2. 保留独立编辑页面 (`[id]/page.tsx`)

该页面已经包含完整的功能，无需修改：
- 支持新增模式 (`/admin/ai-config/new`)
- 支持编辑模式 (`/admin/ai-config/[id]`)
- 支持复制模式 (`/admin/ai-config/new?copyFrom=[id]`)
- 包含所有高级配置选项

## 文件变更

### 修改的文件

1. `web/src/app/admin/ai-config/page.tsx` - 列表页，移除 Dialog，改为路由跳转
2. `web/src/app/api/admin/ai-config/[id]/route.ts` - 添加 GET 方法支持获取单个配置

### 保持不变的文件

- `web/src/app/admin/ai-config/[id]/page.tsx` - 独立编辑页面（834 行）
- `web/src/app/api/admin/ai-config/route.ts` - API 列表路由

## 技术细节

### API 路由修复

**问题**：`/api/admin/ai-config/[id]` 路由缺少 GET 方法，导致编辑页面无法获取配置详情，返回 405 错误。

**解决方案**：在 `web/src/app/api/admin/ai-config/[id]/route.ts` 中添加 GET 方法：

```typescript
// GET /api/admin/ai-config/[id] - 获取单个 AI 配置
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: "未授权" }, { status: 401 });
    }

    const { id } = await params;

    const config = await prisma.aIModelConfig.findUnique({
      where: { id },
    });

    if (!config) {
      return NextResponse.json({ error: "配置不存在" }, { status: 404 });
    }

    return NextResponse.json({ data: config });
  } catch (error) {
    console.error("获取 AI 配置失败:", error);
    return NextResponse.json({ error: "获取失败" }, { status: 500 });
  }
}
```

现在该路由支持三个 HTTP 方法：
- **GET**: 获取单个配置详情
- **PUT**: 更新配置
- **DELETE**: 删除配置

## 功能特性

### 列表页功能
- 查看所有 AI 模型配置
- 按模型类型筛选（文本、图片、视频、语音）
- 显示/隐藏 API Key
- 快速操作：编辑、复制、删除

### 编辑页功能

#### 基本信息
- 模型类型选择（创建后不可修改）
- 提供商名称
- 模型名称
- API 地址
- API Key
- 优先级
- 默认/启用状态

#### 文本生成高级配置
- API 格式：OpenAI、Anthropic、通义千问、智谱、百度、自定义
- Temperature 参数
- Max Tokens 参数
- 自定义响应解析路径

#### 图片生成高级配置
- 提供商：DALL-E、Stable Diffusion、通义万相、智谱 CogView、fal.ai、bltcy
- 默认尺寸
- 默认生成数量
- 响应格式（URL / Base64）

#### 视频生成高级配置
- 提供商：Sora、Runway、可灵、智谱 CogVideo、fal.ai
- 默认时长
- 默认分辨率
- 默认宽高比
- 轮询间隔

#### 语音生成高级配置
- 提供商：OpenAI TTS、ElevenLabs、Azure TTS、阿里云 TTS、MiniMax TTS
- 默认音色
- 默认语速
- 输出格式

## 用户体验改进

1. **更好的表单体验**：独立页面提供更大的空间展示复杂表单
2. **高级配置可见**：所有适配器配置和高级参数都可以访问
3. **更清晰的操作流程**：新增/编辑/复制都在独立页面完成
4. **更好的可维护性**：表单逻辑集中在一个文件中

## 测试建议

1. 访问 `/admin/ai-config` 查看配置列表
2. 点击"新增配置"按钮，应跳转到 `/admin/ai-config/new`
3. 在列表中点击"编辑"按钮，应跳转到 `/admin/ai-config/[id]`
4. 在列表中点击"复制"按钮，应跳转到 `/admin/ai-config/new?copyFrom=[id]`
5. 验证不同模型类型的高级配置是否正常显示
6. 验证表单提交后能正确返回列表页

## 相关文件

- 列表页：`web/src/app/admin/ai-config/page.tsx` (196 行)
- 编辑页：`web/src/app/admin/ai-config/[id]/page.tsx` (834 行)
- API 列表路由：`web/src/app/api/admin/ai-config/route.ts`
- API 详情路由：`web/src/app/api/admin/ai-config/[id]/route.ts` (89 行)

## 修复的错误

1. **405 Method Not Allowed**: 编辑页面调用 `GET /api/admin/ai-config/[id]` 时返回 405 错误
2. **Dialog 弹窗限制**: 无法访问高级配置和适配器设置
