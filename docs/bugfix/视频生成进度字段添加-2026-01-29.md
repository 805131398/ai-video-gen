# 添加视频生成进度字段

## 概述

为 `scene_videos` 表添加 `progress` 字段，用于存储视频生成的真实进度（0-100%）。

## 问题分析

### 之前的问题

1. **数据库缺少字段**：`SceneVideo` 表没有 `progress` 字段
2. **进度未保存**：后端轮询时只更新 status，不保存 progress
3. **显示固定值**：状态查询 API 返回固定的进度值（generating = 50%），而不是真实进度

### 用户体验影响

- 用户看到的进度始终是 50%，无法看到真实的生成进度
- 无法判断视频生成是刚开始还是快完成
- 长时间生成任务（1-5分钟）缺乏进度反馈

## 解决方案

### 1. 数据库 Schema 修改

**文件**: `web/prisma/schema.prisma`

添加 `progress` 字段：

```prisma
model SceneVideo {
  id            String   @id @default(uuid())
  sceneId       String   @map("scene_id")
  videoUrl      String   @map("video_url")
  thumbnailUrl  String?  @map("thumbnail_url")
  duration      Int?
  prompt        String   @db.Text
  promptType    String   @map("prompt_type")
  status        String   @default("pending")
  progress      Int      @default(0) // 新增：生成进度 (0-100)
  taskId        String?  @map("task_id")
  errorMessage  String?  @map("error_message") @db.Text
  metadata      Json?
  isSelected    Boolean  @default(false) @map("is_selected")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  scene ScriptScene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([status])
  @@map("scene_videos")
}
```

### 2. 后端轮询逻辑修改

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

修改 `pollVideoStatus` 函数，每次轮询都更新进度：

```typescript
async function pollVideoStatus(
  videoId: string,
  taskId: string,
  videoClient: any
) {
  const maxAttempts = 120;
  let attempts = 0;

  while (attempts < maxAttempts) {
    try {
      await new Promise((resolve) => setTimeout(resolve, 5000));
      attempts++;

      const status = await videoClient.getStatus(taskId);

      // 更新进度（无论什么状态都更新）
      await prisma.sceneVideo.update({
        where: { id: videoId },
        data: {
          progress: status.progress || 0,
        },
      });

      if (status.status === "completed") {
        await prisma.sceneVideo.update({
          where: { id: videoId },
          data: {
            status: "completed",
            progress: 100,
            videoUrl: status.videoUrl,
            thumbnailUrl: status.thumbnailUrl,
            duration: status.duration,
            metadata: status.metadata || {},
          },
        });
        break;
      } else if (status.status === "failed") {
        await prisma.sceneVideo.update({
          where: { id: videoId },
          data: {
            status: "failed",
            progress: 0,
            errorMessage: status.message || "视频生成失败",
          },
        });
        break;
      }
    } catch (error) {
      console.error(`Polling error for video ${videoId}:`, error);
      // ... 错误处理
    }
  }
}
```

**关键改进**：
- 每次轮询都更新 `progress` 字段
- 完成时设置 `progress = 100`
- 失败时设置 `progress = 0`

### 3. 状态查询 API 修改

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/videos/status/route.ts`

修改返回逻辑，优先使用真实进度：

```typescript
const scenes = script.scenes.map((scene) => {
  const latestVideo = scene.videos[0];

  return {
    sceneId: scene.id,
    sceneTitle: scene.title,
    status: latestVideo?.status || "no_video",
    progress: latestVideo?.progress ?? calculateProgress(latestVideo?.status), // 优先使用真实进度
    videoUrl: latestVideo?.videoUrl || null,
    thumbnailUrl: latestVideo?.thumbnailUrl || null,
    duration: latestVideo?.duration || null,
    errorMessage: latestVideo?.errorMessage || null,
    videoId: latestVideo?.id || null,
    createdAt: latestVideo?.createdAt || null,
  };
});
```

**关键改进**：
- 优先使用数据库中的 `progress` 字段
- 如果 `progress` 为 null，则使用 `calculateProgress` 作为后备

## 数据库迁移

### 执行迁移

```bash
cd web
pnpm db:generate  # 生成 Prisma 客户端
pnpm db:push      # 推送 schema 到数据库
```

### 迁移 SQL（参考）

```sql
ALTER TABLE scene_videos ADD COLUMN progress INTEGER NOT NULL DEFAULT 0;
```

### 数据迁移

对于已存在的记录，`progress` 字段会自动设置为默认值 0。

如果需要根据 status 设置初始进度：

```sql
UPDATE scene_videos
SET progress = CASE
  WHEN status = 'completed' THEN 100
  WHEN status = 'generating' THEN 50
  WHEN status = 'failed' THEN 0
  ELSE 0
END
WHERE progress = 0;
```

## 测试验证

### 1. 测试新视频生成

1. 创建新的视频生成任务
2. 观察前端卡片上的进度条
3. 验证进度从 0% 逐渐增加到 100%

### 2. 测试数据库存储

```sql
-- 查看正在生成的视频进度
SELECT id, scene_id, status, progress, created_at
FROM scene_videos
WHERE status = 'generating'
ORDER BY created_at DESC;
```

### 3. 测试 API 响应

```bash
# 查询视频状态
curl -X GET "http://localhost:3000/api/projects/{projectId}/scripts/{scriptId}/videos/status" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

验证响应中的 `progress` 字段是否为真实值（0-100）。

## 前端显示效果

### 之前（固定进度）
```
生成中 50%
████████████░░░░░░░░░░░░
```

### 现在（真实进度）
```
生成中 23%
█████░░░░░░░░░░░░░░░░░░░

生成中 67%
████████████████░░░░░░░░

生成中 89%
█████████████████████░░░
```

## 性能影响

### 数据库写入

- **之前**：每次轮询只在完成/失败时写入一次
- **现在**：每次轮询都写入一次（每 5 秒）
- **影响**：轻微增加数据库写入负载，但可接受

### 优化建议

如果担心写入频率过高，可以添加进度变化阈值：

```typescript
// 只在进度变化超过 5% 时更新
if (Math.abs((status.progress || 0) - lastProgress) >= 5) {
  await prisma.sceneVideo.update({
    where: { id: videoId },
    data: { progress: status.progress || 0 },
  });
  lastProgress = status.progress || 0;
}
```

## 注意事项

1. **默认值**：新记录的 progress 默认为 0
2. **兼容性**：旧记录的 progress 为 0，不影响功能
3. **类型安全**：Prisma 会自动生成类型，确保类型安全
4. **索引**：progress 字段不需要索引，因为不用于查询条件

## 相关文件

- `web/prisma/schema.prisma` - 数据库 schema
- `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts` - 视频生成 API
- `web/src/app/api/projects/[id]/scripts/[scriptId]/videos/status/route.ts` - 状态查询 API
- `client/src/pages/ProjectScript.tsx` - 前端页面
- `client/src/components/project/DraggableSceneList.tsx` - 场景卡片组件

## 后续优化

1. **进度缓存**：在内存中缓存进度，减少数据库写入
2. **WebSocket 推送**：使用 WebSocket 实时推送进度，替代轮询
3. **进度详情**：记录更详细的进度信息（如当前处理阶段）
4. **历史记录**：保存进度变化历史，用于性能分析
