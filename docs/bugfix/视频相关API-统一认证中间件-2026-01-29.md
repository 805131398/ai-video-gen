# 视频相关 API 统一认证中间件修复

**日期**: 2026-01-29
**类型**: Bug 修复
**影响范围**: Web API 路由 - 视频生成相关接口

## 问题描述

视频相关的 API 接口返回 401 未授权错误，导致客户端无法查询视频生成状态。错误日志显示：

```
GET /api/projects/[id]/scripts/[scriptId]/videos/status 401
POST /api/auth/refresh 200
```

客户端不断尝试刷新 token，但视频状态接口仍然返回 401。

### 错误原因

项目中存在两套认证系统：

1. **NextAuth.js v5** - 基于 Cookie 的 session 认证（用于 Web 应用）
2. **自定义 JWT** - 基于 Authorization header 的 token 认证（用于 Electron 客户端）

部分 API 路由直接使用 `auth()` 函数（仅支持 NextAuth session），而客户端使用的是自定义 JWT token，导致认证失败。

## 修复方案

### 统一认证中间件

项目已有 `getAuthUser(request)` 统一认证中间件，支持两种认证方式：

```typescript
// @/lib/auth-middleware.ts
export async function getAuthUser(request: NextRequest): Promise<AuthUser | null> {
  // 方式 1: 尝试从 Authorization header 获取 JWT token (Electron 客户端)
  const authHeader = request.headers.get('authorization');
  if (authHeader?.startsWith('Bearer ')) {
    const token = authHeader.substring(7);
    const decoded = verify(token, JWT_SECRET) as AuthUser;
    return decoded;
  }

  // 方式 2: 尝试从 NextAuth session 获取用户信息 (Web 应用)
  const session = await auth();
  if (session?.user?.id) {
    return { id: session.user.id, ... };
  }

  return null;
}
```

### API 变更对照

| 修复前 | 修复后 |
|--------|--------|
| `import { auth } from "@/lib/auth"` | `import { getAuthUser } from "@/lib/auth-middleware"` |
| `const session = await auth()` | `const user = await getAuthUser(request)` |
| `if (!session?.user?.id)` | `if (!user?.id)` |
| `userId: session.user.id` | `userId: user.id` |

## 修改的文件

### 1. `/api/projects/[id]/scripts/[scriptId]/videos/status/route.ts`

**修改内容**：
- 将 `auth()` 改为 `getAuthUser(request)`
- 将 `session.user.id` 改为 `user.id`

**修改前**：
```typescript
import { auth } from "@/lib/auth";

const session = await auth();
if (!session?.user?.id) {
  return NextResponse.json({ error: "未授权" }, { status: 401 });
}

const script = await prisma.projectScript.findFirst({
  where: {
    project: { userId: session.user.id },
  },
});
```

**修改后**：
```typescript
import { getAuthUser } from "@/lib/auth-middleware";

const user = await getAuthUser(request);
if (!user?.id) {
  return NextResponse.json({ error: "未授权" }, { status: 401 });
}

const script = await prisma.projectScript.findFirst({
  where: {
    project: { userId: user.id },
  },
});
```

### 2. `/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts`

**修改内容**：
- 将 `auth()` 改为 `getAuthUser(request)`
- 将 `session.user.id` 改为 `user.id`
- 添加 `generateVideos` 函数导入
- 修改 `callVideoGenerationAPI` 函数，直接调用 `generateVideos` 而不是通过 HTTP API

**原因**：后台异步调用时无法传递认证信息，直接调用底层函数可以避免认证问题

### 3. `/api/projects/[id]/scripts/[scriptId]/scenes/reorder/route.ts`

**修改内容**：同第 1 项

### 4. `/api/ai/videos/route.ts`

**修改内容**：
- 将 `auth()` 改为 `getAuthUser(request)`
- 将 `session.user.id` 改为 `user.id`

## 影响的功能

修复后，以下功能恢复正常：

1. **视频生成状态查询** (`GET /api/projects/[id]/scripts/[scriptId]/videos/status`)
   - Electron 客户端可以正常查询视频生成状态
   - Web 应用也可以正常使用（通过 NextAuth session）

2. **批量生成视频** (`POST /api/projects/[id]/scripts/[scriptId]/generate-videos`)
   - 支持 Electron 客户端和 Web 应用
   - 后台视频生成不再出现 401 错误

3. **场景排序** (`PUT /api/projects/[id]/scripts/[scriptId]/scenes/reorder`)
   - 支持 Electron 客户端和 Web 应用

4. **AI 视频生成接口** (`POST /api/ai/videos`)
   - 支持 Electron 客户端和 Web 应用

## 验证步骤

1. 重启开发服务器
2. 使用 Electron 客户端访问剧本编辑器页面
3. 测试以下功能：
   - 查看视频生成状态（不再返回 401）
   - 点击"生成视频"按钮
   - 拖拽场景重新排序
4. 确认没有 401 认证错误

## 技术要点

### 统一认证中间件的优势

1. **兼容多端**：同时支持 Web 应用（NextAuth session）和 Electron 客户端（JWT token）
2. **降级处理**：优先尝试 JWT token，失败后尝试 NextAuth session
3. **统一接口**：所有 API 路由使用相同的认证方式，避免混乱

### 认证流程

```
客户端请求
    ↓
检查 Authorization header
    ↓
有 Bearer token? ──是→ 验证 JWT token ──成功→ 返回用户信息
    ↓ 否                    ↓ 失败
检查 NextAuth session       ↓
    ↓                       ↓
有 session? ──是→ 返回用户信息
    ↓ 否
返回 null (401)
```

### 后台任务调用模式

对于后台异步任务（如视频生成），采用直接调用底层函数的方式，避免 HTTP 调用的认证问题：

```typescript
// ❌ 不推荐：通过 HTTP API 调用（需要处理认证）
const response = await fetch('/api/ai/videos', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` }, // 后台任务中难以获取 token
  body: JSON.stringify({ ... })
});

// ✅ 推荐：直接调用底层函数
import { generateVideos } from '@/lib/ai/video-generator';
const videos = await generateVideos([...]);
```

## 后续建议

1. **统一所有 API 路由**：检查其他 API 路由，确保都使用 `getAuthUser(request)`
2. **添加 ESLint 规则**：禁止在 API 路由中直接使用 `auth()`，强制使用 `getAuthUser(request)`
3. **更新开发文档**：说明项目的认证架构和最佳实践
4. **后台任务模式**：对于后台异步任务，优先直接调用底层函数，避免 HTTP 调用的认证复杂性

## 相关文档

- 统一认证中间件: `web/src/lib/auth-middleware.ts`
- NextAuth 配置: `web/src/lib/auth.ts`
- JWT 刷新接口: `web/src/app/api/auth/refresh/route.ts`
