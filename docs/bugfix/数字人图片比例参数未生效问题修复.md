# 数字人图片比例参数未生效问题修复

## 问题描述

用户在生成数字人时选择了不同的图片比例（竖屏 9:16 或横屏 16:9），但生成的图片始终是默认比例，选择的比例参数没有生效。

### 用户反馈

- 在数字人生成器中选择了"横屏 16:9"或"竖屏 9:16"
- 点击"生成角色数字人"按钮
- 生成的图片比例与选择的不一致，始终是默认的竖屏比例

## 问题分析

### 数据流追踪

1. **前端组件** (`DigitalHumanGenerator.tsx:107`)
   ```typescript
   const sizeParam = aspectRatio === 'landscape' ? '1792x1024' : '1024x1792';
   await onGenerate(characterDescription, referenceImageUrl, sizeParam);
   ```
   ✅ 正确传递了 `size` 参数

2. **编辑器组件** (`CharacterDetailEditor.tsx:140`)
   ```typescript
   const result = await generateDigitalHumans(projectId, character.id, 1, aspectRatio);
   ```
   ✅ 正确传递了 `aspectRatio` 参数

3. **API 服务** (`client/src/services/project.ts:109`)
   ```typescript
   const response = await api.post(
     `/projects/${projectId}/characters/${characterId}/digital-humans/generate`,
     { count, size }
   );
   ```
   ✅ 正确发送了 `size` 参数到后端

4. **后端 API** (`web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts:58`)
   ```typescript
   const { count = 1, size = "1024x1792" } = body;
   ```
   ✅ 正确接收了 `size` 参数

5. **异步生成函数** (`route.ts:98`)
   ```typescript
   generateDigitalHumansAsync(
     projectId,
     characterId,
     prompt,
     count,
     user.id,
     user.tenantId,
     batchId,
     size  // ✅ 正确传递
   );
   ```

6. **图片生成器** (`web/src/lib/ai/image-generator.ts:184`)
   ```typescript
   const image = await generateSingleImage(
     {
       prompt,
       negativePrompt: "...",
       size: size as "1024x1024" | "1024x1792" | "1792x1024",
     },
     userId,
     tenantId
   );
   ```
   ✅ 正确传递了 `size` 参数

7. **bltcy API 调用** (`image-generator.ts:235-241`)
   ```typescript
   const images = isBltcyAPI
     ? await callBltcyImageAPI(
         config.apiUrl,
         config.apiKey,
         config.modelName,
         fullPrompt,
         { n: 1, size: input.size, style: input.style }  // ✅ 传递了 size
       )
   ```

8. **问题所在** (`image-generator.ts:122-131`)
   ```typescript
   body: JSON.stringify({
     model: modelName,
     stream: false,
     messages: [
       {
         role: "user",
         content: prompt,
       },
     ],
     // ❌ 缺少 size 参数！
   }),
   ```

### 根本原因

在 `callBltcyImageAPI` 函数中，虽然接收了 `options.size` 参数，但在构建请求体时**没有将其包含在 JSON 中**，导致 bltcy API 无法获取到尺寸参数，始终使用默认尺寸生成图片。

## 解决方案

在 `callBltcyImageAPI` 函数的请求体中添加 `size` 参数。

### 修改文件

**文件**: `web/src/lib/ai/image-generator.ts`

#### 1. 更新日志输出

```typescript
console.log("[callBltcyImageAPI] 模型:", modelName, "数量:", options.n || 1, "尺寸:", options.size || "1024x1024");
```

#### 2. 在请求体中添加 size 参数

```typescript
body: JSON.stringify({
  model: modelName,
  stream: false,
  messages: [
    {
      role: "user",
      content: prompt,
    },
  ],
  // 添加图片尺寸参数
  size: options.size || "1024x1024",
}),
```

## 修改详情

### 修改位置

- **文件**: `web/src/lib/ai/image-generator.ts`
- **函数**: `callBltcyImageAPI`
- **行号**: 100, 132

### 修改前

```typescript
console.log("[callBltcyImageAPI] 模型:", modelName, "数量:", options.n || 1);

// ...

body: JSON.stringify({
  model: modelName,
  stream: false,
  messages: [
    {
      role: "user",
      content: prompt,
    },
  ],
}),
```

### 修改后

```typescript
console.log("[callBltcyImageAPI] 模型:", modelName, "数量:", options.n || 1, "尺寸:", options.size || "1024x1024");

// ...

body: JSON.stringify({
  model: modelName,
  stream: false,
  messages: [
    {
      role: "user",
      content: prompt,
    },
  ],
  // 添加图片尺寸参数
  size: options.size || "1024x1024",
}),
```

## 验证方法

### 测试步骤

1. 打开项目详情页面
2. 创建或编辑一个角色
3. 在数字人生成器中选择"横屏 16:9"
4. 点击"生成角色数字人"按钮
5. 等待生成完成
6. 检查生成的图片是否为横屏比例（1792x1024）

### 预期结果

- 选择"竖屏 9:16"时，生成的图片尺寸为 1024x1792
- 选择"横屏 16:9"时，生成的图片尺寸为 1792x1024
- 控制台日志显示正确的尺寸参数

### 日志验证

修复后，控制台应该显示：

```
[callBltcyImageAPI] 模型: flux-pro 数量: 1 尺寸: 1792x1024
[callBltcyImageAPI] 开始生成第 1/1 张图片...
```

## 技术要点

### 1. bltcy API 特性

bltcy 使用 Chat Completions 格式的 API，但支持图片生成功能。与标准的 DALL-E API 不同，它需要在请求体中包含 `size` 参数。

### 2. 参数传递链路

完整的参数传递链路：
```
前端组件选择 → onGenerate 回调 → generateDigitalHumans API
→ 后端 API 接收 → generateDigitalHumansAsync
→ generateSingleImage → callBltcyImageAPI → bltcy API
```

### 3. 默认值处理

在多个层级都设置了默认值 `"1024x1024"`，确保即使参数缺失也能正常工作：
- `generateDigitalHumans` 函数参数默认值
- `callBltcyImageAPI` 请求体默认值
- `generateSingleImage` 元数据默认值

### 4. 类型安全

使用 TypeScript 类型约束确保尺寸参数的有效性：
```typescript
size?: "1024x1024" | "1024x1792" | "1792x1024"
```

## 影响范围

### 受影响的功能

- 数字人生成功能
- 所有使用 bltcy API 的图片生成场景

### 不受影响的功能

- 使用标准 DALL-E API 的图片生成（`callImageAPI` 函数已正确处理）
- 其他 AI 功能（文本生成、语音生成等）

## 注意事项

1. **API 兼容性**: 确保 bltcy API 支持 `size` 参数。如果 API 不支持，可能需要在 prompt 中包含尺寸信息。

2. **错误处理**: 如果 API 返回错误（如不支持的尺寸），应该有适当的错误提示。

3. **日志监控**: 修复后应该监控日志，确认尺寸参数正确传递到 API。

4. **测试覆盖**: 建议添加单元测试，验证不同尺寸参数的传递。

## 相关文件

- `client/src/components/project/DigitalHumanGenerator.tsx` - 数字人生成器组件
- `client/src/components/project/CharacterDetailEditor.tsx` - 角色编辑器组件
- `client/src/services/project.ts` - 项目 API 服务
- `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts` - 后端生成 API
- `web/src/lib/ai/image-generator.ts` - 图片生成服务（修复位置）

## 后续优化建议

1. **参数验证**: 在后端 API 中添加尺寸参数的验证，确保只接受支持的尺寸。

2. **错误提示**: 如果 API 不支持某个尺寸，应该给用户明确的错误提示。

3. **单元测试**: 为 `callBltcyImageAPI` 函数添加单元测试，覆盖不同尺寸参数的场景。

4. **文档更新**: 更新 API 文档，说明支持的图片尺寸选项。
