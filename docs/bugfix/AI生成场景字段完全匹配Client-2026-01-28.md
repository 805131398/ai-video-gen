# AI 生成场景字段完全匹配 Client

**日期**: 2026-01-28
**类型**: Bug Fix
**关联**: AI生成场景提示词优化-2026-01-28.md

## 问题发现

用户测试后发现，虽然 AI 生成了结构化数据，但与 Client 场景编辑器的实际字段仍然不匹配，导致很多字段无法回显。

### AI 生成的数据（之前）

```json
{
  "description": "...",
  "sceneType": "outdoor",
  "characters": [{
    "characterId": "...",
    "characterName": "...",
    "action": "...",
    "emotion": "...",
    "position": "center"
  }],
  "dialogues": [{
    "characterId": "...",
    "text": "...",
    "speed": "normal",
    "tone": "平静"
  }],
  "camera": {
    "type": "medium",
    "movement": "static"
  },
  "visual": {
    "transition": "淡入",
    "effects": ["柔光"],
    "subtitleStyle": "标准"
  },
  "audio": {
    "bgm": "轻松舒缓",
    "soundEffects": ["研磨声"]
  }
}
```

### Client 实际需要的字段

通过检查 Client 场景编辑器组件，发现实际字段结构：

#### 1. 角色与台词 (CharacterDialogueCard)
```typescript
{
  characterId: string,  // 单个角色ID，不是数组
  actions: {
    entrance: string,   // 入场动作
    main: string,       // 主要动作
    exit: string        // 出场动作
  },
  dialogues: [{
    text: string,
    speaker: string     // 说话人名称
  }]
}
```

#### 2. 镜头与视觉 (CameraVisualCard)
```typescript
{
  camera: {
    type: 'fixed' | 'follow' | 'orbit' | 'handheld',  // 不是 closeup/medium/full/wide
    movement: 'push' | 'pull' | 'pan' | 'tilt' | 'dolly',  // 不是 static/push/pull/follow
    shotSize: 'closeup' | 'close' | 'medium' | 'full' | 'wide',  // 新增字段
    description: string  // 自定义描述
  },
  visual: {
    lighting: 'daylight' | 'night' | 'indoor' | 'golden' | 'overcast',  // 新增字段
    mood: 'warm' | 'cool' | 'vintage' | 'vibrant' | 'muted',  // 新增字段
    effects: string,  // 字符串，不是数组
    description: string  // 自定义描述
  }
}
```

#### 3. 音频设置 (AudioSettingsCard)
```typescript
{
  audio: {
    bgMusic: string,
    soundEffects: string,  // 字符串，不是数组
    volume: number  // 0-100，新增字段
  }
}
```

## 字段不匹配对比

| 字段 | AI 生成（之前） | Client 实际需要 | 状态 |
|------|----------------|----------------|------|
| **角色** | characters 数组 | characterId 单个 | ❌ 不匹配 |
| **动作** | characters[].action | actions.{entrance,main,exit} | ❌ 不匹配 |
| **台词** | dialogues[].characterId | dialogues[].speaker | ❌ 不匹配 |
| **台词** | dialogues[].speed | - | ❌ 多余字段 |
| **台词** | dialogues[].tone | - | ❌ 多余字段 |
| **镜头类型** | camera.type: closeup/medium/full/wide | camera.type: fixed/follow/orbit/handheld | ❌ 枚举值不匹配 |
| **运镜** | camera.movement: static/push/pull/follow | camera.movement: push/pull/pan/tilt/dolly | ❌ 枚举值不匹配 |
| **景别** | - | camera.shotSize | ❌ 缺失字段 |
| **镜头描述** | - | camera.description | ❌ 缺失字段 |
| **光线** | - | visual.lighting | ❌ 缺失字段 |
| **色调** | - | visual.mood | ❌ 缺失字段 |
| **视觉效果** | visual.effects: 数组 | visual.effects: 字符串 | ❌ 类型不匹配 |
| **视觉描述** | - | visual.description | ❌ 缺失字段 |
| **音效** | audio.soundEffects: 数组 | audio.soundEffects: 字符串 | ❌ 类型不匹配 |
| **音量** | - | audio.volume | ❌ 缺失字段 |

## 解决方案

### 1. 更新接口定义

**文件**: `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts`

```typescript
interface SceneContent {
  description: string;
  characterId: string; // 单个角色ID
  actions: {
    entrance: string; // 入场动作
    main: string;     // 主要动作
    exit: string;     // 出场动作
  };
  dialogues: Array<{
    text: string;
    speaker: string;
  }>;
  camera: {
    type: 'fixed' | 'follow' | 'orbit' | 'handheld';
    movement: 'push' | 'pull' | 'pan' | 'tilt' | 'dolly';
    shotSize: 'closeup' | 'close' | 'medium' | 'full' | 'wide';
    description: string;
  };
  visual: {
    lighting: 'daylight' | 'night' | 'indoor' | 'golden' | 'overcast';
    mood: 'warm' | 'cool' | 'vintage' | 'vibrant' | 'muted';
    effects: string;
    description: string;
  };
  audio: {
    bgMusic: string;
    soundEffects: string; // 字符串，不是数组
    volume: number; // 0-100
  };
}
```

### 2. 更新 AI 提示词

**关键改进**：

#### 角色与动作
```
"characterId": "主要角色ID（从角色列表中选择一个）",
"actions": {
  "entrance": "入场动作描述（如：从左侧走入、淡入画面等）",
  "main": "主要动作描述（如：坐下交谈、展示产品等）",
  "exit": "出场动作描述（如：挥手告别、淡出画面等）"
}
```

#### 台词
```
"dialogues": [
  {
    "text": "台词内容（15-30字，口语化）",
    "speaker": "说话人（角色名称）"
  }
]
```

#### 镜头
```
"camera": {
  "type": "镜头类型（fixed固定/follow跟随/orbit环绕/handheld手持）",
  "movement": "运镜方式（push推镜/pull拉镜/pan摇镜/tilt俯仰/dolly移动）",
  "shotSize": "景别（closeup特写/close近景/medium中景/full全景/wide远景）",
  "description": "自定义镜头描述"
}
```

#### 视觉
```
"visual": {
  "lighting": "光线条件（daylight日光/night夜晚/indoor室内/golden黄金时刻/overcast阴天）",
  "mood": "色调氛围（warm温暖/cool冷色/vintage复古/vibrant鲜艳/muted柔和）",
  "effects": "视觉效果描述（字符串，如：柔光、滤镜等）",
  "description": "自定义视觉描述"
}
```

#### 音频
```
"audio": {
  "bgMusic": "背景音乐类型（如：轻松舒缓、活力动感、戏剧紧张、浪漫温馨、史诗宏大等）",
  "soundEffects": "音效描述（字符串，如：脚步声、门铃声、风声等，多个用逗号分隔）",
  "volume": 70
}
```

### 3. 更新验证函数

```typescript
function isCompleteSceneContent(content: any): boolean {
  return (
    content &&
    typeof content.description === 'string' &&
    typeof content.characterId === 'string' &&
    content.actions &&
    typeof content.actions.entrance === 'string' &&
    typeof content.actions.main === 'string' &&
    typeof content.actions.exit === 'string' &&
    Array.isArray(content.dialogues) &&
    content.camera &&
    typeof content.camera.type === 'string' &&
    typeof content.camera.movement === 'string' &&
    typeof content.camera.shotSize === 'string' &&
    content.visual &&
    typeof content.visual.lighting === 'string' &&
    typeof content.visual.mood === 'string' &&
    content.audio &&
    typeof content.audio.volume === 'number'
  );
}
```

## 完整的字段映射

### 基本信息
- ✅ title - 场景标题
- ✅ duration - 场景时长
- ✅ description - 场景描述

### 角色与台词
- ✅ characterId - 主要角色ID
- ✅ actions.entrance - 入场动作
- ✅ actions.main - 主要动作
- ✅ actions.exit - 出场动作
- ✅ dialogues[].text - 台词内容
- ✅ dialogues[].speaker - 说话人

### 镜头与视觉
- ✅ camera.type - 镜头类型（fixed/follow/orbit/handheld）
- ✅ camera.movement - 运镜方式（push/pull/pan/tilt/dolly）
- ✅ camera.shotSize - 景别（closeup/close/medium/full/wide）
- ✅ camera.description - 自定义镜头描述
- ✅ visual.lighting - 光线条件（daylight/night/indoor/golden/overcast）
- ✅ visual.mood - 色调氛围（warm/cool/vintage/vibrant/muted）
- ✅ visual.effects - 视觉效果（字符串）
- ✅ visual.description - 自定义视觉描述

### 音频设置
- ✅ audio.bgMusic - 背景音乐
- ✅ audio.soundEffects - 音效（字符串）
- ✅ audio.volume - 音量（0-100）

## 测试验证

### TypeScript 编译
```bash
✓ 无 generate-scenes 相关编译错误
```

### 预期效果

现在 AI 生成的数据应该能完全匹配 Client 场景编辑器的所有字段：

1. ✅ **基本信息卡片**: 标题、描述、时长全部显示
2. ✅ **角色与台词卡片**: 角色选择、入场/主要/出场动作、台词列表全部显示
3. ✅ **镜头与视觉卡片**: 镜头类型、运镜方式、景别、光线、色调、效果全部显示
4. ✅ **音频设置卡片**: 背景音乐、音效、音量全部显示

## 用户体验提升

**之前**：
- 用户需要手动填写大量字段
- AI 生成的数据只有部分字段能回显
- 用户需要大量手动调整

**现在**：
- AI 生成完整的场景数据
- 所有字段都能正确回显
- 用户只需微调即可，大大减少工作量

## 总结

通过仔细检查 Client 场景编辑器的实际字段结构，完全重写了 AI 提示词和接口定义，确保 AI 生成的数据与 Client 完全匹配。

**关键改进**：
1. ✅ 角色从数组改为单个 characterId
2. ✅ 动作从单个字段改为 entrance/main/exit 三个字段
3. ✅ 镜头类型和运镜方式的枚举值完全匹配
4. ✅ 新增 shotSize、lighting、mood 等字段
5. ✅ effects 和 soundEffects 从数组改为字符串
6. ✅ 新增 volume 字段

现在 AI 生成的场景数据可以 100% 匹配 Client 场景编辑器的所有字段，实现了"AI 全部生成，用户只需微调"的目标。
