# 视频生成失败状态处理修复

**日期**: 2026-01-29
**类型**: Bug 修复
**影响范围**: 视频生成功能

## 问题描述

视频生成任务失败后，系统仍然持续轮询任务状态，没有正确识别失败状态并停止轮询。

### 具体表现

1. API 返回任务状态为 `FAILURE`，但系统未能识别
2. 轮询持续进行，不断请求已失败的任务
3. 用户无法得知任务失败的原因

### 根本原因

1. **状态解析问题**: `VideoClient.parseTaskStatus` 方法只检查 `"failed"` 状态，但 API 返回的是 `"FAILURE"`（大写）
2. **接口格式不统一**: API 使用统一接口格式（NOT_START, IN_PROGRESS, SUCCESS, FAILURE），但代码未适配
3. **错误消息提取不完整**: 未正确提取 API 返回的 `fail_reason` 字段

## 修复方案

### 1. 更新状态解析逻辑

**文件**: `web/src/lib/ai/video-client.ts`

更新 `parseTaskStatus` 方法，支持统一接口格式：

```typescript
private parseTaskStatus(rawStatus: string): TaskStatus {
  const status = rawStatus.toUpperCase();

  // 统一接口格式
  if (status === "NOT_START") return "pending";
  if (status === "IN_PROGRESS") return "processing";
  if (status === "SUCCESS") return "completed";
  if (status === "FAILURE") return "failed";

  // 兼容其他常见格式
  const lowerStatus = rawStatus.toLowerCase();
  if (["pending", "queued", "submitted"].includes(lowerStatus)) return "pending";
  if (["processing", "running", "in_progress"].includes(lowerStatus)) return "processing";
  if (["completed", "succeeded", "success", "done"].includes(lowerStatus)) return "completed";
  if (["failed", "failure", "error", "cancelled"].includes(lowerStatus)) return "failed";

  return "processing";
}
```

### 2. 改进错误消息提取

更新 `parseTaskResult` 方法，优先提取 `fail_reason` 字段：

```typescript
private parseTaskResult(data: unknown, taskId: string): VideoTaskResult {
  // ... 其他代码 ...

  // 提取错误消息：优先使用 fail_reason，其次是 message
  let message = getByPath(data, "message") as string | undefined;
  if (status === "failed") {
    const failReason = getByPath(data, "fail_reason") as string | undefined;
    message = failReason || message || "任务执行失败";
  }

  return {
    taskId,
    status,
    // ... 其他字段 ...
    message,
    raw: data,
  };
}
```

### 3. 修正 bltcy 配置

**文件**: `web/src/lib/ai/types/index.ts`

修正视频 URL 路径配置：

```typescript
bltcy: {
  // ... 其他配置 ...
  videoUrlPath: "data.output",  // 从 "video_url" 改为 "data.output"
}
```

## 统一接口格式规范

API 返回的状态枚举：

| API 状态 | 内部状态 | 说明 |
|---------|---------|------|
| NOT_START | pending | 未开始 |
| IN_PROGRESS | processing | 正在执行 |
| SUCCESS | completed | 执行完成 |
| FAILURE | failed | 失败 |

## 测试验证

### 测试场景

1. 提交视频生成任务
2. 任务失败（如网络请求失败）
3. 验证系统行为：
   - ✅ 正确识别 FAILURE 状态
   - ✅ 停止轮询
   - ✅ 更新数据库状态为 failed
   - ✅ 显示失败原因给用户

### API 响应示例

```json
{
  "task_id": "video_26d52fd3-17d6-4f5a-844f-7ba7a69f3a46",
  "platform": "openai",
  "action": "sora-video",
  "status": "FAILURE",
  "fail_reason": "网络请求失败",
  "submit_time": 1769625329,
  "start_time": 1769625349,
  "finish_time": 1769625489,
  "progress": "100%",
  "data": {
    "output": ""
  },
  "cost": 0
}
```

## 影响范围

- ✅ 单场景视频生成
- ✅ 故事板模式视频生成
- ✅ 所有使用 VideoClient 的功能

## 相关文件

- `web/src/lib/ai/video-client.ts` - 视频客户端核心逻辑
- `web/src/lib/ai/types/index.ts` - 类型定义和配置
- `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts` - 视频生成 API

## 后续优化建议

1. 添加重试机制：对于网络失败等临时性错误，可以自动重试
2. 增强错误分类：区分永久性失败和临时性失败
3. 用户通知：失败时通过 WebSocket 或轮询通知前端更新 UI
4. 日志记录：记录详细的失败信息用于问题排查
