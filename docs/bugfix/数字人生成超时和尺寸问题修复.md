# 数字人生成超时和尺寸问题修复（第二次）

## 问题描述

用户测试后报告了两个问题：

1. **生成超时**：提示"生成超时，请刷新页面查看结果"
2. **竖屏比例未生效**：选择竖屏后，生成的图片仍然不是竖屏比例

## 问题分析

### 问题1：生成超时

**原因**：
- 前端轮询机制设置为最多 30 次，每次等待 2 秒，总共 60 秒
- AI 图片生成（特别是高质量图片）可能需要超过 60 秒
- 超时后虽然前端报错，但后端可能仍在生成，导致用户刷新后能看到结果

**代码位置**：
- `client/src/components/project/CharacterDetailEditor.tsx:147-149`

### 问题2：竖屏比例未生效

**根本原因**：
- bltcy API 使用的是 Chat Completions 格式（`/v1/chat/completions`）
- 这种格式**不支持标准的 `size` 参数**
- 虽然我们在请求体中添加了 `size` 参数，但 bltcy API 可能忽略了这个参数
- 需要在 **prompt 中包含尺寸和方向信息**，让 AI 理解生成的图片应该是什么比例

**代码位置**：
- `web/src/lib/ai/image-generator.ts:132` - 添加了 `size` 参数，但可能被 API 忽略
- `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts:233-245` - 构建提示词的函数

## 解决方案

### 解决方案1：增加轮询超时时间

将轮询时间从 60 秒增加到 180 秒（3 分钟），给 AI 生成更多时间。

**修改文件**：`client/src/components/project/CharacterDetailEditor.tsx`

```typescript
// 修改前
// 轮询查询结果（每2秒查询一次，最多查询30次 = 60秒）
let attempts = 0;
const maxAttempts = 30;

while (attempts < maxAttempts) {
  await new Promise(resolve => setTimeout(resolve, 2000)); // 等待2秒
  // ...
}

// 修改后
// 轮询查询结果（每3秒查询一次，最多查询60次 = 180秒 = 3分钟）
let attempts = 0;
const maxAttempts = 60;

while (attempts < maxAttempts) {
  await new Promise(resolve => setTimeout(resolve, 3000)); // 等待3秒
  // ...
}
```

**优点**：
- 给 AI 生成更多时间，减少超时错误
- 轮询间隔从 2 秒增加到 3 秒，减少服务器压力

### 解决方案2：在 Prompt 中包含尺寸信息

由于 bltcy API 可能不支持标准的 `size` 参数，我们在 prompt 中添加方向和比例信息，让 AI 理解应该生成什么比例的图片。

**修改文件**：`web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts`

#### 2.1 修改函数调用

```typescript
// 修改前
const prompt = buildDigitalHumanPrompt(
  character.name,
  character.description,
  character.avatarUrl
);

// 修改后
const prompt = buildDigitalHumanPrompt(
  character.name,
  character.description,
  character.avatarUrl,
  size  // 传递 size 参数
);
```

#### 2.2 修改函数定义

```typescript
// 修改前
function buildDigitalHumanPrompt(
  name: string,
  description: string,
  referenceImageUrl?: string | null
): string {
  let prompt = `professional portrait of ${name}, ${description}, `;
  prompt += "high quality, detailed, 4k, studio lighting, ";
  prompt += "professional photography, realistic, ";
  prompt += "front facing, neutral expression, ";
  prompt += "clean background";

  return prompt;
}

// 修改后
function buildDigitalHumanPrompt(
  name: string,
  description: string,
  referenceImageUrl?: string | null,
  size?: string
): string {
  let prompt = `professional portrait of ${name}, ${description}, `;
  prompt += "high quality, detailed, 4k, studio lighting, ";
  prompt += "professional photography, realistic, ";
  prompt += "front facing, neutral expression, ";
  prompt += "clean background";

  // 根据尺寸添加方向提示
  if (size) {
    if (size === "1792x1024") {
      prompt += ", landscape orientation, wide format, 16:9 aspect ratio";
    } else if (size === "1024x1792") {
      prompt += ", portrait orientation, vertical format, 9:16 aspect ratio";
    }
  }

  return prompt;
}
```

**关键点**：
- 横屏（1792x1024）：添加 "landscape orientation, wide format, 16:9 aspect ratio"
- 竖屏（1024x1792）：添加 "portrait orientation, vertical format, 9:16 aspect ratio"
- 这些关键词帮助 AI 理解应该生成什么比例的图片

## 修改文件清单

1. **client/src/components/project/CharacterDetailEditor.tsx**
   - 增加轮询超时时间：从 60 秒增加到 180 秒
   - 增加轮询间隔：从 2 秒增加到 3 秒

2. **web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts**
   - 修改 `buildDigitalHumanPrompt` 函数，添加 `size` 参数
   - 在 prompt 中根据尺寸添加方向和比例信息
   - 调用 `buildDigitalHumanPrompt` 时传递 `size` 参数

## 验证方法

### 测试步骤

1. 重启 web 服务（确保后端代码生效）
2. 打开项目详情页面
3. 创建或编辑一个角色
4. 在数字人生成器中选择"横屏 16:9"
5. 点击"生成角色数字人"按钮
6. 等待生成完成（最多 3 分钟）
7. 检查生成的图片是否为横屏比例

### 预期结果

**超时问题**：
- 生成时间在 3 分钟内的应该能正常完成
- 不再频繁出现"生成超时"错误
- 如果确实超过 3 分钟，仍会提示超时，但这种情况应该很少见

**尺寸问题**：
- 选择"竖屏 9:16"时，生成的图片应该是竖向的
- 选择"横屏 16:9"时，生成的图片应该是横向的
- prompt 中会包含方向和比例信息

### 日志验证

修复后，控制台应该显示：

```
[callBltcyImageAPI] 模型: flux-pro 数量: 1 尺寸: 1792x1024
[callBltcyImageAPI] 开始生成第 1/1 张图片...
```

生成的 prompt 应该类似：
```
professional portrait of 父亲, 小狗, high quality, detailed, 4k, studio lighting, professional photography, realistic, front facing, neutral expression, clean background, landscape orientation, wide format, 16:9 aspect ratio
```

## 技术要点

### 1. bltcy API 的特殊性

bltcy 使用 Chat Completions 格式，与标准的 DALL-E API 不同：
- **标准 DALL-E API**：`/v1/images/generations`，支持 `size` 参数
- **bltcy API**：`/v1/chat/completions`，可能不支持标准的 `size` 参数

因此，我们采用双重策略：
1. 在请求体中添加 `size` 参数（如果 API 支持）
2. 在 prompt 中添加方向和比例信息（确保 AI 理解）

### 2. Prompt Engineering

在 prompt 中添加方向和比例信息是一种常见的 Prompt Engineering 技巧：
- "landscape orientation" - 告诉 AI 生成横向图片
- "portrait orientation" - 告诉 AI 生成竖向图片
- "16:9 aspect ratio" - 明确指定比例
- "wide format" / "vertical format" - 强化方向概念

### 3. 轮询策略优化

轮询参数的权衡：
- **轮询间隔**：太短会增加服务器压力，太长会延迟用户看到结果
- **最大次数**：太少会导致超时，太多会让用户等待过久
- **当前设置**：3 秒 × 60 次 = 180 秒，是一个合理的平衡点

### 4. 用户体验考虑

- 即使超时，后端仍在生成，用户刷新后能看到结果
- 可以考虑添加进度提示，让用户知道正在生成中
- 可以考虑添加"后台生成"功能，让用户不必等待

## 已知限制

1. **API 支持不确定**：
   - 如果 bltcy API 完全不支持尺寸控制，即使在 prompt 中添加信息也可能效果有限
   - 可能需要联系 bltcy 确认 API 的具体支持情况

2. **生成时间不可控**：
   - AI 生成时间取决于服务器负载和图片复杂度
   - 3 分钟的超时时间可能仍然不够

3. **Prompt 效果依赖 AI 模型**：
   - 不同的 AI 模型对 prompt 中的方向和比例信息的理解程度不同
   - 可能需要根据实际效果调整 prompt

## 后续优化建议

1. **添加进度提示**：
   - 在前端显示生成进度（如"已等待 30 秒，预计还需 1-2 分钟"）
   - 让用户知道系统正在工作

2. **后台生成模式**：
   - 允许用户关闭编辑器，后台继续生成
   - 生成完成后通过通知提醒用户

3. **API 文档确认**：
   - 联系 bltcy 确认 API 是否支持 `size` 参数
   - 如果支持，确认正确的参数格式

4. **A/B 测试**：
   - 测试不同的 prompt 格式，找到最有效的方向和比例描述
   - 收集用户反馈，优化 prompt

5. **错误处理优化**：
   - 如果超时，提供更友好的错误提示
   - 提供"继续等待"或"后台生成"的选项

## 相关文件

- `client/src/components/project/CharacterDetailEditor.tsx` - 轮询逻辑
- `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts` - 后端生成 API
- `web/src/lib/ai/image-generator.ts` - 图片生成服务
