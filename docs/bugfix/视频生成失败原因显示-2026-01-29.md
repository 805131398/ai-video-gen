# 视频生成失败原因显示

## 问题描述

1. 视频生成失败时，`fail_reason` 没有正确保存和显示
2. 前端视频列表页面没有显示失败原因
3. Sora 视频时长只支持特定枚举值（5s, 10s, 15s, 20s），需要智能判断
4. 失败的视频无法查看生成参数

## 修复内容

### 1. 后端修复

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

- 修复 Prisma 模型名称：`prisma.characterDigitalHuman` → `prisma.digitalHuman`
- 添加调试日志用于排查角色形象获取问题
- **新增**: Sora 视频时长智能判断，自动选择最接近的有效时长（5s, 10s, 15s, 20s）

```typescript
// 计算视频时长（Sora 只支持 5s, 10s, 15s, 20s）
const requestedDuration = body.duration || scene.duration || 10;
const validDurations = [5, 10, 15, 20];
// 选择最接近的有效时长
const finalDuration = validDurations.reduce((prev, curr) =>
  Math.abs(curr - requestedDuration) < Math.abs(prev - requestedDuration) ? curr : prev
);
```

**文件**: `web/src/lib/ai/video-client.ts`

后端已正确处理 `fail_reason`（第 241-246 行）：
```typescript
// 提取错误消息：优先使用 fail_reason，其次是 message
let message = getByPath(data, "message") as string | undefined;
if (status === "failed") {
  const failReason = getByPath(data, "fail_reason") as string | undefined;
  message = failReason || message || "任务执行失败";
}
```

### 2. 前端修复

**文件**: `client/src/pages/SceneVideos.tsx`

1. 添加 `AlertCircle` 图标导入
2. 修改 `getStatusLabel` 函数，支持显示错误信息的 tooltip
3. 失败状态的视频卡片显示红色背景和失败图标
4. 在视频卡片信息区域显示失败原因（最多 2 行，hover 显示全部）
5. **失败状态的视频支持"查看详情"和"重新生成"操作**

**文件**: `client/src/components/scene-videos/VideoDetailDrawer.tsx`

已有失败原因显示功能：
- 视频播放器区域显示失败信息
- 独立的"错误信息"区块显示详细失败原因
- 显示生成参数（提示词、故事板格式、角色形象等）

## UI 设计

### 视频卡片失败状态

- 缩略图区域：红色背景 + AlertCircle 图标 + "生成失败" 文字
- 状态标签：红色背景 + AlertCircle 图标 + "失败" 文字（hover 显示完整错误信息）
- 错误信息：红色文字，最多显示 2 行，hover 显示完整内容
- 悬停操作：显示"查看详情"、"重新生成"和"删除"按钮

### 视频详情抽屉

- 视频播放器区域显示失败信息和错误原因
- 基本信息区块：时长、状态、生成时间、是否选中
- 生成参数区块：提示词类型、故事板格式、角色形象、宽高比、高清
- 提示词区块：显示完整的生成提示词
- 独立的红色背景"错误信息"区块
- 底部操作按钮包含"重新生成"和"删除"

## 时长智能判断规则

Sora 仅支持 **10s** 和 **15s** 两种时长。

| 请求时长 | 实际使用 |
|---------|---------|
| ≤12s    | 10s     |
| >12s    | 15s     |

前端会在生成对话框中显示：
- 场景设置的时长
- 系统将使用的实际时长（10s 或 15s）
- 提示文字："Sora 仅支持 10s 和 15s，系统将自动选择最接近的时长"

## 测试

1. 触发视频生成失败
2. 检查视频列表页面是否显示失败原因
3. 点击失败视频的"查看详情"按钮，确认能看到生成参数
4. 检查视频详情抽屉是否显示失败原因和生成参数
5. 测试重新生成功能
6. 测试不同时长的智能判断（如 12s → 10s, 13s → 15s）
