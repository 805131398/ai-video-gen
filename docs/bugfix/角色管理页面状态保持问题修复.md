# 角色管理页面状态保持问题修复

## 问题描述

在 client 工程的角色管理功能中存在两个问题：

1. **点击"生成角色数字人"按钮后返回列表页面**
   - 用户在编辑角色时点击"生成角色数字人"按钮
   - 如果有未保存的修改，系统会先保存角色
   - 保存成功后，编辑器会自动关闭，用户被带回到角色列表页面
   - 这导致用户无法看到数字人生成的过程和结果

2. **刷新页面后丢失编辑状态**
   - 用户在新增或编辑角色时刷新页面
   - 由于编辑状态存储在 React state 中，刷新后状态丢失
   - 页面回到初始状态，显示角色列表
   - 用户需要重新点击编辑按钮

## 根本原因分析

### 问题1：生成数字人后关闭编辑器

**代码位置**：
- `client/src/components/project/CharacterDetailEditor.tsx:114`
- `client/src/pages/ProjectDetail.tsx:92-94`

**原因**：
在 `CharacterDetailEditor` 的 `handleGenerateDigitalHumans` 函数中，当检测到未保存的修改时，会调用 `onSubmit` 保存角色。而 `ProjectDetail` 的 `handleSubmitCharacter` 函数在保存成功后会无条件地关闭编辑器。

```typescript
// CharacterDetailEditor.tsx
await onSubmit({
  name: name.trim(),
  description: description.trim(),
  avatarUrl: referenceImageUrl || undefined,
});

// ProjectDetail.tsx
await loadData();
setShowDetailEditor(false);  // 总是关闭编辑器
setEditingCharacter(undefined);
```

### 问题2：刷新页面丢失状态

**原因**：
编辑状态（`showDetailEditor`、`editingCharacter`）存储在 React state 中，刷新页面后这些状态会重置为初始值。没有使用 URL 参数或其他持久化方式来保存编辑状态。

## 解决方案

### 1. 添加 `keepEditorOpen` 参数

修改 `handleSubmitCharacter` 函数，添加可选参数 `keepEditorOpen`，控制保存后是否关闭编辑器。

**修改文件**：`client/src/pages/ProjectDetail.tsx`

```typescript
const handleSubmitCharacter = async (
  data: CreateCharacterRequest,
  keepEditorOpen = false
) => {
  if (!id) return;
  try {
    let savedCharacter: ProjectCharacter;

    if (editingCharacter) {
      savedCharacter = await updateCharacter(id, editingCharacter.id, data);
    } else {
      savedCharacter = await createCharacter(id, data);
    }

    await loadData();

    // 根据参数决定是否关闭编辑器
    if (keepEditorOpen) {
      setEditingCharacter(savedCharacter);  // 更新为最新数据
      setSearchParams({ action: 'edit', characterId: savedCharacter.id });
    } else {
      setShowDetailEditor(false);
      setEditingCharacter(undefined);
      setSearchParams({});
    }
  } catch (err: any) {
    throw err;
  }
};
```

