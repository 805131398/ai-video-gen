# 单场景故事板视频生成 - 支持角色数字人形象

**日期**: 2026-01-29
**类型**: 功能新增
**影响范围**: Web API - 单场景视频生成

## 功能概述

创建专门的单场景故事板视频生成接口，自动构建故事板格式的 prompt，并支持使用角色的数字人形象作为参考图进行图生视频。

## 核心特性

### 1. 自动故事板格式
- 自动将场景内容转换为故事板格式
- 包含场景描述、动作、镜头、视觉效果、对话等
- 格式符合 bltcy API 要求

### 2. 角色数字人形象支持
- 自动获取场景主要角色的数字人形象
- 优先使用已选中的数字人形象
- 降级到角色头像
- 作为参考图传递给 bltcy API（图生视频）

### 3. 智能 Prompt 构建
- 综合场景的多个维度信息
- 自动组合描述、动作、镜头、视觉、对话
- 生成连贯的场景描述

## API 接口

### 端点
```
POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video-storyboard
```

### 请求参数
```typescript
{
  "aspectRatio"?: string;        // 宽高比，默认 "16:9"
  "useCharacterImage"?: boolean; // 是否使用角色形象，默认 true
}
```

### 响应
```json
{
  "success": true,
  "message": "故事板视频生成任务已提交",
  "videoId": "video-id",
  "taskId": "task-id",
  "sceneId": "scene-id",
  "sceneTitle": "场景标题",
  "storyboardPrompt": "Shot 1:\nduration: 10sec\nScene: ...",
  "referenceImage": "https://example.com/character.jpg"
}
```

## 故事板 Prompt 构建逻辑

### 输入（场景内容）
```json
{
  "description": "昏黄的夕阳透过窗户，洒在略显凌乱的餐桌上",
  "characterId": "character-1",
  "actions": {
    "main": "父亲颤抖着手从兜里掏出半块点心塞进嘴里"
  },
  "camera": {
    "description": "镜头从窗外的夕阳缓缓推向父亲颤抖的双手"
  },
  "visual": {
    "description": "夕阳的光影感极强，营造出一种无奈而沉重的氛围"
  },
  "dialogues": [
    {
      "speaker": "父亲",
      "text": "就吃这一小口，应该没事吧……"
    }
  ]
}
```

### 输出（故事板格式）
```
Shot 1:
duration: 12sec
Scene: 昏黄的夕阳透过窗户，洒在略显凌乱的餐桌上。父亲颤抖着手从兜里掏出半块点心塞进嘴里。Camera: 镜头从窗外的夕阳缓缓推向父亲颤抖的双手。Visual: 夕阳的光影感极强，营造出一种无奈而沉重的氛围。父亲: "就吃这一小口，应该没事吧……"
```

## 角色数字人形象获取逻辑

### 优先级
1. **已选中的数字人形象**: `CharacterDigitalHuman.imageUrl` (where `isSelected = true`)
2. **角色头像**: `Character.avatarUrl`
3. **无参考图**: `undefined`（纯文生视频）

### 代码实现
```typescript
async function getCharacterImage(
  scene: any,
  characters: any[]
): Promise<string | undefined> {
  const characterId = scene.content.characterId;

  if (!characterId) {
    return undefined;
  }

  const character = characters.find((c) => c.id === characterId);
  if (!character) {
    return undefined;
  }

  // 优先使用已选中的数字人形象
  const digitalHuman = await prisma.characterDigitalHuman.findFirst({
    where: {
      characterId: character.id,
      isSelected: true,
    },
  });

  return digitalHuman?.imageUrl || character.avatarUrl || undefined;
}
```

## 使用示例

### 1. 使用角色形象生成视频（默认）
```typescript
POST /api/projects/{projectId}/scripts/{scriptId}/scenes/{sceneId}/generate-video-storyboard
{
  "aspectRatio": "16:9"
}
```

### 2. 不使用角色形象（纯文生视频）
```typescript
POST /api/projects/{projectId}/scripts/{scriptId}/scenes/{sceneId}/generate-video-storyboard
{
  "aspectRatio": "9:16",
  "useCharacterImage": false
}
```

### 3. 竖屏视频 + 角色形象
```typescript
POST /api/projects/{projectId}/scripts/{scriptId}/scenes/{sceneId}/generate-video-storyboard
{
  "aspectRatio": "9:16",
  "useCharacterImage": true
}
```

## 与其他接口的对比

### 1. `/scenes/[sceneId]/generate-video`（原接口）
- **特点**: 基础视频生成
- **Prompt**: 手动构建或使用 `buildVideoPrompt`
- **参考图**: 需要手动传入
- **适用**: 需要精细控制 prompt 的场景

### 2. `/scenes/[sceneId]/generate-video-storyboard`（新接口）
- **特点**: 自动故事板格式
- **Prompt**: 自动构建故事板格式
- **参考图**: 自动获取角色数字人形象
- **适用**: 快速生成，利用角色形象

### 3. `/scripts/[scriptId]/generate-videos`（批量接口）
- **特点**: 批量生成（individual/storyboard 模式）
- **Prompt**: 批量构建
- **参考图**: 不支持
- **适用**: 一次性生成多个场景

## 优势

### 1. 自动化
- 无需手动构建故事板格式
- 自动获取角色形象
- 减少前端工作量

### 2. 角色一致性
- 使用角色的数字人形象作为参考
- 确保生成的视频中角色形象一致
- 提高视频质量

### 3. 灵活性
- 可选择是否使用角色形象
- 支持不同宽高比
- 保留原有接口，不影响现有功能

## 数据存储

### SceneVideo 记录
```json
{
  "sceneId": "scene-id",
  "videoUrl": "https://...",
  "prompt": "Shot 1:\nduration: 10sec\nScene: ...",
  "promptType": "storyboard_auto",
  "status": "completed",
  "metadata": {
    "mode": "storyboard",
    "useCharacterImage": true,
    "referenceImage": "https://..."
  }
}
```

## 技术要点

### 1. Prompt 构建
- 综合场景的多个维度
- 保持描述的连贯性
- 符合故事板格式要求

### 2. 图片获取
- 异步查询数字人形象
- 降级策略确保可用性
- 支持可选参数控制

### 3. 状态管理
- 与其他接口一致的轮询机制
- 完善的错误处理
- 元数据记录生成方式

## 测试建议

1. **基础功能测试**:
   - 测试有角色的场景
   - 测试无角色的场景
   - 测试不同宽高比

2. **角色形象测试**:
   - 测试有数字人形象的角色
   - 测试只有头像的角色
   - 测试无形象的角色

3. **Prompt 质量测试**:
   - 检查生成的故事板格式
   - 验证描述的完整性
   - 对比生成的视频质量

4. **边界测试**:
   - 测试场景内容不完整的情况
   - 测试角色不存在的情况
   - 测试 API 失败的情况

## 相关文件

### 新增文件
- `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video-storyboard/route.ts`

### 依赖文件
- `web/src/lib/ai/video-client.ts` - bltcy 视频客户端
- `web/src/lib/services/ai-config-service.ts` - AI 配置服务
- `web/prisma/schema.prisma` - 数据模型

## 总结

本次实施创建了专门的单场景故事板视频生成接口：

- ✅ 自动构建故事板格式 prompt
- ✅ 自动获取角色数字人形象
- ✅ 支持图生视频
- ✅ 灵活的参数控制
- ✅ 完善的错误处理

这个接口为用户提供了更便捷的视频生成方式，特别是在需要保持角色形象一致性的场景中。
