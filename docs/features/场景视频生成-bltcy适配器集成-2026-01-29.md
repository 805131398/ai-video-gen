# 场景视频生成 - 使用 bltcy 视频适配器

**日期**: 2026-01-29
**类型**: 功能优化
**影响范围**: Web API - 场景视频生成

## 功能概述

将场景视频生成功能从通用的 `/api/ai/videos` 接口迁移到专门的场景视频生成接口，并使用 bltcy 视频适配器，支持更完整的参数配置（提示词、参考图、宽高比、时长等）。

## 实施内容

### 1. 新增单场景视频生成接口

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

**端点**: `POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video`

**功能**:
- 为单个场景生成视频
- 使用 bltcy 视频适配器
- 支持完整的参数配置

**请求参数**:
```typescript
{
  promptType?: "smart_combine" | "ai_optimized";  // Prompt 构建方式
  referenceImage?: string;  // 参考图 URL（图生视频）
  aspectRatio?: string;     // 宽高比，如 "16:9", "9:16", "1:1"
  duration?: number;        // 时长（秒）
  hd?: boolean;             // 是否高清
}
```

**响应**:
```typescript
{
  success: true,
  message: "视频生成任务已提交",
  videoId: string,    // 视频记录 ID
  taskId: string,     // bltcy 任务 ID
  sceneId: string,    // 场景 ID
  sceneTitle: string  // 场景标题
}
```

**工作流程**:
1. 验证用户身份和场景权限
2. 构建视频生成 prompt
3. 获取 bltcy 视频配置
4. 创建视频记录（状态为 pending）
5. 调用 bltcy 视频适配器提交任务
6. 更新任务 ID 和状态（generating）
7. 启动后台轮询任务
8. 返回任务信息

**后台轮询**:
- 轮询间隔：5 秒
- 最大轮询次数：120 次（10 分钟）
- 状态检查：pending/processing → 继续轮询，completed → 更新视频 URL，failed → 标记失败

### 2. 优化批量视频生成接口

**文件**: `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts`

**端点**: `POST /api/projects/[id]/scripts/[scriptId]/generate-videos`

**修改内容**:
- 从模拟的 `generateVideos` 函数改为使用 bltcy 视频适配器
- 添加 `aspectRatio` 参数支持
- 为每个场景独立调用 bltcy API
- 实现后台轮询机制

**新增参数**:
```typescript
{
  promptType?: "smart_combine" | "ai_optimized";
  sceneIds?: string[];    // 可选：指定要生成视频的场景 ID
  aspectRatio?: string;   // 宽高比，默认 "16:9"
}
```

**优化点**:
1. **真实 API 调用**: 使用 bltcy 视频适配器而不是模拟数据
2. **参数传递**: 支持场景时长、宽高比等参数
3. **状态轮询**: 实时查询视频生成状态
4. **错误处理**: 完善的超时和失败处理

## 参数说明

### 1. 提示词（prompt）
- 自动从场景内容构建
- 支持两种构建方式：
  - `smart_combine`: 智能组合场景字段
  - `ai_optimized`: AI 优化 prompt

### 2. 参考图（referenceImage）
- 可选参数
- 用于图生视频场景
- 传入图片 URL，bltcy 会基于图片生成视频

### 3. 宽高比（aspectRatio）
- 默认值：`"16:9"`
- 支持的值：
  - `"16:9"`: 横屏视频（常用于 YouTube、电视）
  - `"9:16"`: 竖屏视频（常用于抖音、快手）
  - `"1:1"`: 方形视频（常用于 Instagram）
  - 其他自定义比例

### 4. 时长（duration）
- 优先级：请求参数 > 场景时长 > 默认值（10 秒）
- 单位：秒
- bltcy API 接收字符串格式

### 5. 高清（hd）
- 根据 AI 配置中的 `defaultResolution` 自动设置
- `1080p` 或 `hd` → `hd: true`
- 其他 → `hd: false`

## bltcy 视频适配器集成

### 配置获取
```typescript
const videoConfig = await getAIConfig("video", user.tenantId);
```

### 客户端创建
```typescript
const videoClient = createVideoClient({
  apiUrl: videoConfig.apiUrl,
  apiKey: videoConfig.apiKey,
  modelName: videoConfig.modelName,
  config: videoConfig.config as any,
});
```

### 任务提交
```typescript
const result = await videoClient.submit({
  prompt,                    // 视频生成提示词
  imageUrl: referenceImage,  // 参考图（可选）
  duration,                  // 时长（秒）
  aspectRatio,               // 宽高比
});
```

### 状态查询
```typescript
const status = await videoClient.getStatus(taskId);
// status.status: "pending" | "processing" | "completed" | "failed"
// status.videoUrl: 生成的视频 URL（completed 时）
// status.thumbnailUrl: 缩略图 URL（可选）
// status.duration: 视频时长
```

## 数据流程

```
Client 请求
    ↓
API 接口（验证权限）
    ↓
构建 Prompt（buildVideoPrompt）
    ↓
获取 AI 配置（getAIConfig）
    ↓
创建视频记录（SceneVideo，status: pending）
    ↓
创建 bltcy 客户端（createVideoClient）
    ↓
提交任务（videoClient.submit）
    ↓
更新任务 ID（status: generating）
    ↓
后台轮询（每 5 秒查询一次）
    ↓
状态更新（completed/failed）
    ↓
更新视频 URL 和元数据
```

## 使用示例

### 1. 单场景视频生成

```typescript
// 文生视频
POST /api/projects/{projectId}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "promptType": "smart_combine",
  "aspectRatio": "16:9",
  "duration": 10
}

// 图生视频
POST /api/projects/{projectId}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "promptType": "smart_combine",
  "referenceImage": "https://example.com/image.jpg",
  "aspectRatio": "9:16",
  "duration": 15
}
```

### 2. 批量视频生成

```typescript
// 为所有场景生成视频
POST /api/projects/{projectId}/scripts/{scriptId}/generate-videos
{
  "promptType": "smart_combine",
  "aspectRatio": "16:9"
}

// 为指定场景生成视频
POST /api/projects/{projectId}/scripts/{scriptId}/generate-videos
{
  "promptType": "ai_optimized",
  "sceneIds": ["scene-id-1", "scene-id-2"],
  "aspectRatio": "9:16"
}
```

## 优势

### 1. 真实 API 集成
- 使用 bltcy 真实视频生成服务
- 不再依赖模拟数据
- 支持生产环境部署

### 2. 参数灵活性
- 支持参考图（图生视频）
- 支持自定义宽高比
- 支持自定义时长
- 支持高清选项

### 3. 状态管理
- 实时轮询任务状态
- 完善的错误处理
- 超时保护机制

### 4. 可扩展性
- 易于添加新参数
- 易于切换其他视频提供商
- 统一的视频客户端接口

## 待完善事项

1. **参考图字段**:
   - 场景数据结构中暂无 `referenceImage` 字段
   - 建议在 `SceneContent` 中添加 `referenceImage?: string`
   - 或者在场景编辑器中添加参考图上传功能

2. **进度回调**:
   - 当前使用轮询方式查询状态
   - 可以考虑使用 Webhook 接收实时通知

3. **批量优化**:
   - 当前批量生成是串行处理
   - 可以考虑并行提交任务，提高效率

4. **重试机制**:
   - 失败任务可以添加自动重试
   - 或者提供手动重试接口

5. **缓存机制**:
   - 相同 prompt 的视频可以复用
   - 减少重复生成，节省成本

## 测试建议

1. **单场景生成测试**:
   - 测试文生视频（仅 prompt）
   - 测试图生视频（prompt + referenceImage）
   - 测试不同宽高比（16:9, 9:16, 1:1）
   - 测试不同时长（5s, 10s, 15s）

2. **批量生成测试**:
   - 测试全部场景生成
   - 测试指定场景生成
   - 测试大量场景（10+ 个）的性能

3. **状态轮询测试**:
   - 验证状态正确更新
   - 验证超时处理
   - 验证失败处理

4. **边界情况测试**:
   - 无效的场景 ID
   - 未配置 bltcy 服务
   - API Key 无效
   - 网络超时

## 相关文件

### 新增文件
- `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

### 修改文件
- `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts`

### 依赖文件
- `web/src/lib/ai/video-client.ts` - bltcy 视频客户端
- `web/src/lib/services/video-prompt-builder.ts` - Prompt 构建服务
- `web/src/lib/services/ai-config-service.ts` - AI 配置服务
- `web/prisma/schema.prisma` - SceneVideo 数据模型

## 总结

本次实施完成了场景视频生成功能与 bltcy 视频适配器的集成：

- ✅ 新增单场景视频生成接口
- ✅ 优化批量视频生成接口
- ✅ 支持完整的参数配置（提示词、参考图、宽高比、时长）
- ✅ 实现后台轮询机制
- ✅ 完善的错误处理和超时保护
- ✅ 统一使用 bltcy 视频适配器

功能已完整实现，可以进行测试和验证。
