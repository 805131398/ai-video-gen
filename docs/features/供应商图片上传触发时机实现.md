# 供应商图片上传触发时机实现

> 日期: 2026-02-14

## 实现内容

在视频生成页面（SceneVideoGenerate）点击"开始生成视频"按钮时，如果开启了"角色形象作为参考图"选项，自动检查参考图片 URL 是否可被 AI 供应商访问，不可访问时自动上传到供应商图片托管服务获取新 URL。

## 修改文件

### Electron 主进程
- `client/electron/main.ts` — 新增 `resources:readFileInfo` IPC handler，读取本地文件返回 base64、SHA-256 hash、size、mimeType
- `client/electron/preload.ts` — 暴露 `readFileInfo` 方法到渲染进程

### 客户端
- `client/src/types/index.ts` — 新增 `FileInfoResult` 类型，更新 `ElectronAPI.resources` 接口
- `client/src/services/providerUpload.ts` — **新建**，供应商图片上传服务
- `client/src/pages/SceneVideoGenerate.tsx` — `handleGenerate` 中集成上传检查逻辑

## 上传流程

1. 检查当前 referenceImage URL 是否可访问（HEAD 请求，5s 超时）
2. 不可访问 → 解析本地文件路径，通过 IPC 读取文件信息
3. 获取供应商上传凭证（`/api/upload-configs/credential`）
4. 查本地 SQLite 缓存（hash + providerName），命中则验证缓存 URL
5. 缓存失效或未命中 → Web Crypto API 解密 API Key → 上传到供应商
6. 保存上传记录到本地缓存，返回可用 URL
