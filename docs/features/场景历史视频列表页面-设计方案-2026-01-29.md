# 场景历史视频列表页面 - 设计方案

**日期**: 2026-01-29
**状态**: 设计完成，待实施

## 概述

将场景卡片上的"生成视频"按钮改为跳转到场景历史视频列表页面，而不是直接生成视频。在历史视频列表页面中，用户可以查看该场景的所有历史视频、生成新视频、选择使用的视频、删除不需要的视频等操作。

## 设计决策

### 1. 页面导航方式
- **选择**: 跳转到新的独立页面
- **优点**: 有完整的页面空间，可以展示更多信息和操作
- **缺点**: 需要返回才能操作其他场景

### 2. 功能范围
- **选择**: 增强版本
- **包含功能**:
  - 查看该场景的所有历史视频（缩略图、时长、生成时间、状态）
  - 点击"生成新视频"按钮（弹窗配置参数）
  - 选择某个历史视频作为当前使用的视频（标记为 isSelected）
  - 预览视频（点击播放）
  - 删除不需要的历史视频
  - 查看每个视频的生成参数（prompt、promptType、是否使用故事板等）
  - 重新生成（使用相同参数生成新视频，不替换原视频）

### 3. 路由结构
- **选择**: 嵌套在剧本编辑器下
- **路由**: `/projects/[id]/script/[scriptId]/scenes/[sceneId]/videos`
- **优点**: 路由层级清晰，符合资源嵌套关系，面包屑导航自然

### 4. 视频展示方式
- **选择**: 网格布局
- **列数**: 4-5 列
- **卡片内容**: 缩略图、时长、生成时间、状态标签、选中标记
- **交互**: 悬停显示操作按钮，点击卡片查看详细参数

### 5. 生成新视频交互
- **选择**: 弹窗配置参数后生成
- **可配置参数**: promptType、是否使用故事板、是否使用角色形象、宽高比、时长、是否高清

### 6. 视频详情展示
- **选择**: 右侧滑出抽屉
- **内容**: 视频播放器、基本信息、生成参数、完整提示词、操作按钮

## 页面布局

### 整体布局（两行头部）

```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回  项目名称 > 剧本标题 > 场景视频列表                          │
│ 场景1: 藏在夕阳里的秘密 (12s)  [筛选] [排序]      [生成新视频]     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  视频网格（4-5列）                                                │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐                            │
│  │卡片│ │卡片│ │卡片│ │卡片│ │卡片│                            │
│  └────┘ └────┘ └────┘ └────┘ └────┘                            │
│  ┌────┐ ┌────┐ ┌────┐                                          │
│  │卡片│ │卡片│ │卡片│                                          │
│  └────┘ └────┘ └────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**布局说明**:
- 第一行: 返回按钮 + 面包屑导航
- 第二行: 场景信息 + 筛选排序 + 生成按钮

### 视频卡片设计

```
┌─────────────────┐
│   [缩略图]       │  ← 16:9 或其他宽高比
│   [播放图标]     │  ← 悬停时显示
├─────────────────┤
│ ✓ 已选中         │  ← isSelected 标记（绿色勾）
│ 12s | 生成中...  │  ← 时长 | 状态
│ 2026-01-29 10:30│  ← 生成时间
└─────────────────┘
   [操作按钮区]      ← 悬停时显示
```

**状态显示**:
- `pending`: 灰色标签 "等待中"
- `generating`: 蓝色标签 "生成中..." + 加载动画
- `completed`: 绿色标签 "已完成"
- `failed`: 红色标签 "失败"

**悬停操作按钮**:
- 播放按钮（打开视频播放器）
- 选择按钮（标记为当前使用）
- 删除按钮（删除历史记录）
- 重新生成按钮（使用相同参数生成新视频）
- 查看详情按钮（打开右侧抽屉）

## 组件结构

```
SceneVideos.tsx (页面组件)
├── SceneVideosHeader.tsx (顶部导航和场景信息)
├── VideoGenerateDialog.tsx (生成视频配置对话框)
├── VideoGrid.tsx (视频网格容器)
│   └── VideoCard.tsx (单个视频卡片)
└── VideoDetailDrawer.tsx (右侧抽屉 - 视频详情)
```

## 数据模型

### SceneVideo 接口（前端）

```typescript
interface SceneVideo {
  id: string;
  sceneId: string;
  videoUrl: string;
  thumbnailUrl?: string;
  duration?: number;
  prompt: string;
  promptType: 'smart_combine' | 'ai_optimized';
  status: 'pending' | 'generating' | 'completed' | 'failed';
  taskId?: string;
  errorMessage?: string;
  metadata?: {
    useStoryboard?: boolean;
    useCharacterImage?: boolean;
    referenceImage?: string;
    aspectRatio?: string;
    hd?: boolean;
  };
  isSelected: boolean;
  createdAt: string;
  updatedAt: string;
}
```

### 状态管理

使用 SWR 进行数据获取和缓存:

```typescript
const { data: videos, mutate } = useSWR(
  `/api/projects/${projectId}/scripts/${scriptId}/scenes/${sceneId}/videos`,
  fetcher
);
```

本地状态:
- `selectedVideoId`: 当前在抽屉中查看的视频 ID
- `isGenerateDialogOpen`: 生成视频对话框是否打开
- `isDrawerOpen`: 详情抽屉是否打开

## API 接口设计

### 1. 获取场景所有历史视频

```
GET /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos
```

**响应**:
```typescript
{
  videos: SceneVideo[];
  scene: {
    id: string;
    title: string;
    description: string;
    duration: number;
  };
}
```

**实现位置**:
```
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/route.ts (新建)
```

### 2. 生成视频（已存在，不需要修改）

```
POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video
```

### 3. 选择视频

```
PATCH /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]/select
```

**功能**:
- 将指定视频标记为 isSelected = true
- 同时将该场景的其他视频标记为 isSelected = false

**实现位置**:
```
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]/select/route.ts (新建)
```

### 4. 删除视频

```
DELETE /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]
```

**功能**:
- 删除指定的历史视频记录
- 如果删除的是 isSelected 的视频，需要提示用户或自动选择最新的视频

**实现位置**:
```
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]/route.ts (新建)
```

## 交互流程

### 流程 1: 生成新视频

1. 用户点击"生成新视频"按钮
2. 弹出 `VideoGenerateDialog` 配置对话框
3. 用户配置参数（promptType、useStoryboard、aspectRatio 等）
4. 点击"开始生成"，调用 API
5. 对话框关闭，视频列表自动刷新
6. 新视频卡片显示"生成中"状态
7. 使用轮询或 WebSocket 更新状态

### 流程 2: 选择视频

1. 用户悬停在视频卡片上
2. 点击"选择"按钮
3. 调用 PATCH API 标记为 isSelected
4. 刷新列表，显示绿色勾标记

### 流程 3: 删除视频

1. 用户点击"删除"按钮
2. 弹出确认对话框
3. 确认后调用 DELETE API
4. 刷新列表，移除该卡片

### 流程 4: 重新生成视频

1. 用户在详情抽屉中点击"重新生成"按钮
2. 打开生成对话框，预填充该视频的参数
3. 用户可以修改参数或直接生成
4. 生成新的视频记录（不替换原视频）

## UI 组件详细设计

### 生成视频配置对话框（VideoGenerateDialog）

```
┌─────────────────────────────────────┐
│  生成新视频                      [×] │
├─────────────────────────────────────┤
│                                     │
│  提示词类型：                        │
│  ○ 智能组合 (smart_combine)         │
│  ○ AI优化 (ai_optimized)            │
│                                     │
│  □ 使用故事板格式                    │
│  □ 使用角色形象作为参考图             │
│                                     │
│  宽高比：[16:9 ▼]                   │
│  时长：[12s] (继承场景设置)          │
│  □ 高清模式 (HD)                    │
│                                     │
│         [取消]  [开始生成]           │
└─────────────────────────────────────┘
```

**默认值**:
- promptType: 上次使用的值或 'smart_combine'
- useStoryboard: false
- useCharacterImage: true（如果场景有角色）
- aspectRatio: 场景的 aspectRatio 或 '16:9'
- duration: 场景的 duration
- hd: false

### 视频详情抽屉（VideoDetailDrawer）

```
┌─────────────────────────────────┐
│ 视频详情                    [×] │
├─────────────────────────────────┤
│                                 │
│  [视频播放器]                    │
│  ▶ 播放/暂停                     │
│                                 │
├─────────────────────────────────┤
│ 基本信息                         │
│ • 时长: 12s                      │
│ • 状态: 已完成                   │
│ • 生成时间: 2026-01-29 10:30    │
│ • 已选中: ✓                     │
├─────────────────────────────────┤
│ 生成参数                         │
│ • 提示词类型: 智能组合            │
│ • 故事板格式: 否                 │
│ • 角色形象: 是                   │
│ • 宽高比: 16:9                   │
│ • 高清: 否                       │
├─────────────────────────────────┤
│ 提示词                           │
│ [显示完整的 prompt 文本]         │
├─────────────────────────────────┤
│                                 │
│ [选择此视频] [重新生成] [删除]   │
│                                 │
└─────────────────────────────────┘
```

**操作按钮**:
- 选择此视频: 调用 PATCH API，标记为 isSelected
- 重新生成: 使用相同参数生成新视频（不替换原视频）
- 删除: 弹出确认对话框后删除

## 错误处理和边界情况

### 1. 错误处理

**视频生成失败**:
- 卡片显示红色"失败"标签
- 点击卡片查看详情抽屉，显示 errorMessage
- 提供"重新生成"按钮，使用相同参数重试

**API 请求失败**:
- 使用 toast 提示错误信息
- SWR 自动重试机制
- 提供手动刷新按钮

**删除失败**:
- 如果删除的是 isSelected 的视频，提示用户先选择其他视频
- 如果是最后一个视频，提示用户至少保留一个视频

### 2. 边界情况

**场景没有任何视频**:
- 显示空状态插图
- 提示"还没有生成视频，点击按钮开始生成"
- 突出显示"生成新视频"按钮

**视频生成中**:
- 卡片显示加载动画
- 禁用该卡片的操作按钮
- 使用轮询（每 5 秒）更新状态，直到完成或失败

**网络断开**:
- SWR 显示缓存数据
- 顶部显示"离线"提示
- 恢复网络后自动刷新

### 3. 性能优化

**图片懒加载**:
- 视频缩略图使用懒加载
- 只加载可视区域的缩略图

**分页加载**:
- 如果视频数量超过 20 个，使用分页或无限滚动
- 初始加载最新的 20 个视频

## 实现步骤

### 阶段 1: 核心功能（MVP）

1. 创建新页面路由和基础布局
2. 实现获取历史视频列表的 API
3. 实现视频网格和卡片组件
4. 修改场景列表的"生成视频"按钮，改为跳转到新页面
5. 实现生成视频配置对话框
6. 实现选择视频功能（PATCH API）

### 阶段 2: 增强功能

7. 实现视频详情抽屉
8. 实现删除视频功能（DELETE API）
9. 实现重新生成功能（复用参数）
10. 添加筛选和排序功能
11. 实现视频播放预览

### 阶段 3: 优化和完善

12. 添加轮询机制更新生成状态
13. 实现图片懒加载
14. 添加分页或无限滚动
15. 完善错误处理和边界情况
16. 添加加载骨架屏和过渡动画

## 文件清单

### 需要新建的文件

**前端**:
```
client/src/pages/SceneVideos.tsx
client/src/components/scene-videos/SceneVideosHeader.tsx
client/src/components/scene-videos/VideoGrid.tsx
client/src/components/scene-videos/VideoCard.tsx
client/src/components/scene-videos/VideoGenerateDialog.tsx
client/src/components/scene-videos/VideoDetailDrawer.tsx
```

**后端 API**:
```
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/route.ts
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]/select/route.ts
web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/videos/[videoId]/route.ts
```

### 需要修改的文件

```
client/src/App.tsx (添加路由)
client/src/components/project/DraggableSceneList.tsx (修改按钮行为)
client/src/pages/ProjectScript.tsx (修改 handleGenerateVideo)
```

## 技术依赖

- **SWR**: 数据获取和缓存
- **shadcn/ui**: Dialog、Drawer、Card 等组件
- **React Router**: 页面导航
- **现有的 API 服务层**: script.ts 中的服务函数

## 总结

这个设计方案将场景视频生成功能从单次操作升级为完整的历史管理系统，用户可以：
- 查看和管理所有历史视频
- 灵活配置生成参数
- 对比和选择最佳视频
- 保留生成历史用于迭代优化

设计遵循了项目现有的架构模式和 UI 风格，使用成熟的技术栈，实现步骤清晰，可以分阶段逐步完成。
