# 场景视频生成 - 故事板模式支持

**日期**: 2026-01-29
**类型**: 功能新增
**影响范围**: Web API - 场景视频生成

## 功能概述

添加故事板（Storyboard）模式支持，可以一次性为整个剧本生成连贯的视频，而不是为每个场景单独生成。

## 两种生成模式对比

### 1. Individual 模式（单独生成）
- **特点**: 为每个场景单独生成视频
- **优势**:
  - 每个场景可以独立调整
  - 失败不影响其他场景
  - 可以选择性生成部分场景
- **劣势**:
  - 需要多次 API 调用
  - 场景之间可能不连贯
  - 总耗时较长

### 2. Storyboard 模式（故事板）
- **特点**: 一次性生成包含所有场景的完整视频
- **优势**:
  - 只需一次 API 调用
  - 场景之间转场更流畅
  - 视频整体更连贯
  - 生成速度更快
- **劣势**:
  - 无法单独调整某个场景
  - 失败需要重新生成整个视频
  - 时长限制（最大 25 秒）

## 故事板 Prompt 格式

```
Shot 1:
duration: 7.5sec
Scene: 昏黄的夕阳透过窗户，洒在略显凌乱的餐桌上...

Shot 2:
duration: 10sec
Scene: 母亲从厨房走出来，手里端着一盘热气腾腾的饭菜...

Shot 3:
duration: 8sec
Scene: 父亲低着头，默默地吃着饭，眼神中透着愧疚...
```

## API 使用

### 请求参数

```typescript
POST /api/projects/[id]/scripts/[scriptId]/generate-videos

{
  "mode": "storyboard",           // 生成模式：individual 或 storyboard
  "promptType": "smart_combine",  // Prompt 构建方式
  "aspectRatio": "16:9",          // 宽高比
  "sceneIds": ["id1", "id2"]      // 可选：指定场景
}
```

### Individual 模式响应

```json
{
  "success": true,
  "message": "已提交 3 个场景的视频生成任务",
  "mode": "individual",
  "sceneCount": 3,
  "tasks": [
    {
      "sceneId": "scene-1",
      "sceneTitle": "场景1",
      "videoId": "video-1"
    },
    ...
  ]
}
```

### Storyboard 模式响应

```json
{
  "success": true,
  "message": "已提交故事板视频生成任务（包含 3 个场景）",
  "mode": "storyboard",
  "videoId": "video-1",
  "sceneCount": 3,
  "scenes": [
    {
      "sceneId": "scene-1",
      "sceneTitle": "场景1"
    },
    ...
  ]
}
```

## 实现细节

### 1. Prompt 构建

**文件**: `web/src/lib/services/storyboard-prompt-builder.ts`

```typescript
export function buildStoryboardPrompt(
  scenes: Array<{
    title: string;
    duration?: number | null;
    prompt: string;
  }>
): string {
  const shots = scenes.map((scene, index) => {
    const duration = scene.duration || 10;
    return `Shot ${index + 1}:\nduration: ${duration}sec\nScene: ${scene.prompt}`;
  });

  return shots.join("\n\n");
}
```

### 2. 数据存储

故事板模式下，只创建一个 `SceneVideo` 记录：
- `sceneId`: 第一个场景的 ID
- `prompt`: 故事板格式的完整 prompt
- `promptType`: `{promptType}_storyboard`（如 `smart_combine_storyboard`）
- `metadata`: 包含所有场景信息
  ```json
  {
    "mode": "storyboard",
    "sceneIds": ["id1", "id2", "id3"],
    "sceneCount": 3
  }
  ```

### 3. 时长计算

故事板模式会计算所有场景的总时长：
```typescript
const totalDuration = scenes.reduce(
  (sum, scene) => sum + (scene.duration || 10),
  0
);

// 提交时限制最大 25 秒（sora-2-pro 限制）
const duration = Math.min(totalDuration, 25);
```

### 4. 状态轮询

与单独生成模式相同，使用 5 秒轮询间隔，最多 10 分钟。

## 使用场景

### 适合使用 Individual 模式的情况

1. 场景数量较多（>5 个）
2. 需要精细控制每个场景
3. 场景之间差异较大
4. 需要分批生成
5. 总时长超过 25 秒

### 适合使用 Storyboard 模式的情况

1. 场景数量较少（≤5 个）
2. 场景之间连贯性强
3. 追求整体流畅度
4. 总时长在 25 秒以内
5. 希望快速生成完整视频

## 示例

### 使用 Individual 模式

```typescript
// 为所有场景单独生成视频
POST /api/projects/{projectId}/scripts/{scriptId}/generate-videos
{
  "mode": "individual",
  "promptType": "smart_combine",
  "aspectRatio": "16:9"
}
```

### 使用 Storyboard 模式

```typescript
// 为所有场景生成一个连贯的视频
POST /api/projects/{projectId}/scripts/{scriptId}/generate-videos
{
  "mode": "storyboard",
  "promptType": "smart_combine",
  "aspectRatio": "16:9"
}
```

### 为指定场景生成故事板视频

```typescript
POST /api/projects/{projectId}/scripts/{scriptId}/generate-videos
{
  "mode": "storyboard",
  "sceneIds": ["scene-1", "scene-2", "scene-3"],
  "aspectRatio": "9:16"
}
```

## 技术限制

### Sora-2 限制
- 最大时长: 10 秒
- 支持宽高比: 16:9, 9:16
- HD: 不支持

### Sora-2-Pro 限制
- 最大时长: 25 秒
- 支持宽高比: 16:9, 9:16
- HD: 支持
- 注意: 25 秒时 HD 不起作用

## 相关文件

### 新增文件
- `web/src/lib/services/storyboard-prompt-builder.ts` - 故事板 prompt 构建

### 修改文件
- `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts` - 添加故事板模式支持

## 测试建议

1. **Individual 模式测试**:
   - 测试单场景生成
   - 测试多场景生成
   - 测试指定场景生成

2. **Storyboard 模式测试**:
   - 测试 2-3 个场景的故事板
   - 测试不同时长组合
   - 测试不同宽高比

3. **边界测试**:
   - 测试总时长超过 25 秒的情况
   - 测试单个场景的故事板
   - 测试大量场景（10+ 个）

4. **对比测试**:
   - 对比两种模式的生成速度
   - 对比视频质量和连贯性
   - 对比失败率

## 总结

本次实施完成了故事板模式的支持：

- ✅ 添加故事板 prompt 构建函数
- ✅ 支持两种生成模式（individual/storyboard）
- ✅ 实现故事板模式的后台生成
- ✅ 完善的元数据存储
- ✅ 时长自动计算和限制

用户现在可以根据实际需求选择合适的生成模式，获得更好的视频生成体验。
