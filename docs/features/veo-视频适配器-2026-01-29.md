# Veo（Google）视频生成适配器实现

## 概述

为 AI 视频生成平台添加 Google Veo 视频生成服务的适配器支持，支持文生视频和图生视频两种模式，并支持多张参考图片。

## 实现日期

2026-01-29

## API 文档对比

### 1. 提交视频生成任务

**端点**: `POST /v2/videos/generations`

**认证**: `Authorization: Bearer YOUR_API_KEY`

**请求参数**:

#### 基础参数
- `model`: 模型名称（必填）
  - 文生视频：veo3, veo3-fast, veo3-pro, veo2, veo2-fast, veo2-pro, veo3.1, veo3.1-pro
  - 图生视频：veo3-pro-frames, veo3-fast-frames, veo2-fast-frames, veo2-fast-components, veo3.1, veo3.1-pro, veo3.1-components
- `prompt`: 视频内容描述（必填）

#### 图生视频参数
- `images`: 图片 URL 或 base64 数组
  - veo2-fast-frames: 最多2个（首尾帧）
  - veo3-pro-frames: 最多1个（首帧）
  - veo2-fast-components: 最多3个（视频元素）
  - veo3.1, veo3.1-pro: 支持首尾帧
  - veo3.1-components: 1-3张图

#### 视频设置
- `aspect_ratio`: 16:9, 9:16（可选，图生视频时不传会根据参考图自动匹配）
- `enhance_prompt`: 是否优化提示词（中文转英文）
- `enable_upsample`: 是否分辨率提升（返回1080p）

**响应格式**:
```json
{
  "task_id": "f0aa213c-c09e-4e19-a0e5-c698fe48acf1"
}
```

### 2. 查询任务状态

**端点**: `GET /v2/videos/generations/{task_id}`

**认证**: `Authorization: Bearer YOUR_API_KEY`

**响应格式**:
```json
{
  "task_id": "veo3:1756693796-YQVHH4A3Lg",
  "platform": "google",
  "action": "google-videos",
  "status": "SUCCESS",
  "fail_reason": "",
  "submit_time": 1756693797,
  "start_time": 1756693808,
  "finish_time": 1756693898,
  "progress": "100%",
  "data": {
    "output": "https://filesystem.site/cdn/20250901/video.mp4"
  }
}
```

**状态枚举**:
- `NOT_START`: 未开始
- `IN_PROGRESS`: 正在执行
- `SUCCESS`: 执行完成
- `FAILURE`: 失败

## 实现内容

### 1. 类型定义 (`web/src/lib/ai/types/index.ts`)

#### 添加 VideoProvider 类型
```typescript
export type VideoProvider =
  | "sora"
  | "runway"
  | "pika"
  | "kling"
  | "minimax"
  | "zhipu-video"
  | "fal-video"
  | "bltcy"
  | "toapis"
  | "wan2.6"
  | "veo"              // 新增
  | "custom";
```

#### 添加默认配置
```typescript
veo: {
  provider: "veo",
  submitEndpoint: "/v2/videos/generations",
  statusEndpoint: "/v2/videos/generations/{task_id}",
  authHeader: "Authorization",
  authPrefix: "Bearer ",
  taskIdPath: "task_id",
  taskStatusPath: "status",
  videoUrlPath: "data.output",
  pollInterval: 10000,  // 10 秒轮询间隔
  maxWaitTime: 600000,  // 最大等待 10 分钟
  defaultAspectRatio: "16:9",
}
```

### 2. 视频客户端 (`web/src/lib/ai/video-client.ts`)

#### 添加请求体构建逻辑

```typescript
case "veo":
  body.prompt = request.prompt;
  body.model = this.modelName;

  // 图生视频：如果提供了图片 URL，使用 images 数组
  if (request.imageUrl) {
    body.images = [request.imageUrl];
    // 图生视频模式下 aspect_ratio 可选，不传时根据参考图自动匹配
    if (request.aspectRatio) {
      body.aspect_ratio = request.aspectRatio;
    }
  } else {
    // 文生视频模式支持 aspect_ratio 参数
    body.aspect_ratio = request.aspectRatio || this.config.defaultAspectRatio || "16:9";
  }

  // enhance_prompt: 是否优化提示词（中文转英文）
  if (this.config.extraHeaders?.enhance_prompt !== undefined) {
    body.enhance_prompt = this.config.extraHeaders.enhance_prompt;
  }

  // enable_upsample: 是否分辨率提升（返回1080p）
  if (this.config.extraHeaders?.enable_upsample !== undefined) {
    body.enable_upsample = this.config.extraHeaders.enable_upsample;
  }

  // 支持额外的图片（通过 extraHeaders 传递）
  if (this.config.extraHeaders?.additional_images) {
    const additionalImages = this.config.extraHeaders.additional_images as string[];
    if (body.images) {
      body.images = [...body.images, ...additionalImages];
    } else {
      body.images = additionalImages;
    }
  }
  break;
```

#### 进度解析改进

```typescript
// 提取进度：支持数字和字符串格式
let progress = getByPath(data, "progress") as number | string | undefined;
if (typeof progress === "string") {
  // Veo 返回的是字符串格式（如 "100%"），需要转换为数字
  progress = parseInt(progress.replace("%", ""), 10) || 0;
}
```

### 3. 管理界面 (`web/src/app/admin/ai-config/[id]/page.tsx`)

#### 更新类型定义
```typescript
type VideoProvider = "sora" | "runway" | "kling" | "zhipu-video" | "fal-video" | "bltcy" | "toapis" | "wan2.6" | "veo" | "custom";
```

#### 添加 UI 标签
```typescript
const VIDEO_PROVIDER_LABELS: Record<VideoProvider, string> = {
  // ...
  veo: "Google Veo",
  // ...
};
```

## 使用示例

### 配置 AI 模型

在管理后台创建 Veo 视频模型配置：

1. **基本信息**:
   - 模型名称: "veo-video"
   - 模型类型: VIDEO
   - API URL: "https://your-api-endpoint.com"
   - API Key: "your-api-key"
   - 模型标识: "veo3.1" 或其他 Veo 模型

2. **配置选项** (JSON):
```json
{
  "provider": "veo",
  "defaultAspectRatio": "16:9",
  "extraHeaders": {
    "enhance_prompt": true,
    "enable_upsample": false
  }
}
```

### 调用示例

#### 文生视频
```typescript
const videoClient = new VideoClient(
  "https://your-api-endpoint.com",
  "your-api-key",
  "veo3.1",
  {
    provider: "veo",
    defaultAspectRatio: "16:9",
  }
);

const result = await videoClient.submit({
  prompt: "一只可爱的猫咪在阳光下伸懒腰",
  aspectRatio: "16:9",
});
```

#### 图生视频（单张图片）
```typescript
const result = await videoClient.submit({
  prompt: "让猫咪动起来",
  imageUrl: "https://example.com/cat.jpg",
});
```

#### 图生视频（多张图片 - 首尾帧）
```typescript
const videoClient = new VideoClient(
  "https://your-api-endpoint.com",
  "your-api-key",
  "veo2-fast-frames",
  {
    provider: "veo",
    extraHeaders: {
      additional_images: ["https://example.com/end-frame.jpg"],
    }
  }
);

const result = await videoClient.submit({
  prompt: "从第一帧过渡到最后一帧",
  imageUrl: "https://example.com/start-frame.jpg",
});
```

#### 启用提示词优化和分辨率提升
```typescript
const videoClient = new VideoClient(
  "https://your-api-endpoint.com",
  "your-api-key",
  "veo3.1-pro",
  {
    provider: "veo",
    extraHeaders: {
      enhance_prompt: true,
      enable_upsample: true,
    }
  }
);

const result = await videoClient.submit({
  prompt: "一只猫在草地上奔跑",  // 会自动转换为英文
  aspectRatio: "16:9",
});
```

## 特性支持

### 基础功能
- ✅ 文生视频 (Text-to-Video)
- ✅ 图生视频 (Image-to-Video)
- ✅ 多张参考图片（1-3张，取决于模型）
- ✅ 宽高比设置（16:9, 9:16）
- ✅ 异步任务管理
- ✅ 任务状态查询
- ✅ 轮询等待完成

### 高级功能
- ✅ 提示词优化（enhance_prompt）- 中文自动转英文
- ✅ 分辨率提升（enable_upsample）- 返回1080p视频
- ✅ 首尾帧支持（veo2-fast-frames, veo3.1, veo3.1-pro）
- ✅ 多图元素支持（veo2-fast-components, veo3.1-components）
- ✅ 自动音频生成（veo3.1, veo3.1-pro）

## 模型对比

| 模型 | 类型 | 图片支持 | 音频 | 特点 |
|------|------|----------|------|------|
| veo3 | 文生 | ❌ | ❌ | 标准质量 |
| veo3-fast | 文生 | ❌ | ❌ | 快速生成 |
| veo3-pro | 文生 | ❌ | ❌ | 高质量 |
| veo3-pro-frames | 图生 | ✅ 1张（首帧） | ❌ | 高质量图生 |
| veo3-fast-frames | 图生 | ✅ 1张（首帧） | ❌ | 快速图生 |
| veo2 | 文生 | ❌ | ❌ | 标准质量 |
| veo2-fast | 文生 | ❌ | ❌ | 快速生成 |
| veo2-fast-frames | 图生 | ✅ 2张（首尾帧） | ❌ | 快速图生 |
| veo2-fast-components | 图生 | ✅ 3张（元素） | ❌ | 多元素合成 |
| veo2-pro | 文生 | ❌ | ❌ | 高质量 |
| veo3.1 | 文生/图生 | ✅ 首尾帧 | ✅ | 最新模型，性价比高 |
| veo3.1-pro | 文生/图生 | ✅ 首尾帧 | ✅ | 最新模型，超高质量 |
| veo3.1-components | 图生 | ✅ 1-3张 | ✅ | 多图参考 |

## 与其他适配器的对比

| 特性 | Veo | Wan2.6 | toapis Sora2 |
|------|-----|--------|--------------|
| 端点路径 | `/v2/videos/generations` | `/v1/videos/generations` | `/v1/videos/generations` |
| 文生视频 | ✅ | ✅ | ✅ |
| 图生视频 | ✅ | ✅ | ✅ |
| 多张图片 | ✅ 1-3张 | ❌ 1张 | ❌ 1张 |
| 首尾帧 | ✅ | ❌ | ❌ |
| 提示词优化 | ✅ | ❌ | ❌ |
| 分辨率提升 | ✅ | ❌ | ❌ |
| 自动音频 | ✅ | ✅ | ❌ |
| 状态格式 | NOT_START/IN_PROGRESS/SUCCESS/FAILURE | queued/in_progress/completed/failed | queued/in_progress/completed/failed |
| 进度格式 | 字符串（"100%"） | 数字（0-100） | 数字（0-100） |

## 场景生成视频适配

Veo 适配器已自动集成到场景生成视频功能中：

1. **自动模式选择**：
   - 如果场景有角色形象图，自动使用图生视频模式
   - 否则使用文生视频模式

2. **参数映射**：
   - 场景的 `prompt` → Veo 的 `prompt`
   - 角色形象图 → Veo 的 `images[0]`
   - 宽高比 → Veo 的 `aspect_ratio`（图生视频时可选）

## 注意事项

1. **图片数量限制**：不同模型支持的图片数量不同，需要根据模型选择
2. **提示词语言**：Veo 只支持英文提示词，建议启用 `enhance_prompt` 自动转换
3. **宽高比**：图生视频时不传 `aspect_ratio` 会根据参考图自动匹配
4. **进度格式**：Veo 返回字符串格式的进度（如 "100%"），已自动转换为数字
5. **状态映射**：Veo 的状态枚举已自动映射到统一格式

## 测试建议

1. 测试文生视频（基础参数）
2. 测试图生视频（单张图片）
3. 测试图生视频（多张图片 - 首尾帧）
4. 测试提示词优化功能（中文转英文）
5. 测试分辨率提升功能
6. 测试不同模型的特性
7. 测试场景生成视频集成

## 相关文件

- `web/src/lib/ai/types/index.ts` - 类型定义和默认配置
- `web/src/lib/ai/video-client.ts` - 视频客户端实现
- `web/src/app/admin/ai-config/[id]/page.tsx` - 管理界面
- `docs/features/wan2.6-视频适配器-2026-01-29.md` - Wan2.6 适配器参考
- `docs/features/toapis-sora2-视频适配器-2026-01-29.md` - toapis 适配器参考

## 后续优化

1. 添加模型选择器，根据需求自动推荐合适的模型
2. 支持首尾帧编辑器，可视化配置首尾帧
3. 添加提示词翻译预览功能
4. 支持批量生成不同模型的视频
5. 集成音频生成服务，自动为视频配音
