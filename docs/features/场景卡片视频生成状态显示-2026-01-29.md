# åœºæ™¯å¡ç‰‡è§†é¢‘ç”ŸæˆçŠ¶æ€æ˜¾ç¤º

## æ¦‚è¿°

åœ¨åœºæ™¯åˆ—è¡¨å¡ç‰‡ä¸Šå®æ—¶æ˜¾ç¤º toapis è§†é¢‘ç”Ÿæˆçš„è¿›åº¦å’ŒçŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°æ¯ä¸ªåœºæ™¯çš„è§†é¢‘ç”Ÿæˆæƒ…å†µã€‚

## å®ç°æ—¥æœŸ

2026-01-29

## åŠŸèƒ½ç‰¹æ€§

### 1. å®æ—¶çŠ¶æ€æ˜¾ç¤º

åœ¨åœºæ™¯å¡ç‰‡ä¸Šæ˜¾ç¤ºè§†é¢‘ç”Ÿæˆçš„å®æ—¶çŠ¶æ€ï¼š

- **æ’é˜Ÿä¸­** (pending): é»„è‰²æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ—¶é’Ÿå›¾æ ‡
- **ç”Ÿæˆä¸­** (generating): è“è‰²æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ—‹è½¬åŠ è½½å›¾æ ‡å’Œè¿›åº¦ç™¾åˆ†æ¯”ï¼Œå¸¦è¿›åº¦æ¡
- **å·²å®Œæˆ** (completed): ç»¿è‰²æ ‡ç­¾ï¼Œæ˜¾ç¤ºå‹¾é€‰å›¾æ ‡
- **ç”Ÿæˆå¤±è´¥** (failed): çº¢è‰²æ ‡ç­¾ï¼Œæ˜¾ç¤ºé”™è¯¯å›¾æ ‡å’Œé”™è¯¯ä¿¡æ¯

### 2. è‡ªåŠ¨è½®è¯¢

- é¡µé¢åŠ è½½åè‡ªåŠ¨å¯åŠ¨è½®è¯¢
- æ¯ 10 ç§’æŸ¥è¯¢ä¸€æ¬¡è§†é¢‘ç”ŸæˆçŠ¶æ€
- é¡µé¢å¸è½½æ—¶è‡ªåŠ¨åœæ­¢è½®è¯¢
- è½®è¯¢å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ

### 3. è¿›åº¦æ¡æ˜¾ç¤º

ç”Ÿæˆä¸­çŠ¶æ€ä¼šæ˜¾ç¤ºï¼š
- è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰
- åŠ¨æ€è¿›åº¦æ¡ï¼Œå¹³æ»‘è¿‡æ¸¡åŠ¨ç”»
- æ—‹è½¬çš„åŠ è½½å›¾æ ‡

## å®ç°å†…å®¹

### 1. é¡µé¢ç»„ä»¶ (`client/src/pages/ProjectScript.tsx`)

#### æ·»åŠ çŠ¶æ€ç®¡ç†

```typescript
// è§†é¢‘ç”ŸæˆçŠ¶æ€ç±»å‹
interface VideoStatus {
  sceneId: string;
  status: 'pending' | 'generating' | 'completed' | 'failed' | 'no_video';
  progress: number;
  videoUrl?: string | null;
  thumbnailUrl?: string | null;
  errorMessage?: string | null;
}

// çŠ¶æ€ç®¡ç†
const [videoStatuses, setVideoStatuses] = useState<Map<string, VideoStatus>>(new Map());
const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);
```

#### è½®è¯¢é€»è¾‘

```typescript
// å¯åŠ¨è½®è¯¢
const startPolling = () => {
  stopPolling(); // å…ˆåœæ­¢ä¹‹å‰çš„è½®è¯¢
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  pollVideoStatus();
  // æ¯ 10 ç§’è½®è¯¢ä¸€æ¬¡
  pollingIntervalRef.current = setInterval(() => {
    pollVideoStatus();
  }, 10000);
};

// åœæ­¢è½®è¯¢
const stopPolling = () => {
  if (pollingIntervalRef.current) {
    clearInterval(pollingIntervalRef.current);
    pollingIntervalRef.current = null;
  }
};

// è½®è¯¢è§†é¢‘ç”ŸæˆçŠ¶æ€
const pollVideoStatus = async () => {
  if (!id || !scriptId) return;
  try {
    const statusData = await getVideosGenerationStatus(id, scriptId);
    const statusMap = new Map<string, VideoStatus>();
    statusData.scenes.forEach((scene) => {
      statusMap.set(scene.sceneId, {
        sceneId: scene.sceneId,
        status: scene.status,
        progress: scene.progress,
        videoUrl: scene.videoUrl,
        thumbnailUrl: scene.thumbnailUrl,
        errorMessage: scene.errorMessage,
      });
    });
    setVideoStatuses(statusMap);
  } catch (err) {
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
    console.error('Failed to poll video status:', err);
  }
};
```

#### ç”Ÿå‘½å‘¨æœŸç®¡ç†

```typescript
useEffect(() => {
  loadData();
  // å¯åŠ¨è½®è¯¢
  startPolling();
  // æ¸…ç†å‡½æ•°
  return () => {
    stopPolling();
  };
}, [id, scriptId]);
```

### 2. åœºæ™¯å¡ç‰‡ç»„ä»¶ (`client/src/components/project/DraggableSceneList.tsx`)

#### çŠ¶æ€æ˜¾ç¤ºé€»è¾‘

```typescript
// è·å–çŠ¶æ€æ˜¾ç¤ºä¿¡æ¯
const getStatusDisplay = () => {
  if (!videoStatus || videoStatus.status === 'no_video') {
    return null;
  }

  switch (videoStatus.status) {
    case 'pending':
      return (
        <div className="flex items-center gap-1.5 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded">
          <Clock className="w-3 h-3" />
          <span>æ’é˜Ÿä¸­</span>
        </div>
      );
    case 'generating':
      return (
        <div className="space-y-1">
          <div className="flex items-center gap-1.5 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
            <Loader2 className="w-3 h-3 animate-spin" />
            <span>ç”Ÿæˆä¸­ {videoStatus.progress}%</span>
          </div>
          {/* è¿›åº¦æ¡ */}
          <div className="w-full bg-slate-200 rounded-full h-1.5">
            <div
              className="bg-blue-600 h-1.5 rounded-full transition-all duration-300"
              style={{ width: `${videoStatus.progress}%` }}
            />
          </div>
        </div>
      );
    case 'completed':
      return (
        <div className="flex items-center gap-1.5 text-xs text-green-600 bg-green-50 px-2 py-1 rounded">
          <CheckCircle2 className="w-3 h-3" />
          <span>å·²å®Œæˆ</span>
        </div>
      );
    case 'failed':
      return (
        <div className="space-y-1">
          <div className="flex items-center gap-1.5 text-xs text-red-600 bg-red-50 px-2 py-1 rounded">
            <XCircle className="w-3 h-3" />
            <span>ç”Ÿæˆå¤±è´¥</span>
          </div>
          {videoStatus.errorMessage && (
            <p className="text-xs text-red-500 truncate" title={videoStatus.errorMessage}>
              {videoStatus.errorMessage}
            </p>
          )}
        </div>
      );
    default:
      return null;
  }
};
```

#### å¡ç‰‡å¸ƒå±€

```tsx
{/* è§†é¢‘ç”ŸæˆçŠ¶æ€ */}
{getStatusDisplay() && (
  <div className="mb-3">
    {getStatusDisplay()}
  </div>
)}
```

## è§†è§‰æ•ˆæœ

### æ’é˜Ÿä¸­çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ• æ’é˜Ÿä¸­               â”‚ â† é»„è‰²èƒŒæ™¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”Ÿæˆä¸­çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŸ³ ç”Ÿæˆä¸­ 45%           â”‚ â† è“è‰²èƒŒæ™¯ï¼Œæ—‹è½¬å›¾æ ‡
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚ â† è¿›åº¦æ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·²å®ŒæˆçŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ“ å·²å®Œæˆ                â”‚ â† ç»¿è‰²èƒŒæ™¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”Ÿæˆå¤±è´¥çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ— ç”Ÿæˆå¤±è´¥              â”‚ â† çº¢è‰²èƒŒæ™¯
â”‚ user quota is not enoughâ”‚ â† é”™è¯¯ä¿¡æ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API é›†æˆ

### çŠ¶æ€æŸ¥è¯¢æ¥å£

```typescript
export const getVideosGenerationStatus = async (
  projectId: string,
  scriptId: string
): Promise<{
  success: boolean;
  scriptId: string;
  overallStatus: 'not_started' | 'generating' | 'completed' | 'failed' | 'partial';
  scenes: Array<{
    sceneId: string;
    sceneTitle: string;
    status: 'pending' | 'generating' | 'completed' | 'failed' | 'no_video';
    progress: number;
    videoUrl?: string | null;
    thumbnailUrl?: string | null;
    duration?: number | null;
    errorMessage?: string | null;
    videoId?: string | null;
    createdAt?: string | null;
  }>;
  totalScenes: number;
  completedScenes: number;
  failedScenes: number;
  generatingScenes: number;
}>;
```

### çŠ¶æ€æ˜ å°„

åç«¯è¿”å›çš„çŠ¶æ€ä¼šæ˜ å°„åˆ°å‰ç«¯æ˜¾ç¤ºï¼š

| åç«¯çŠ¶æ€ | å‰ç«¯æ˜¾ç¤º | é¢œè‰² | å›¾æ ‡ |
|---------|---------|------|------|
| pending | æ’é˜Ÿä¸­ | é»„è‰² | æ—¶é’Ÿ |
| generating | ç”Ÿæˆä¸­ X% | è“è‰² | æ—‹è½¬åŠ è½½ |
| completed | å·²å®Œæˆ | ç»¿è‰² | å‹¾é€‰ |
| failed | ç”Ÿæˆå¤±è´¥ | çº¢è‰² | é”™è¯¯ |
| no_video | æ— æ˜¾ç¤º | - | - |

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. å¹³æ»‘åŠ¨ç”»
- è¿›åº¦æ¡ä½¿ç”¨ CSS transitionï¼Œå¹³æ»‘è¿‡æ¸¡
- åŠ è½½å›¾æ ‡ä½¿ç”¨ animate-spin æ—‹è½¬åŠ¨ç”»

### 2. é”™è¯¯æç¤º
- å¤±è´¥çŠ¶æ€æ˜¾ç¤ºå®Œæ•´é”™è¯¯ä¿¡æ¯
- é¼ æ ‡æ‚¬åœå¯æŸ¥çœ‹å®Œæ•´é”™è¯¯æ–‡æœ¬ï¼ˆä½¿ç”¨ title å±æ€§ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ Map æ•°æ®ç»“æ„å­˜å‚¨çŠ¶æ€ï¼ŒO(1) æŸ¥è¯¢å¤æ‚åº¦
- è½®è¯¢å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œä¸å¼¹å‡ºé”™è¯¯æç¤º
- é¡µé¢å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨

### 4. å“åº”å¼è®¾è®¡
- çŠ¶æ€æ ‡ç­¾è‡ªé€‚åº”å¡ç‰‡å®½åº¦
- è¿›åº¦æ¡å®½åº¦æ ¹æ®ç™¾åˆ†æ¯”åŠ¨æ€è°ƒæ•´

## ä½¿ç”¨åœºæ™¯

1. **æ‰¹é‡ç”Ÿæˆè§†é¢‘**ï¼šç”¨æˆ·å¯ä»¥åŒæ—¶ä¸ºå¤šä¸ªåœºæ™¯ç”Ÿæˆè§†é¢‘ï¼Œå®æ—¶æŸ¥çœ‹æ¯ä¸ªåœºæ™¯çš„ç”Ÿæˆè¿›åº¦

2. **é”™è¯¯æ’æŸ¥**ï¼šç”Ÿæˆå¤±è´¥æ—¶ï¼Œç›´æ¥åœ¨å¡ç‰‡ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜

3. **è¿›åº¦è·Ÿè¸ª**ï¼šé•¿æ—¶é—´ç”Ÿæˆä»»åŠ¡ï¼ˆ1-5åˆ†é’Ÿï¼‰ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°å®æ—¶è¿›åº¦ï¼Œä¸éœ€è¦åˆ·æ–°é¡µé¢

4. **çŠ¶æ€ç›‘æ§**ï¼šç®¡ç†å‘˜å¯ä»¥ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°æ‰€æœ‰åœºæ™¯çš„è§†é¢‘ç”ŸæˆçŠ¶æ€

## æ³¨æ„äº‹é¡¹

1. **è½®è¯¢é—´éš”**ï¼šè®¾ç½®ä¸º 10 ç§’ï¼Œç¬¦åˆ toapis API æ–‡æ¡£å»ºè®®ï¼Œé¿å…è¯·æ±‚é¢‘ç‡è¿‡é«˜

2. **å†…å­˜ç®¡ç†**ï¼šä½¿ç”¨ useRef å­˜å‚¨å®šæ—¶å™¨å¼•ç”¨ï¼Œç¡®ä¿ç»„ä»¶å¸è½½æ—¶æ­£ç¡®æ¸…ç†

3. **é”™è¯¯å¤„ç†**ï¼šè½®è¯¢å¤±è´¥æ—¶ä¸å½±å“ç”¨æˆ·æ“ä½œï¼Œåªåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯æ—¥å¿—

4. **çŠ¶æ€åŒæ­¥**ï¼šæ¯æ¬¡è½®è¯¢éƒ½ä¼šæ›´æ–°æ‰€æœ‰åœºæ™¯çš„çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

## åç»­ä¼˜åŒ–

1. **WebSocket æ”¯æŒ**ï¼šå¦‚æœåç«¯æ”¯æŒ WebSocketï¼Œå¯ä»¥æ›¿æ¢è½®è¯¢æœºåˆ¶ï¼Œå®ç°çœŸæ­£çš„å®æ—¶æ¨é€

2. **é€šçŸ¥æé†’**ï¼šè§†é¢‘ç”Ÿæˆå®Œæˆæˆ–å¤±è´¥æ—¶ï¼Œå¯ä»¥æ·»åŠ æµè§ˆå™¨é€šçŸ¥æˆ–é¡µé¢å†…é€šçŸ¥

3. **å†å²è®°å½•**ï¼šè®°å½•è§†é¢‘ç”Ÿæˆå†å²ï¼ŒåŒ…æ‹¬ç”Ÿæˆæ—¶é—´ã€è€—æ—¶ç­‰ä¿¡æ¯

4. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡é‡è¯•å¤±è´¥çš„è§†é¢‘ç”Ÿæˆä»»åŠ¡

5. **è¿›åº¦è¯¦æƒ…**ï¼šç‚¹å‡»è¿›åº¦æ¡å¯ä»¥æŸ¥çœ‹æ›´è¯¦ç»†çš„ç”Ÿæˆä¿¡æ¯ï¼ˆå¦‚å½“å‰å¤„ç†é˜¶æ®µï¼‰

## ç›¸å…³æ–‡ä»¶

- `client/src/pages/ProjectScript.tsx` - é¡µé¢ç»„ä»¶ï¼Œè½®è¯¢é€»è¾‘
- `client/src/components/project/DraggableSceneList.tsx` - åœºæ™¯å¡ç‰‡ç»„ä»¶
- `client/src/services/script.ts` - API æœåŠ¡
- `docs/features/toapis-sora2-è§†é¢‘é€‚é…å™¨-2026-01-29.md` - toapis é€‚é…å™¨æ–‡æ¡£
