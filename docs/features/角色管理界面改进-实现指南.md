# è§’è‰²ç®¡ç†ç•Œé¢æ”¹è¿› - å®ç°æŒ‡å—

## ğŸ¯ å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ›´æ–°ç±»å‹å®šä¹‰

å·²å®Œæˆ âœ…

æ–‡ä»¶ï¼š`client/src/types/index.ts`

æ–°å¢äº† `DigitalHuman` æ¥å£ï¼Œå¹¶æ‰©å±•äº† `ProjectCharacter` æ¥å£ã€‚

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–°ç»„ä»¶

#### 1. DigitalHumanGenerator ç»„ä»¶ âœ…

**æ–‡ä»¶**: `client/src/components/project/DigitalHumanGenerator.tsx`

**åŠŸèƒ½**:
- å±•ç¤ºå½“å‰é€‰ä¸­çš„æ•°å­—äººå½¢è±¡
- æä¾›ç”ŸæˆæŒ‰é’®
- å±•ç¤ºå½“å‰æ‰¹æ¬¡çš„å€™é€‰å½¢è±¡ï¼ˆ2åˆ—ç½‘æ ¼ï¼‰
- å±•ç¤ºå†å²ç”Ÿæˆè®°å½•ï¼ˆ3åˆ—ç½‘æ ¼ï¼‰
- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†

**Props**:
```typescript
interface DigitalHumanGeneratorProps {
  characterId: string;
  characterName: string;
  characterDescription: string;
  referenceImageUrl?: string;
  selectedHumanId?: string;
  onSelect: (humanId: string) => void;
  onGenerate: (description: string, referenceImage?: string) => Promise<DigitalHuman[]>;
}
```

#### 2. CharacterDetailEditor ç»„ä»¶ âœ…

**æ–‡ä»¶**: `client/src/components/project/CharacterDetailEditor.tsx`

**åŠŸèƒ½**:
- å…¨å±æ¨¡æ€æ¡†ç¼–è¾‘å™¨
- å·¦å³åˆ†æ å¸ƒå±€ï¼ˆ2:3 æ¯”ä¾‹ï¼‰
- å·¦ä¾§ï¼šè§’è‰²ä¿¡æ¯ç¼–è¾‘è¡¨å•
- å³ä¾§ï¼šæ•°å­—äººç”Ÿæˆå™¨
- é›†æˆå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
- é›†æˆAIæè¿°ç”ŸæˆåŠŸèƒ½

**Props**:
```typescript
interface CharacterDetailEditorProps {
  character?: ProjectCharacter;
  projectId: string;
  onSubmit: (data: CreateCharacterRequest) => Promise<void>;
  onCancel: () => void;
}
```

#### 3. CharacterCard ç»„ä»¶æ”¹è¿› âœ…

**æ–‡ä»¶**: `client/src/components/project/CharacterCard.tsx`

**æ”¹è¿›ç‚¹**:
- è§’è‰²åç§°ç½®é¡¶
- "è§’è‰²å¤´åƒ" æ”¹ä¸º "è§’è‰²å‚è€ƒå›¾"
- å‚è€ƒå›¾æ˜¾ç¤ºä¸º 4:3 æ¯”ä¾‹
- æ–°å¢ `onGenerateDigitalHuman` å›è°ƒ
- æ–°å¢"ç”Ÿæˆè§’è‰²æ•°å­—äºº"æŒ‰é’®
- ä¼˜åŒ–æ‚¬åœæ•ˆæœï¼ˆæ“ä½œæŒ‰é’®æ‚¬åœæ˜¾ç¤ºï¼‰

### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° ProjectDetail é¡µé¢

**æ–‡ä»¶**: `client/src/pages/ProjectDetail.tsx`

**éœ€è¦ä¿®æ”¹çš„åœ°æ–¹**:

1. **å¯¼å…¥æ–°ç»„ä»¶**:
```typescript
import CharacterDetailEditor from '../components/project/CharacterDetailEditor';
```

2. **æ·»åŠ çŠ¶æ€ç®¡ç†**:
```typescript
const [showDetailEditor, setShowDetailEditor] = useState(false);
const [editingCharacter, setEditingCharacter] = useState<ProjectCharacter | undefined>();
```

3. **ä¿®æ”¹æ·»åŠ /ç¼–è¾‘è§’è‰²çš„å¤„ç†**:
```typescript
const handleAddCharacter = () => {
  setEditingCharacter(undefined);
  setShowDetailEditor(true);
  setError('');
};

const handleEditCharacter = (character: ProjectCharacter) => {
  setEditingCharacter(character);
  setShowDetailEditor(true);
  setError('');
};

const handleGenerateDigitalHuman = (character: ProjectCharacter) => {
  setEditingCharacter(character);
  setShowDetailEditor(true);
  setError('');
};
```

4. **æ›´æ–° CharacterCard è°ƒç”¨**:
```typescript
<CharacterCard
  key={character.id}
  character={character}
  onEdit={handleEditCharacter}
  onDelete={handleDeleteCharacter}
  onGenerateDigitalHuman={handleGenerateDigitalHuman}
/>
```

5. **æ›¿æ¢è¡¨å•æ¸²æŸ“**:
```typescript
{/* æ—§çš„ CharacterForm */}
{showForm && id && (
  <CharacterForm
    projectId={id}
    character={editingCharacter}
    onSubmit={handleSubmitCharacter}
    onCancel={handleCancelForm}
  />
)}

{/* æ–°çš„ CharacterDetailEditor */}
{showDetailEditor && id && (
  <CharacterDetailEditor
    projectId={id}
    character={editingCharacter}
    onSubmit={handleSubmitCharacter}
    onCancel={() => setShowDetailEditor(false)}
  />
)}
```

### ç¬¬å››æ­¥ï¼šå®ç°åç«¯API

#### 1. æ•°å­—äººç”ŸæˆAPI

**è·¯ç”±**: `POST /api/projects/:id/characters/:characterId/generate-digital-humans`

**è¯·æ±‚ä½“**:
```typescript
{
  description: string;
  referenceImageUrl?: string;
  count?: number; // é»˜è®¤ 4
}
```

**å“åº”**:
```typescript
{
  digitalHumans: DigitalHuman[];
}
```

**å®ç°å»ºè®®**:
- é›†æˆ Stable Diffusion API æˆ– Midjourney API
- ä½¿ç”¨é˜Ÿåˆ—å¤„ç†ç”Ÿæˆè¯·æ±‚ï¼ˆé¿å…è¶…æ—¶ï¼‰
- å®ç°ç”Ÿæˆè¿›åº¦æŸ¥è¯¢æ¥å£
- æ·»åŠ å†…å®¹å®¡æ ¸æœºåˆ¶

#### 2. æ•°å­—äººå†å²è®°å½•API

**è·¯ç”±**: `GET /api/projects/:id/characters/:characterId/digital-humans`

**å“åº”**:
```typescript
{
  digitalHumans: DigitalHuman[];
  total: number;
}
```

#### 3. é€‰æ‹©æ•°å­—äººAPI

**è·¯ç”±**: `PUT /api/projects/:id/characters/:characterId/digital-humans/:humanId/select`

**åŠŸèƒ½**: å°†æŒ‡å®šçš„æ•°å­—äººè®¾ç½®ä¸ºé€‰ä¸­çŠ¶æ€

### ç¬¬äº”æ­¥ï¼šæ•°æ®åº“è¿ç§»

#### åˆ›å»º DigitalHuman è¡¨

```prisma
model DigitalHuman {
  id          String   @id @default(cuid())
  characterId String
  character   ProjectCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  imageUrl    String
  prompt      String   @db.Text
  isSelected  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([characterId])
  @@index([characterId, isSelected])
}
```

#### æ›´æ–° ProjectCharacter æ¨¡å‹

```prisma
model ProjectCharacter {
  // ... åŸæœ‰å­—æ®µ
  digitalHumans DigitalHuman[]
}
```

### ç¬¬å…­æ­¥ï¼šé›†æˆAIå›¾åƒç”ŸæˆæœåŠ¡

#### é€‰é¡¹1ï¼šStable Diffusionï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**:
- å¼€æºå…è´¹
- å¯è‡ªéƒ¨ç½²
- ç”Ÿæˆè´¨é‡é«˜

**å®ç°**:
```typescript
// lib/ai/image-generator.ts
import { StableDiffusionAPI } from '@stability-ai/sdk';

export async function generateDigitalHumans(
  description: string,
  referenceImage?: string,
  count: number = 4
): Promise<string[]> {
  const api = new StableDiffusionAPI(process.env.STABILITY_API_KEY);

  const prompt = `professional portrait, ${description}, high quality, detailed, 4k`;

  const results = await Promise.all(
    Array.from({ length: count }, () =>
      api.textToImage({
        prompt,
        negativePrompt: 'low quality, blurry, distorted',
        width: 512,
        height: 768,
        samples: 1,
      })
    )
  );

  return results.map(r => r.artifacts[0].base64);
}
```

#### é€‰é¡¹2ï¼šMidjourneyï¼ˆé«˜è´¨é‡ï¼‰

**ä¼˜ç‚¹**:
- ç”Ÿæˆè´¨é‡æœ€é«˜
- è‰ºæœ¯é£æ ¼å¤šæ ·

**ç¼ºç‚¹**:
- éœ€è¦ä»˜è´¹
- API é™åˆ¶è¾ƒå¤š

#### é€‰é¡¹3ï¼šDALL-E 3ï¼ˆç®€å•æ˜“ç”¨ï¼‰

**ä¼˜ç‚¹**:
- OpenAI å®˜æ–¹æ”¯æŒ
- API ç®€å•æ˜“ç”¨

**ç¼ºç‚¹**:
- æˆæœ¬è¾ƒé«˜
- ç”Ÿæˆé€Ÿåº¦è¾ƒæ…¢

### ç¬¬ä¸ƒæ­¥ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

#### 1. æ·»åŠ åŠ è½½çŠ¶æ€

```typescript
// ç”Ÿæˆä¸­çš„éª¨æ¶å±
<div className="grid grid-cols-2 gap-3">
  {Array.from({ length: 4 }).map((_, i) => (
    <div key={i} className="animate-pulse">
      <div className="w-full aspect-[3/4] bg-gray-200 rounded-lg" />
    </div>
  ))}
</div>
```

#### 2. æ·»åŠ é”™è¯¯å¤„ç†

```typescript
try {
  const newHumans = await onGenerate(characterDescription, referenceImageUrl);
  setCurrentBatch(newHumans);
} catch (error) {
  toast.error('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
  console.error('ç”Ÿæˆå¤±è´¥:', error);
}
```

#### 3. æ·»åŠ æˆåŠŸæç¤º

```typescript
toast.success('æˆåŠŸç”Ÿæˆ 4 ä¸ªæ•°å­—äººå½¢è±¡ï¼');
```

### ç¬¬å…«æ­¥ï¼šæ€§èƒ½ä¼˜åŒ–

#### 1. å›¾ç‰‡æ‡’åŠ è½½

```typescript
import { LazyLoadImage } from 'react-lazy-load-image-component';

<LazyLoadImage
  src={human.imageUrl}
  alt={`æ•°å­—äºº ${human.id}`}
  effect="blur"
  className="w-full aspect-[3/4] object-cover"
/>
```

#### 2. è™šæ‹Ÿæ»šåŠ¨ï¼ˆå†å²è®°å½•å¤šæ—¶ï¼‰

```typescript
import { FixedSizeGrid } from 'react-window';

<FixedSizeGrid
  columnCount={3}
  columnWidth={120}
  height={300}
  rowCount={Math.ceil(history.length / 3)}
  rowHeight={160}
  width={380}
>
  {({ columnIndex, rowIndex, style }) => {
    const index = rowIndex * 3 + columnIndex;
    const human = history[index];
    if (!human) return null;
    return (
      <div style={style}>
        <img src={human.imageUrl} alt="" />
      </div>
    );
  }}
</FixedSizeGrid>
```

#### 3. å›¾ç‰‡å‹ç¼©

```typescript
import imageCompression from 'browser-image-compression';

const compressImage = async (file: File) => {
  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
  };
  return await imageCompression(file, options);
};
```

## ğŸ§ª æµ‹è¯•æ¸…å•

### å•å…ƒæµ‹è¯•

- [ ] DigitalHumanGenerator ç»„ä»¶æ¸²æŸ“
- [ ] CharacterDetailEditor è¡¨å•éªŒè¯
- [ ] CharacterCard äº‹ä»¶å¤„ç†
- [ ] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
- [ ] AI ç”ŸæˆåŠŸèƒ½

### é›†æˆæµ‹è¯•

- [ ] åˆ›å»ºè§’è‰²æµç¨‹
- [ ] ç¼–è¾‘è§’è‰²æµç¨‹
- [ ] ç”Ÿæˆæ•°å­—äººæµç¨‹
- [ ] é€‰æ‹©æ•°å­—äººæµç¨‹
- [ ] ä¿å­˜è§’è‰²æµç¨‹

### E2E æµ‹è¯•

- [ ] å®Œæ•´çš„è§’è‰²åˆ›å»ºå’Œæ•°å­—äººç”Ÿæˆæµç¨‹
- [ ] å¤šæ¬¡ç”Ÿæˆå’Œé€‰æ‹©
- [ ] å†å²è®°å½•æŸ¥çœ‹
- [ ] å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

### æ€§èƒ½æµ‹è¯•

- [ ] å¤§é‡å†å²è®°å½•åŠ è½½æ€§èƒ½
- [ ] å›¾ç‰‡æ‡’åŠ è½½æ•ˆæœ
- [ ] å¹¶å‘ç”Ÿæˆè¯·æ±‚å¤„ç†

### å…¼å®¹æ€§æµ‹è¯•

- [ ] Chrome æœ€æ–°ç‰ˆ
- [ ] Firefox æœ€æ–°ç‰ˆ
- [ ] Safari æœ€æ–°ç‰ˆ
- [ ] Edge æœ€æ–°ç‰ˆ
- [ ] ç§»åŠ¨ç«¯æµè§ˆå™¨

## ğŸ“¦ ä¾èµ–åŒ…

éœ€è¦å®‰è£…çš„æ–°ä¾èµ–ï¼š

```bash
# å›¾ç‰‡å¤„ç†
pnpm add browser-image-compression

# æ‡’åŠ è½½
pnpm add react-lazy-load-image-component
pnpm add -D @types/react-lazy-load-image-component

# è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¯é€‰ï¼‰
pnpm add react-window
pnpm add -D @types/react-window

# Toast æç¤ºï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
pnpm add react-hot-toast
```

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡é…ç½®**:
```env
# AI å›¾åƒç”ŸæˆæœåŠ¡
STABILITY_API_KEY=your_stability_api_key
OPENAI_API_KEY=your_openai_api_key

# å›¾ç‰‡å­˜å‚¨
STORAGE_PROVIDER=ali-oss
ALI_OSS_BUCKET=your_bucket
ALI_OSS_REGION=your_region
```

2. **CDN é…ç½®**:
- ç”Ÿæˆçš„æ•°å­—äººå›¾ç‰‡åº”è¯¥ä¸Šä¼ åˆ° CDN
- é…ç½®å›¾ç‰‡ç¼“å­˜ç­–ç•¥
- å¯ç”¨å›¾ç‰‡å‹ç¼©å’Œæ ¼å¼è½¬æ¢

3. **ç›‘æ§å’Œæ—¥å¿—**:
- ç›‘æ§ AI ç”Ÿæˆ API çš„è°ƒç”¨æ¬¡æ•°å’Œæˆæœ¬
- è®°å½•ç”Ÿæˆå¤±è´¥çš„æƒ…å†µ
- ç›‘æ§å›¾ç‰‡å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ

## ğŸ“ åç»­ä»»åŠ¡

- [ ] å®ç°åç«¯ API
- [ ] æ•°æ®åº“è¿ç§»
- [ ] é›†æˆ AI å›¾åƒç”ŸæˆæœåŠ¡
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ  E2E æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

**æ›´æ–°æ—¥æœŸ**: 2026-01-28
**ç‰ˆæœ¬**: v1.0.0
