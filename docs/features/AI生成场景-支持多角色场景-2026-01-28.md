# AI 生成场景 - 支持多角色场景（方案 1）

**日期**: 2026-01-28
**类型**: Feature Enhancement
**方案**: 主要角色 + 配角列表

## 需求背景

### 问题

当前的场景设计只能选择一个主要角色（`characterId`），但实际上很多场景需要多个角色同时出现并互动。

**用户案例**：
```
场景：温情诊疗
动作："将茶杯稳稳放在父亲面前，眼神温柔地注视着他，微微点头示意"
涉及角色：
- 中医（执行动作）
- 父亲（接受动作）

当前问题：
- 只能选择中医作为主要角色
- 父亲的形象无法体现
- 无法保持角色一致性
```

### 需求

1. 场景中可以有多个角色
2. 需要知道每个角色在场景中的作用
3. 动作描述可以自然地包含多个角色的互动
4. UI 改动要相对较小

## 解决方案：方案 1（主要角色 + 配角列表）

### 数据结构设计

```typescript
interface SceneContent {
  characterId: string;  // 主要角色（执行主要动作的角色）
  otherCharacters?: Array<{
    characterId: string;
    role: string;  // 在场景中的角色描述
  }>;
  actions: {
    entrance: string;  // 可以描述多个角色的入场
    main: string;      // 可以描述多个角色的互动
    exit: string;      // 可以描述多个角色的出场
  };
  // ... 其他字段
}
```

### 设计理念

1. **保持主要角色概念**
   - `characterId` 是执行主要动作的角色
   - UI 改动小，向后兼容

2. **添加配角列表**
   - `otherCharacters` 是可选的数组
   - 每个配角有 `characterId` 和 `role` 描述

3. **动作描述支持多角色互动**
   - `entrance`、`main`、`exit` 可以自然地描述多个角色
   - 例如："将茶杯稳稳放在父亲面前，眼神温柔地注视着他"

## 实施细节

### 1. 更新接口定义

**文件**: `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts`

```typescript
interface SceneContent {
  description: string;
  characterId: string; // 主要角色ID
  otherCharacters?: Array<{
    characterId: string;
    role: string; // 在场景中的角色描述
  }>;
  actions: {
    entrance: string;
    main: string;
    exit: string;
  };
  // ... 其他字段
}
```

### 2. 更新 AI 提示词

#### 字段说明

```
"characterId": "主要角色ID（从角色列表中选择一个，执行主要动作的角色）",
"otherCharacters": [
  {
    "characterId": "其他角色ID（可选，场景中出现的其他角色）",
    "role": "角色描述（如：接受治疗的患者、旁观的家人、互动的朋友等）"
  }
],
"actions": {
  "entrance": "入场动作描述（可以描述多个角色的入场）",
  "main": "主要动作描述（可以描述多个角色的互动）",
  "exit": "出场动作描述（可以描述多个角色的出场）"
}
```

#### 场景创作要点

```
- **多角色场景处理**：
  * characterId 是主要角色（执行主要动作的角色）
  * 如果场景中有其他角色出现，使用 otherCharacters 数组添加
  * otherCharacters 中的 role 要描述该角色在场景中的作用
  * 动作描述可以自然地描述多个角色的互动
  * 例如："将茶杯稳稳放在父亲面前，眼神温柔地注视着他"
```

#### 示例

```json
{
  "title": "温情诊疗",
  "duration": 15,
  "content": {
    "description": "温馨的诊室里，老中医站在父亲身旁，灯光柔和，桌上摆放着茶具和药材，氛围宁静祥和",
    "characterId": "中医ID",
    "otherCharacters": [
      {
        "characterId": "父亲ID",
        "role": "接受治疗的患者"
      }
    ],
    "actions": {
      "entrance": "中医从药房走出，父亲已坐在椅子上等待",
      "main": "将茶杯稳稳放在父亲面前，眼神温柔地注视着他，微微点头示意",
      "exit": "中医转身回到药房，父亲起身离开"
    },
    "dialogues": [
      {
        "text": "这茶能帮你缓解疼痛，慢慢喝，别着急",
        "speaker": "老中医"
      },
      {
        "text": "谢谢您，这些天好多了",
        "speaker": "父亲"
      }
    ]
  }
}
```

## 使用场景

### 场景 1：单角色场景

```json
{
  "characterId": "主播ID",
  "otherCharacters": [],  // 或者省略此字段
  "actions": {
    "entrance": "从画面右侧走入",
    "main": "站在桌前展示产品",
    "exit": "挥手告别"
  }
}
```

### 场景 2：双角色互动

```json
{
  "characterId": "中医ID",
  "otherCharacters": [
    {
      "characterId": "父亲ID",
      "role": "接受治疗的患者"
    }
  ],
  "actions": {
    "entrance": "中医从药房走出，父亲已坐在椅子上等待",
    "main": "将茶杯稳稳放在父亲面前，眼神温柔地注视着他",
    "exit": "中医转身回到药房，父亲起身离开"
  }
}
```

### 场景 3：多角色场景

```json
{
  "characterId": "主持人ID",
  "otherCharacters": [
    {
      "characterId": "嘉宾1ID",
      "role": "访谈嘉宾"
    },
    {
      "characterId": "嘉宾2ID",
      "role": "访谈嘉宾"
    }
  ],
  "actions": {
    "entrance": "主持人引导两位嘉宾入座",
    "main": "三人围坐交谈，气氛热烈",
    "exit": "主持人起身送别嘉宾"
  }
}
```

## 优势

### 1. 灵活性

- ✅ 支持单角色场景
- ✅ 支持多角色场景
- ✅ 可以描述角色互动

### 2. 简洁性

- ✅ UI 改动小
- ✅ 不需要为每个角色单独设置动作
- ✅ 动作描述自然流畅

### 3. 兼容性

- ✅ `otherCharacters` 是可选的
- ✅ 现有的单角色场景不受影响
- ✅ 向后兼容

### 4. AI 友好

- ✅ AI 可以智能判断主要角色和配角
- ✅ 可以在动作描述中自然地描述多角色互动
- ✅ 提示词清晰易懂

## 对比其他方案

### 方案 2：每个角色独立动作

```typescript
{
  characters: [{
    characterId: string,
    actions: { entrance, main, exit }
  }]
}
```

**缺点**：
- ❌ UI 改动大
- ❌ 填写工作量大
- ❌ 不向后兼容

### 方案 3：简单的角色列表

```typescript
{
  characterIds: string[]
}
```

**缺点**：
- ❌ 无法区分主要角色和配角
- ❌ 无法描述每个角色的作用

## 修改的文件

1. **修改**: `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts`
   - 更新 `SceneContent` 接口，添加 `otherCharacters` 字段
   - 更新 AI 提示词，增加多角色场景处理说明
   - 提供多角色场景示例

## 测试验证

### 测试用例 1：单角色场景

**输入**:
- 项目主题: "产品评测"
- 角色: 数码博主

**预期输出**:
```json
{
  "characterId": "博主ID",
  "otherCharacters": [],
  "actions": {
    "main": "展示产品特性"
  }
}
```

### 测试用例 2：双角色互动

**输入**:
- 项目主题: "父亲腰痛的康复之路"
- 角色: 草根老中医、父亲

**预期输出**:
```json
{
  "characterId": "中医ID",
  "otherCharacters": [
    {
      "characterId": "父亲ID",
      "role": "接受治疗的患者"
    }
  ],
  "actions": {
    "main": "将茶杯稳稳放在父亲面前，眼神温柔地注视着他"
  }
}
```

### TypeScript 编译

```bash
✓ 无 generate-scenes 相关编译错误
```

## 用户体验提升

### 之前
- ❌ 只能选择一个角色
- ❌ 多角色互动无法体现
- ❌ 角色一致性难以保持

### 现在
- ✅ 可以有多个角色
- ✅ 可以描述角色互动
- ✅ 保持角色一致性
- ✅ 动作描述更自然

## 后续优化建议

### 1. UI 展示优化

在场景编辑器中：
- 显示主要角色
- 显示其他角色列表
- 显示每个角色的 role 描述

### 2. 角色关系可视化

可以考虑添加：
- 角色关系图
- 角色互动时间线
- 角色出场统计

### 3. 智能角色推荐

AI 可以根据剧本大概：
- 自动推荐哪些角色应该在同一场景
- 自动推荐角色的 role 描述
- 自动推荐角色互动方式

## 总结

通过实施方案 1（主要角色 + 配角列表），我们成功地：

1. ✅ 支持了多角色场景
2. ✅ 保持了 UI 的简洁性
3. ✅ 实现了向后兼容
4. ✅ 提供了清晰的 AI 提示词
5. ✅ 改善了用户体验

这个方案在灵活性和复杂度之间取得了很好的平衡，既满足了多角色场景的需求，又保持了系统的简洁性和易用性。
