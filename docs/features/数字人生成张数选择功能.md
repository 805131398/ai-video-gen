# 数字人生成张数选择功能

## 功能描述

为数字人生成器添加生成张数选择功能，用户可以选择一次生成 1 张、4 张或 8 张数字人图片。

## 需求来源

用户反馈：希望能够一次生成多张数字人图片，以便有更多选择。

## 功能设计

### UI 设计

采用与图片比例选择器相同的按钮组设计风格：
- 3 个按钮横向排列
- 每个按钮显示数字和"张"字
- 选中状态：紫色边框 + 紫色背景
- 未选中状态：灰色边框 + 白色背景
- 支持 hover 效果

### 选项

- **1 张**：快速生成，适合快速预览
- **4 张**：中等数量，提供多个选择
- **8 张**：大量生成，提供更多选择空间

### 默认值

默认选择 **1 张**，保持与之前的行为一致。

## 实现细节

### 前端修改

#### 1. DigitalHumanGenerator 组件

**文件**：`client/src/components/project/DigitalHumanGenerator.tsx`

##### 1.1 添加状态

```typescript
const [generateCount, setGenerateCount] = useState<1 | 4 | 8>(1);
```

##### 1.2 更新接口定义

```typescript
interface DigitalHumanGeneratorProps {
  // ... 其他属性
  onGenerate: (
    description: string,
    referenceImage?: string,
    aspectRatio?: string,
    count?: number  // 新增参数
  ) => Promise<void>;
}
```

##### 1.3 添加 UI

在图片比例选择器后面添加生成张数选择器：

```tsx
{/* 生成张数选择器 */}
<div className="space-y-2">
  <label className="block text-sm font-medium text-gray-700">
    生成张数
  </label>
  <div className="flex gap-3">
    <button
      type="button"
      onClick={() => setGenerateCount(1)}
      className={`flex-1 py-3 px-4 rounded-lg border-2 transition-all ${
        generateCount === 1
          ? 'border-purple-500 bg-purple-50 text-purple-700'
          : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
      }`}
    >
      <div className="flex flex-col items-center gap-1">
        <span className="text-2xl font-bold">1</span>
        <span className="text-xs font-medium">张</span>
      </div>
    </button>
    {/* 4 张和 8 张按钮类似 */}
  </div>
</div>
```

##### 1.4 修改生成逻辑

```typescript
const handleGenerate = async () => {
  // ...
  const sizeParam = aspectRatio === 'landscape' ? '1792x1024' : '1024x1792';
  await onGenerate(characterDescription, referenceImageUrl, sizeParam, generateCount);
  // ...
};
```

##### 1.5 更新按钮文本

```tsx
<button onClick={handleGenerate}>
  {generating ? (
    <>
      <Loader2 className="w-5 h-5 animate-spin" />
      AI 生成中...（{generateCount} 张）
    </>
  ) : (
    <>
      <Sparkles className="w-5 h-5" />
      生成角色数字人（{generateCount} 张）
    </>
  )}
</button>
```

#### 2. CharacterDetailEditor 组件

**文件**：`client/src/components/project/CharacterDetailEditor.tsx`

##### 2.1 更新函数签名

```typescript
const handleGenerateDigitalHumans = async (
  desc: string,
  refImage?: string,
  aspectRatio?: string,
  count?: number  // 新增参数
): Promise<void> => {
  // ...
};
```

##### 2.2 传递生成张数

```typescript
const result = await generateDigitalHumans(
  projectId,
  character.id,
  count || 1,  // 使用传入的 count 参数
  aspectRatio
);
```

##### 2.3 优化轮询逻辑

```typescript
const beforeCount = beforeDigitalHumans.length;
const expectedCount = count || 1;

while (attempts < maxAttempts) {
  await new Promise(resolve => setTimeout(resolve, 3000));

  const digitalHumans = await getDigitalHumans(projectId, character.id);
  const newCount = digitalHumans.length - beforeCount;

  // 检查是否生成了足够数量的图片
  if (newCount >= expectedCount) {
    console.log(`查询到新生成的数字人: ${newCount} 个（预期 ${expectedCount} 个）`);
    return;
  } else if (newCount > 0) {
    console.log(`已生成 ${newCount}/${expectedCount} 个数字人，继续等待...`);
  }

  attempts++;
}
```

### 后端支持

后端 API 已经支持 `count` 参数，无需修改：

```typescript
// web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts
const { count = 1, size = "1024x1792" } = body;

// 验证生成数量
if (count < 1 || count > 10) {
  return NextResponse.json(
    { error: "生成数量必须在 1-10 之间" },
    { status: 400 }
  );
}
```

## 用户体验优化

### 1. 进度提示

生成多张图片时，轮询逻辑会显示进度：
```
已生成 2/4 个数字人，继续等待...
已生成 3/4 个数字人，继续等待...
查询到新生成的数字人: 4 个（预期 4 个）
```

### 2. 按钮文本

按钮文本会显示当前选择的生成张数：
- 未生成时：`生成角色数字人（4 张）`
- 生成中：`AI 生成中...（4 张）`

### 3. 颜色区分

- 图片比例选择器：蓝色主题
- 生成张数选择器：紫色主题
- 便于用户区分不同的选项组

## 技术要点

### 1. 类型安全

使用 TypeScript 联合类型确保只能选择有效的张数：
```typescript
const [generateCount, setGenerateCount] = useState<1 | 4 | 8>(1);
```

### 2. 轮询优化

- 检查生成的数量是否达到预期
- 显示进度信息，让用户了解生成状态
- 支持部分成功（如预期 4 张，实际生成 3 张也会返回）

### 3. 默认值处理

在多个层级都设置了默认值 `1`，确保向后兼容：
- 组件状态默认值：`useState<1 | 4 | 8>(1)`
- 函数参数默认值：`count || 1`
- API 参数默认值：`count = 1`

### 4. UI 一致性

生成张数选择器的 UI 设计与图片比例选择器保持一致：
- 相同的布局结构
- 相同的交互方式
- 相同的视觉风格（仅颜色不同）

## 测试建议

### 测试场景

1. **选择 1 张生成**
   - 验证生成 1 张图片
   - 验证按钮文本显示正确

2. **选择 4 张生成**
   - 验证生成 4 张图片
   - 验证轮询进度显示
   - 验证生成时间（可能需要更长时间）

3. **选择 8 张生成**
   - 验证生成 8 张图片
   - 验证是否会超时（可能需要调整超时时间）

4. **切换选项**
   - 验证切换选项后，按钮文本更新
   - 验证生成时使用最新选择的张数

5. **与比例选择器组合**
   - 验证同时选择比例和张数
   - 验证生成的图片符合选择的比例

### 边界情况

1. **超时处理**
   - 生成 8 张图片可能需要很长时间
   - 当前超时时间为 3 分钟，可能需要根据实际情况调整

2. **部分成功**
   - 如果预期生成 4 张，但只成功生成 3 张
   - 当前逻辑会在 3 分钟后超时，但用户刷新后能看到 3 张

3. **网络问题**
   - 轮询过程中网络中断
   - 当前有错误处理，会继续尝试

## 后续优化建议

### 1. 动态超时时间

根据生成张数动态调整超时时间：
- 1 张：3 分钟
- 4 张：6 分钟
- 8 张：10 分钟

### 2. 实时进度

显示更详细的进度信息：
- 进度条
- 已生成 / 总数
- 预计剩余时间

### 3. 批量预览

生成多张图片后，提供批量预览功能：
- 网格视图
- 快速切换
- 批量选择

### 4. 生成策略

提供不同的生成策略：
- 串行生成：一张一张生成，稳定但慢
- 并行生成：同时生成多张，快但可能不稳定

## 相关文件

- `client/src/components/project/DigitalHumanGenerator.tsx` - 数字人生成器组件
- `client/src/components/project/CharacterDetailEditor.tsx` - 角色编辑器组件
- `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts` - 后端生成 API

## 效果截图

（建议添加实际的 UI 截图）

## 版本信息

- 功能添加日期：2026-01-28
- 相关 Issue：无
- 相关 PR：待创建
