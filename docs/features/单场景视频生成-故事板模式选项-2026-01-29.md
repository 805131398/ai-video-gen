# 单场景视频生成 - 添加故事板模式选项

**日期**: 2026-01-29
**类型**: 功能增强
**影响范围**: Web API - 单场景视频生成接口

## 功能概述

为单场景视频生成接口添加故事板模式选项，让用户可以选择使用普通格式或故事板格式生成视频。

## 修改内容

### 接口
**`POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video`**

### 新增参数

```typescript
{
  // 原有参数
  promptType?: "smart_combine" | "ai_optimized";
  referenceImage?: string;
  aspectRatio?: string;
  duration?: number;
  hd?: boolean;

  // 新增参数
  useStoryboard?: boolean;        // 是否使用故事板格式（默认 false）
  useCharacterImage?: boolean;    // 是否使用角色形象（默认 true，仅当 useStoryboard=true 时有效）
}
```

## 使用方式

### 1. 普通模式（默认）

```typescript
POST /api/projects/{id}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "promptType": "smart_combine",
  "aspectRatio": "16:9",
  "referenceImage": "https://example.com/image.jpg"  // 手动指定参考图
}
```

### 2. 故事板模式

```typescript
POST /api/projects/{id}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "useStoryboard": true,          // 启用故事板格式
  "useCharacterImage": true,      // 自动使用角色形象（默认）
  "aspectRatio": "16:9"
}
```

### 3. 故事板模式 + 手动指定参考图

```typescript
POST /api/projects/{id}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "useStoryboard": true,
  "referenceImage": "https://example.com/custom-image.jpg",  // 手动指定优先
  "aspectRatio": "9:16"
}
```

### 4. 故事板模式 + 不使用角色形象

```typescript
POST /api/projects/{id}/scripts/{scriptId}/scenes/{sceneId}/generate-video
{
  "useStoryboard": true,
  "useCharacterImage": false,     // 纯文生视频
  "aspectRatio": "16:9"
}
```

## 响应格式

```json
{
  "success": true,
  "message": "视频生成任务已提交",
  "mode": "storyboard",           // "normal" 或 "storyboard"
  "videoId": "video-id",
  "taskId": "task-id",
  "sceneId": "scene-id",
  "sceneTitle": "场景标题",
  "referenceImage": "https://..."  // 使用的参考图（如果有）
}
```

## 工作流程

### 普通模式流程
```
1. 使用 buildVideoPrompt 构建普通格式 prompt
2. 使用用户提供的 referenceImage（如果有）
3. 调用 bltcy API 生成视频
```

### 故事板模式流程
```
1. 使用 buildSceneStoryboardPrompt 构建故事板格式 prompt
2. 如果 useCharacterImage=true 且没有手动指定 referenceImage：
   - 自动获取场景主要角色的数字人形象
   - 优先级：已选中的数字人 > 角色头像 > 无
3. 调用 bltcy API 生成视频
```

## Prompt 格式对比

### 普通格式
```
closeup fixed shot, push movement. 昏黄的夕阳透过窗户，洒在略显凌乱的餐桌上，父亲躲在客厅阴影处，正急促地往嘴里塞半块点心，眼神中透着不安。. Character: 父亲. Action: 颤抖着手从兜里掏出半块点心塞进嘴里...
```

### 故事板格式
```
Shot 1:
duration: 12sec
Scene: 昏黄的夕阳透过窗户，洒在略显凌乱的餐桌上。父亲颤抖着手从兜里掏出半块点心塞进嘴里。Camera: 镜头从窗外的夕阳缓缓推向父亲颤抖的双手。Visual: 夕阳的光影感极强，营造出一种无奈而沉重的氛围。父亲: "就吃这一小口，应该没事吧……"
```

## 参考图优先级

### 普通模式
- 使用用户手动指定的 `referenceImage`
- 如果没有指定，则不使用参考图（纯文生视频）

### 故事板模式
1. **手动指定的 referenceImage**（最高优先级）
2. **角色的数字人形象**（如果 useCharacterImage=true）
   - 已选中的数字人形象
   - 角色头像
3. **无参考图**（纯文生视频）

## 数据存储

### 普通模式
```json
{
  "promptType": "smart_combine",
  "metadata": {}
}
```

### 故事板模式
```json
{
  "promptType": "smart_combine_storyboard",
  "metadata": {
    "mode": "storyboard",
    "useCharacterImage": true,
    "referenceImage": "https://..."
  }
}
```

## 优势

### 1. 灵活性
- 用户可以根据需求选择模式
- 支持手动指定参考图或自动获取
- 兼容现有功能

### 2. 易用性
- 默认行为不变（普通模式）
- 故事板模式自动处理角色形象
- 参数简单明了

### 3. 可扩展性
- 未来可以添加更多模式
- 参数设计灵活
- 不影响现有代码

## 使用建议

### 推荐使用普通模式的场景
1. 需要精细控制 prompt 格式
2. 已有自定义的参考图
3. 不需要角色形象

### 推荐使用故事板模式的场景
1. 希望使用角色的数字人形象
2. 追求更好的视频连贯性
3. 快速生成，减少手动配置

## 相关文件

### 修改文件
- `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

### 新增函数
- `buildSceneStoryboardPrompt()` - 构建故事板格式 prompt
- `getCharacterImage()` - 获取角色数字人形象

## 测试建议

1. **普通模式测试**:
   - 测试不传 useStoryboard（默认行为）
   - 测试 useStoryboard=false
   - 验证 prompt 格式正确

2. **故事板模式测试**:
   - 测试 useStoryboard=true
   - 测试有角色的场景
   - 测试无角色的场景
   - 验证故事板格式正确

3. **参考图测试**:
   - 测试手动指定 referenceImage
   - 测试自动获取角色形象
   - 测试角色无形象的情况

4. **组合测试**:
   - 故事板 + 手动参考图
   - 故事板 + 自动角色形象
   - 故事板 + 不使用角色形象

## 总结

本次修改为单场景视频生成接口添加了故事板模式选项：

- ✅ 添加 `useStoryboard` 参数
- ✅ 添加 `useCharacterImage` 参数
- ✅ 自动构建故事板格式 prompt
- ✅ 自动获取角色数字人形象
- ✅ 灵活的参考图优先级
- ✅ 向后兼容，默认行为不变

用户现在可以在单个接口中灵活选择生成模式，获得更好的使用体验。
