# 视频生成页面重设计 - 实施完成

## 日期
2026-02-14

## 概述
将视频生成从弹窗模式改为全页面视图，让用户能审查/编辑 AI 提示词，查看角色和场景信息，并记录生成操作快照用于追溯。

## 实施内容

### 后端变更

**Prisma Schema（web/prisma/schema.prisma）**
- `AIUsageLog` 增加 `requestUrl`、`requestBody`、`responseBody` 三个字段，用于记录 AI 服务调用详情
- 新增 `ApiRequestLog` 模型，用于通用 API 请求日志

**新增 API：preview-prompt**
- 路径：`POST /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/preview-prompt`
- 接收 `promptType`、`useStoryboard`、`useCharacterImage` 参数
- 返回 `{ success, prompt, characterInfo }`，复用 generate-video 中的提示词生成逻辑

**修改 API：generate-video**
- 新增 `customPrompt` 可选字段
- 传入 `customPrompt` 时直接使用用户编辑后的提示词，跳过服务端重新生成

### 客户端变更

**类型定义（client/src/types/index.ts）**
- 新增 `PreviewPromptRequest`、`PreviewPromptResponse`、`GenerationSnapshot` 类型
- `ElectronAPI` 接口增加 `saveGenerationSnapshot`、`getGenerationSnapshots` 方法

**服务层（client/src/services/script.ts）**
- 新增 `previewPrompt()` 函数
- `generateSceneVideo()` 支持 `customPrompt` 参数

**SQLite 数据库（client/electron/database.ts）**
- 新增 `generation_snapshots` 表，记录每次生成操作的完整快照
- 新增 `saveGenerationSnapshot()`、`getGenerationSnapshots()` 方法
- IPC 处理器注册（main.ts + preload.ts）

**本地数据服务（client/src/services/localDataService.ts）**
- 新增 `saveGenerationSnapshot()`、`getGenerationSnapshots()` 封装方法

**新页面：SceneVideoGenerate（client/src/pages/SceneVideoGenerate.tsx）**
- 路由：`/projects/:id/script/:scriptId/scenes/:sceneId/generate`
- 左右分栏布局（40% / 60%）
- 左侧：角色与表演卡片、场景描述卡片、镜头&视觉标签卡片、编辑场景链接
- 右侧：提示词 textarea（自动加载+可编辑）、生成选项（宽高比/时长）、高级设置（折叠）、开始生成按钮
- 生成前保存快照到本地 SQLite，生成后跳转回视频列表页

**路由与页面改造**
- `App.tsx` 注册新路由
- `SceneVideos.tsx` "生成新视频"按钮改为 `navigate` 跳转（移除 VideoGenerateDialog 引用）

## 涉及文件

| 操作 | 文件 |
|------|------|
| 修改 | `web/prisma/schema.prisma` |
| 新增 | `web/src/app/api/.../preview-prompt/route.ts` |
| 修改 | `web/src/app/api/.../generate-video/route.ts` |
| 修改 | `client/src/types/index.ts` |
| 修改 | `client/src/services/script.ts` |
| 修改 | `client/src/services/localDataService.ts` |
| 修改 | `client/electron/database.ts` |
| 修改 | `client/electron/preload.ts` |
| 修改 | `client/electron/main.ts` |
| 新增 | `client/src/pages/SceneVideoGenerate.tsx` |
| 修改 | `client/src/App.tsx` |
| 修改 | `client/src/pages/SceneVideos.tsx` |
