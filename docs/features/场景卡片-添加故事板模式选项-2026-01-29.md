# 场景卡片 - 添加故事板模式选项

**日期**: 2026-01-29
**类型**: 前端功能增强
**影响范围**: Client - 剧本场景页面

## 修改内容

### 文件
- `client/src/pages/ProjectScript.tsx`
- `client/src/services/script.ts`

### 新增功能

在剧本场景页面（ProjectScript）的头部添加了故事板模式全局选项，让用户可以选择使用哪种模式生成场景视频。

## UI 组件

### 1. 全局故事板模式开关
- 位置：页面头部，"保存并返回"按钮左侧
- 样式：浅灰色背景，带边框的容器
- 功能：切换故事板模式开关，应用于所有场景视频生成

### 2. 信息图标（Info Icon）
- 位置：复选框右侧
- 功能：鼠标悬浮显示详细说明
- 样式：深色背景的提示框，带箭头指示

### 3. 提示内容

**故事板模式：**
- 使用故事板格式生成视频
- 自动使用角色的数字人形象作为参考图
- 视频效果更连贯
- 适合有角色形象的场景

**单独生成模式：**
- 使用普通格式生成视频
- 纯文生视频
- 适合没有角色形象或需要更灵活控制的场景

## 代码实现

### 状态管理
```typescript
const [useStoryboard, setUseStoryboard] = useState(false);
```

### API 调用
```typescript
const result = await generateSceneVideo(id, scriptId, sceneId, {
  promptType: 'smart_combine',
  useStoryboard,
  useCharacterImage: true, // 默认使用角色形象
});
```

### 成功消息
```typescript
const modeText = useStoryboard ? '故事板模式' : '单独生成模式';
alert(`视频生成任务已提交！\n模式: ${modeText}\n${result.message}\n\n视频将在后台生成，请稍后刷新查看进度。`);
```

### Service 函数更新
```typescript
export const generateSceneVideo = async (
  projectId: string,
  scriptId: string,
  sceneId: string,
  options?: {
    promptType?: 'smart_combine' | 'ai_optimized';
    useStoryboard?: boolean;
    useCharacterImage?: boolean;
    referenceImage?: string;
    aspectRatio?: string;
    duration?: number;
    hd?: boolean;
  }
): Promise<{ taskId: string; message: string; sceneCount: number }> => {
  const response = await api.post(
    `/projects/${projectId}/scripts/${scriptId}/scenes/${sceneId}/generate-video`,
    options
  );
  return response.data;
};
```

## 视觉效果

```
┌─────────────────────────────────────────────────────────────┐
│  剧本标题                                                     │
│  角色: 角色名                                                 │
│                                                               │
│  ☑ 故事板模式 ⓘ │ 💾 保存并返回                              │
└─────────────────────────────────────────────────────────────┘
           ↑                ↑
           复选框          悬浮提示
```

鼠标悬浮在 ⓘ 图标上时，显示深色提示框：

```
┌──────────────────────────────────────┐
│ ✓ 故事板模式：                        │
│   使用故事板格式生成视频...           │
│                                      │
│ ✓ 单独生成模式：                      │
│   使用普通格式生成视频...             │
└──────────────────────────────────────┘
              ▼
```

## 用户体验

### 默认行为
- 默认不勾选（单独生成模式）
- 保持向后兼容

### 交互流程
1. 用户在页面头部勾选"故事板模式"复选框
2. 鼠标悬浮在 ⓘ 图标上查看说明
3. 点击任意场景卡片的"生成视频"按钮
4. 系统使用选择的模式生成视频
5. 显示成功消息，包含选择的模式

### 提示信息
- 成功消息中显示选择的模式
- 帮助用户确认使用的是哪种模式

## 样式特点

### 复选框容器
- 背景：`bg-slate-50`
- 边框：`border-slate-200`
- 内边距：`px-3 py-2`
- 圆角：`rounded-lg`

### 信息提示框
- 背景：`bg-slate-900`（深色）
- 文字：白色
- 宽度：`w-72`（固定宽度）
- 阴影：`shadow-lg`
- 动画：淡入淡出效果
- 箭头：底部中间位置

### 颜色区分
- 故事板模式：紫色高亮（`text-purple-300`）
- 单独生成模式：蓝色高亮（`text-blue-300`）

## 响应式设计

- 提示框固定宽度，确保内容完整显示
- 使用 `group` 和 `group-hover` 实现悬浮效果
- 提示框位置：底部上方，右对齐
- z-index: 50，确保在其他元素之上

## 与其他页面的一致性

### ScriptEditor.tsx
- 同样的 UI 设计和交互模式
- 同样的提示内容
- 一致的用户体验

### ProjectScript.tsx（本页面）
- 全局开关应用于所有场景
- 简化用户操作，无需为每个场景单独设置

## 测试建议

1. **功能测试**:
   - 勾选/取消勾选复选框
   - 点击不同场景的"生成视频"按钮
   - 验证 API 调用参数正确
   - 验证成功消息显示正确

2. **UI 测试**:
   - 鼠标悬浮显示提示框
   - 提示框位置和样式正确
   - 响应式布局正常

3. **交互测试**:
   - 复选框状态保持
   - 提示框淡入淡出动画
   - 不同模式的生成结果

4. **集成测试**:
   - 与后端 API 的集成
   - 故事板模式下角色形象的自动获取
   - 视频生成任务的提交和状态查询

## 总结

本次修改为场景卡片页面添加了故事板模式选项：

- ✅ 添加全局复选框让用户选择模式
- ✅ 添加信息图标和悬浮提示
- ✅ 详细说明两种模式的区别
- ✅ 成功消息显示选择的模式
- ✅ 更新 service 函数支持新参数
- ✅ 美观的 UI 设计
- ✅ 流畅的交互体验
- ✅ 与 ScriptEditor 页面保持一致

用户现在可以在场景页面中轻松选择视频生成模式，并通过悬浮提示了解每种模式的特点和适用场景。全局开关设计简化了操作流程，提升了用户体验。
