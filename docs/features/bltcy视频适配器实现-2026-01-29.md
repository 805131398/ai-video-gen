# bltcy 视频适配器实现

**日期**: 2026-01-29
**类型**: 功能新增
**影响范围**: Web AI 服务 - 视频生成适配器

## 功能概述

为视频生成服务添加 bltcy 提供商支持。bltcy 提供文生视频和图生视频功能，采用异步任务模式，支持任务提交和状态查询。

## API 规格

### 1. 文生视频 / 图生视频

**端点**: `POST /v2/videos/generations`

**请求参数**:
```json
{
  "prompt": "string",           // 提示词（必填）
  "model": "sora-2",            // 模型名称（必填）
  "aspect_ratio": "16:9",       // 宽高比（可选，默认 16:9）
  "hd": false,                  // 是否高清（可选，默认 false）
  "duration": "10",             // 时长（字符串，可选，默认 10）
  "images": ["string"],         // 图片 URL 数组（图生视频时使用）
  "watermark": true,            // 是否添加水印（可选）
  "private": true,              // 是否私有（可选）
  "notify_hook": "string"       // 通知回调 URL（可选）
}
```

**响应**:
```json
{
  "id": "task_id",              // 任务 ID
  "status": "pending",          // 任务状态
  ...
}
```

### 2. 查询视频状态

**端点**: `GET /v2/videos/generations/{id}`

**响应**:
```json
{
  "id": "task_id",
  "status": "completed",        // pending | processing | completed | failed
  "video_url": "https://...",   // 视频 URL（完成时）
  "thumbnail_url": "https://...", // 缩略图 URL（可选）
  "duration": 10,               // 视频时长（秒）
  ...
}
```

## 实现细节

### 1. 类型定义更新 (`types/index.ts`)

#### 添加 VideoProvider 类型

```typescript
export type VideoProvider =
  | "sora"
  | "runway"
  | "pika"
  | "kling"
  | "minimax"
  | "zhipu-video"
  | "fal-video"
  | "bltcy"            // 新增
  | "custom";
```

#### 添加默认配置

```typescript
export const VIDEO_FORMAT_DEFAULTS: Record<string, Partial<VideoConfigOptions>> = {
  // ... 其他提供商
  bltcy: {
    provider: "bltcy",
    submitEndpoint: "/v2/videos/generations",
    statusEndpoint: "/v2/videos/generations/{task_id}",
    authHeader: "Authorization",
    authPrefix: "Bearer ",
    taskIdPath: "id",
    taskStatusPath: "status",
    videoUrlPath: "video_url",
    pollInterval: 5000,
    maxWaitTime: 600000,
    defaultDuration: 10,
    defaultAspectRatio: "16:9",
  },
};
```

### 2. 视频客户端更新 (`video-client.ts`)

#### 请求体构建逻辑

在 `buildRequestBody` 方法中添加 bltcy 的处理：

```typescript
case "bltcy":
  body.prompt = request.prompt;
  body.model = this.modelName;
  body.aspect_ratio = request.aspectRatio || this.config.defaultAspectRatio || "16:9";
  body.hd = this.config.defaultResolution === "1080p" || this.config.defaultResolution === "hd";
  body.duration = String(request.duration || this.config.defaultDuration || 10);

  // 图生视频：如果提供了图片 URL，使用 images 数组
  if (request.imageUrl) {
    body.images = [request.imageUrl];
  }

  // 可选参数
  if (this.config.extraHeaders?.watermark !== undefined) {
    body.watermark = this.config.extraHeaders.watermark;
  }
  if (this.config.extraHeaders?.private !== undefined) {
    body.private = this.config.extraHeaders.private;
  }
  if (this.config.extraHeaders?.notify_hook) {
    body.notify_hook = this.config.extraHeaders.notify_hook;
  }
  break;
```

**关键特性**:
- ✅ 支持文生视频（仅 prompt）
- ✅ 支持图生视频（prompt + images）
- ✅ duration 转换为字符串格式
- ✅ hd 参数根据 defaultResolution 自动设置
- ✅ 支持可选参数（watermark、private、notify_hook）

### 3. 前端配置页面更新 (`admin/ai-config/[id]/page.tsx`)

添加 bltcy 到视频提供商选择列表：

```typescript
const VIDEO_PROVIDER_LABELS: Record<VideoProvider, string> = {
  sora: "Sora (OpenAI)",
  runway: "Runway",
  pika: "Pika Labs",
  kling: "可灵 (快手)",
  minimax: "MiniMax",
  "zhipu-video": "智谱 CogVideo",
  "fal-video": "fal.ai",
  bltcy: "bltcy",      // 新增
  custom: "自定义",
};
```

## 配置示例

### 在管理后台配置 bltcy 模型

1. 访问 `/admin/ai-config`
2. 点击"新增配置"
3. 选择模型类型：**视频生成**
4. 填写基本信息：
   - 提供商名称：`bltcy`
   - 模型名称：`sora-2`（或其他支持的模型）
   - API 地址：`https://api.bltcy.com`（替换为实际地址）
   - API Key：`your_api_key`
5. 高级配置：
   - 提供商：选择 **bltcy**
   - 默认时长：`10` 秒
   - 默认宽高比：`16:9`
   - 默认分辨率：`1080p`（启用 HD）

### 配置 JSON 示例

```json
{
  "provider": "bltcy",
  "defaultDuration": 10,
  "defaultAspectRatio": "16:9",
  "defaultResolution": "1080p",
  "pollInterval": 5000,
  "maxWaitTime": 600000,
  "extraHeaders": {
    "watermark": false,
    "private": true
  }
}
```

## 使用方式

### 1. 文生视频

```typescript
import { createVideoClient } from "@/lib/ai/video-client";

const client = createVideoClient({
  apiUrl: "https://api.bltcy.com",
  apiKey: "your_api_key",
  modelName: "sora-2",
  config: {
    provider: "bltcy",
    defaultDuration: 10,
    defaultAspectRatio: "16:9",
  },
});

// 提交任务
const result = await client.submit({
  prompt: "一只可爱的小猫在草地上玩耍",
  duration: 10,
  aspectRatio: "16:9",
});

console.log("任务 ID:", result.taskId);

// 查询状态
const status = await client.getStatus(result.taskId);
console.log("状态:", status.status);

// 或者直接等待完成
const completed = await client.generate({
  prompt: "一只可爱的小猫在草地上玩耍",
  duration: 10,
});

console.log("视频 URL:", completed.videoUrl);
```

### 2. 图生视频

```typescript
const result = await client.generate({
  prompt: "让这张图片动起来",
  imageUrl: "https://example.com/image.jpg",
  duration: 10,
  aspectRatio: "16:9",
});

console.log("视频 URL:", result.videoUrl);
```

## 异步任务流程

```
1. 提交任务 (submit)
   ↓
2. 获取任务 ID
   ↓
3. 轮询查询状态 (getStatus)
   ↓
4. 状态检查
   - pending → 继续轮询
   - processing → 继续轮询
   - completed → 返回视频 URL
   - failed → 抛出错误
   ↓
5. 返回结果
```

**轮询配置**:
- 轮询间隔：5 秒（`pollInterval: 5000`）
- 最大等待时间：10 分钟（`maxWaitTime: 600000`）

## 参数说明

### 必填参数

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| prompt | string | 视频生成提示词 | "一只可爱的小猫" |
| model | string | 模型名称 | "sora-2" |

### 可选参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| aspect_ratio | string | "16:9" | 宽高比 |
| hd | boolean | false | 是否高清 |
| duration | string | "10" | 视频时长（秒） |
| images | string[] | - | 图片 URL 数组（图生视频） |
| watermark | boolean | - | 是否添加水印 |
| private | boolean | - | 是否私有 |
| notify_hook | string | - | 通知回调 URL |

## 状态映射

bltcy API 返回的状态会被映射为标准状态：

| bltcy 状态 | 标准状态 | 说明 |
|------------|----------|------|
| pending, queued, submitted | pending | 等待处理 |
| processing, running, in_progress | processing | 处理中 |
| completed, succeeded, success, done | completed | 已完成 |
| failed, error, cancelled | failed | 失败 |

## 错误处理

### 常见错误

1. **任务提交失败**
   - 检查 API Key 是否正确
   - 检查 API 地址是否可访问
   - 检查请求参数是否符合规范

2. **任务超时**
   - 默认最大等待时间为 10 分钟
   - 可通过 `maxWaitTime` 配置调整

3. **视频生成失败**
   - 查看 `result.message` 获取错误信息
   - 检查 prompt 是否符合内容政策

## 测试建议

1. **配置测试**
   - 在管理后台添加 bltcy 配置
   - 验证配置保存成功

2. **文生视频测试**
   - 提交简单的文生视频任务
   - 验证任务 ID 返回
   - 验证状态查询正常
   - 验证视频生成成功

3. **图生视频测试**
   - 提供测试图片 URL
   - 验证图生视频功能

4. **异常测试**
   - 测试无效的 API Key
   - 测试超时场景
   - 测试失败任务的错误处理

## 相关文件

- 类型定义：`web/src/lib/ai/types/index.ts`
- 视频客户端：`web/src/lib/ai/video-client.ts`
- 配置页面：`web/src/app/admin/ai-config/[id]/page.tsx`

## 后续优化

1. **进度回调**：支持实时进度更新
2. **批量生成**：支持批量提交多个任务
3. **缓存机制**：缓存已完成的任务结果
4. **重试机制**：失败任务自动重试
5. **Webhook 支持**：支持任务完成通知

## 参考文档

- bltcy 文生视频 API: https://gpt-best.apifox.cn/api-358024351
- bltcy 图生视频 API: https://gpt-best.apifox.cn/api-358024500
