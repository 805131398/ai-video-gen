# 视频生成配置 — 动态接口与响应映射

## 背景

AI 工具配置页面原先所有工具类型共享扁平结构（baseUrl + apiKey + modelName）。视频生成（Sora API）有特殊需求：
- 三个接口（生成、状态查询、图片上传），各自有不同的请求参数和响应结构
- 异步任务模式，需要从响应中提取 taskId、videoUrl 等字段
- 不同供应商的 API 响应字段名可能不同，需要适配器模式

## 设计演进

经过三轮迭代：
1. v1 硬编码 Sora 参数 → 用户否决，不可扩展
2. v2 动态 ParamField 但扁平共享 → 用户指出接口应各自独立
3. v3 每接口独立配置 + 响应字段映射（最终方案）

## 核心数据结构

```typescript
// 动态参数字段（表单构建器模式）
interface ParamField {
  key: string;          // API 字段名，如 "metadata.n"
  label: string;        // 显示名称
  value: string | number | boolean;
  type: 'string' | 'number' | 'boolean' | 'select';
  options?: (string | number)[];  // select 类型的可选值
  remark?: string;
  required?: boolean;
}

// 响应字段映射（适配器模式）
interface ResponseField {
  key: string;    // 内部标准 key，如 "taskId", "videoUrl"
  label: string;
  path: string;   // API 响应中的 JSON 路径，如 "output.video_url"
  remark?: string;
}

// 单个接口配置
interface EndpointConfig {
  path: string;           // 接口路径，如 "/videos/generations"
  method: 'GET' | 'POST';
  params: ParamField[];
  responseMapping: ResponseField[];
}

// 视频生成总配置
interface VideoGenConfig {
  endpoints: {
    generate: EndpointConfig;  // 提交生成任务
    status: EndpointConfig;    // 查询任务状态
    upload: EndpointConfig;    // 上传图片（图生视频）
  };
}
```

`AiToolConfig.extraConfig` 字段在 `toolType === 'video_gen'` 时存储 `VideoGenConfig`。

## Sora 预设模板

内置 `SORA_DEFAULT_VIDEO_CONFIG` 作为新建视频配置时的默认值：

| 接口 | 方法 | 路径 | 请求参数 | 响应映射 |
|------|------|------|---------|---------|
| 生成 | POST | /videos/generations | model, duration, aspect_ratio, thumbnail, metadata.* | taskId → id |
| 状态查询 | GET | /videos/{taskId} | (无) | status, videoUrl, thumbnailUrl |
| 图片上传 | POST | /uploads | (无) | imageUrl → url |

## UI 实现

### 配置编辑 Dialog
- toolType 为 video_gen 时，表单底部展示接口配置区块
- Tab 切换三个接口：生成接口 / 状态查询 / 图片上传
- 每个接口显示：
  - 方法 + 路径输入
  - 请求参数列表（支持内联值编辑 + 弹窗编辑/新增/删除）
  - 响应映射列表（key → path 的映射关系，弹窗编辑）

### 配置卡片
- 视频类型卡片展示三个接口的 method + path 摘要

### 弹窗
- 参数编辑弹窗：key、label、类型、默认值、可选值（select）、备注、是否必填
- 响应映射弹窗：内部标识 key、显示名称、JSON 字段路径、备注

## 涉及文件

- `client/src/types/index.ts` — ParamField、ResponseField、EndpointConfig、VideoGenConfig 类型定义
- `client/src/pages/system/AiToolManagement.tsx` — 完整 UI 实现
