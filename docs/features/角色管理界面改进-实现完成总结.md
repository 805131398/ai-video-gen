# è§’è‰²ç®¡ç†ç•Œé¢æ”¹è¿› - å®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“å±‚ (Prisma Schema)

**æ–‡ä»¶**: `web/prisma/schema.prisma`

**æ”¹åŠ¨**:
- âœ… æ–°å¢ `DigitalHuman` æ¨¡å‹
- âœ… æ›´æ–° `ProjectCharacter` æ¨¡å‹ï¼Œæ·»åŠ  `digitalHumans` å…³è”
- âœ… ä¿®æ”¹æ³¨é‡Šï¼š`avatarUrl` ä»"è§’è‰²å¤´åƒ"æ”¹ä¸º"è§’è‰²å‚è€ƒå›¾"

**DigitalHuman æ¨¡å‹å­—æ®µ**:
```prisma
model DigitalHuman {
  id          String   @id @default(uuid())
  characterId String   @map("character_id")
  imageUrl    String   @map("image_url")
  prompt      String   @db.Text
  isSelected  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character ProjectCharacter @relation(...)

  @@index([characterId])
  @@index([characterId, isSelected])
}
```

### 2. åç«¯ API å±‚

#### 2.1 æ•°å­—äººåˆ—è¡¨ API âœ…
**æ–‡ä»¶**: `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/route.ts`

**ç«¯ç‚¹**: `GET /api/projects/:id/characters/:characterId/digital-humans`

**åŠŸèƒ½**:
- è·å–æŒ‡å®šè§’è‰²çš„æ‰€æœ‰æ•°å­—äººå†å²è®°å½•
- æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
- éªŒè¯é¡¹ç›®æ‰€æœ‰æƒå’Œè§’è‰²å½’å±

#### 2.2 æ•°å­—äººç”Ÿæˆ API âœ…
**æ–‡ä»¶**: `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts`

**ç«¯ç‚¹**: `POST /api/projects/:id/characters/:characterId/digital-humans/generate`

**åŠŸèƒ½**:
- è°ƒç”¨ AI å›¾åƒç”ŸæˆæœåŠ¡
- æ‰¹é‡ç”Ÿæˆ 1-10 ä¸ªæ•°å­—äººå½¢è±¡
- è‡ªåŠ¨æ„å»ºæç¤ºè¯ï¼ˆåŸºäºè§’è‰²åç§°å’Œæè¿°ï¼‰
- ä¿å­˜ç”Ÿæˆç»“æœåˆ°æ•°æ®åº“

**è¯·æ±‚å‚æ•°**:
```typescript
{
  count?: number; // ç”Ÿæˆæ•°é‡ï¼Œé»˜è®¤ 4
}
```

**æç¤ºè¯æ„å»ºé€»è¾‘**:
```typescript
professional portrait of {name}, {description},
high quality, detailed, 4k, studio lighting,
professional photography, realistic,
front facing, neutral expression,
clean background
```

#### 2.3 é€‰æ‹©æ•°å­—äºº API âœ…
**æ–‡ä»¶**: `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/[humanId]/select/route.ts`

**ç«¯ç‚¹**: `PUT /api/projects/:id/characters/:characterId/digital-humans/:humanId/select`

**åŠŸèƒ½**:
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åªæœ‰ä¸€ä¸ªæ•°å­—äººè¢«é€‰ä¸­
- å…ˆå–æ¶ˆè¯¥è§’è‰²çš„æ‰€æœ‰é€‰ä¸­çŠ¶æ€
- å†è®¾ç½®æŒ‡å®šæ•°å­—äººä¸ºé€‰ä¸­

### 3. å‰ç«¯æœåŠ¡å±‚

**æ–‡ä»¶**: `client/src/services/project.ts`

**æ–°å¢å‡½æ•°**:

```typescript
// è·å–æ•°å­—äººåˆ—è¡¨
getDigitalHumans(projectId, characterId): Promise<DigitalHuman[]>

// ç”Ÿæˆæ•°å­—äºº
generateDigitalHumans(projectId, characterId, count): Promise<DigitalHuman[]>

// é€‰æ‹©æ•°å­—äºº
selectDigitalHuman(projectId, characterId, humanId): Promise<DigitalHuman>
```

### 4. å‰ç«¯ç»„ä»¶å±‚

#### 4.1 DigitalHumanGenerator ç»„ä»¶ âœ…
**æ–‡ä»¶**: `client/src/components/project/DigitalHumanGenerator.tsx`

**åŠŸèƒ½**:
- å½“å‰é€‰ä¸­å½¢è±¡å±•ç¤ºï¼ˆå¤§å›¾+æ”¾å¤§é¢„è§ˆï¼‰
- AI ç”ŸæˆæŒ‰é’®ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
- å½“å‰æ‰¹æ¬¡å±•ç¤ºï¼ˆ2åˆ—ç½‘æ ¼ï¼‰
- å†å²è®°å½•å±•ç¤ºï¼ˆ3åˆ—ç½‘æ ¼ï¼Œå¯æ»šåŠ¨ï¼‰
- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†

**Props**:
```typescript
interface DigitalHumanGeneratorProps {
  characterId: string;
  characterName: string;
  characterDescription: string;
  referenceImageUrl?: string;
  selectedHumanId?: string;
  onSelect: (humanId: string) => void;
  onGenerate: (description: string, referenceImage?: string) => Promise<DigitalHuman[]>;
}
```

#### 4.2 CharacterDetailEditor ç»„ä»¶ âœ…
**æ–‡ä»¶**: `client/src/components/project/CharacterDetailEditor.tsx`

**åŠŸèƒ½**:
- å…¨å±æ¨¡æ€æ¡†ç¼–è¾‘å™¨
- å·¦å³åˆ†æ å¸ƒå±€ï¼ˆ40% : 60%ï¼‰
- å·¦ä¾§ï¼šè§’è‰²ä¿¡æ¯ç¼–è¾‘
- å³ä¾§ï¼šæ•°å­—äººç”Ÿæˆå™¨
- é›†æˆå›¾ç‰‡ä¸Šä¼ å’Œ AI æè¿°ç”Ÿæˆ
- é›†æˆçœŸå®çš„æ•°å­—äººç”Ÿæˆ API

**ç‰¹æ€§**:
- æ–°å»ºè§’è‰²æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰ characterIdï¼‰
- ç¼–è¾‘è§’è‰²æ—¶è°ƒç”¨çœŸå® API

#### 4.3 CharacterCard ç»„ä»¶æ”¹è¿› âœ…
**æ–‡ä»¶**: `client/src/components/project/CharacterCard.tsx`

**æ”¹è¿›ç‚¹**:
- âœ… è§’è‰²åç§°ç½®é¡¶
- âœ… "è§’è‰²å¤´åƒ" æ”¹ä¸º "è§’è‰²å‚è€ƒå›¾"
- âœ… å‚è€ƒå›¾æ˜¾ç¤ºä¸º 4:3 æ¯”ä¾‹
- âœ… æ–°å¢ `onGenerateDigitalHuman` å›è°ƒ
- âœ… æ–°å¢"ç”Ÿæˆè§’è‰²æ•°å­—äºº"æŒ‰é’®ï¼ˆæ¸å˜è‰²ï¼‰
- âœ… ä¼˜åŒ–æ‚¬åœæ•ˆæœ

### 5. å‰ç«¯é¡µé¢å±‚

**æ–‡ä»¶**: `client/src/pages/ProjectDetail.tsx`

**æ”¹åŠ¨**:
- âœ… å¯¼å…¥æ–°ç»„ä»¶ `CharacterDetailEditor`
- âœ… æ›¿æ¢ `showForm` ä¸º `showDetailEditor`
- âœ… æ–°å¢ `handleGenerateDigitalHuman` å¤„ç†å‡½æ•°
- âœ… æ–°å¢ `handleGenerateDigitalHumansForCharacter` API è°ƒç”¨
- âœ… æ–°å¢ `handleSelectDigitalHuman` API è°ƒç”¨
- âœ… æ›´æ–° `CharacterCard` ä¼ é€’ `onGenerateDigitalHuman` prop

### 6. ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `client/src/types/index.ts`

**æ–°å¢ç±»å‹**:
```typescript
// æ•°å­—äººå½¢è±¡
export interface DigitalHuman {
  id: string;
  characterId: string;
  imageUrl: string;
  prompt: string;
  isSelected: boolean;
  createdAt: string;
}

// ProjectCharacter æ‰©å±•
export interface ProjectCharacter {
  // ... åŸæœ‰å­—æ®µ
  digitalHumans?: DigitalHuman[];
}
```

### 7. æ–‡æ¡£

å·²åˆ›å»ºå®Œæ•´çš„æ–‡æ¡£ï¼š
- âœ… `docs/features/è§’è‰²ç®¡ç†ç•Œé¢UIæ”¹è¿›æ–¹æ¡ˆ.md` - è®¾è®¡æ–¹æ¡ˆ
- âœ… `docs/features/è§’è‰²ç®¡ç†ç•Œé¢æ”¹è¿›-å®ç°æŒ‡å—.md` - å®ç°æŒ‡å—
- âœ… `docs/features/è§’è‰²ç®¡ç†ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹.md` - ä½¿ç”¨ç¤ºä¾‹

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æ•°æ®åº“è¿ç§»

åœ¨ `web/` ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
pnpm db:generate

# åˆ›å»ºè¿ç§»
pnpm db:migrate

# æˆ–è€…ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
pnpm db:push
```

### 2. é…ç½® AI å›¾åƒç”ŸæˆæœåŠ¡

éœ€è¦åœ¨ AI é…ç½®ä¸­æ·»åŠ å›¾åƒç”Ÿæˆæ¨¡å‹é…ç½®ã€‚ç¡®ä¿ï¼š

1. **AI æ¨¡å‹é…ç½®è¡¨** ä¸­æœ‰ `IMAGE` ç±»å‹çš„é…ç½®
2. **é…ç½®äº†æœ‰æ•ˆçš„ API å¯†é’¥**ï¼ˆStable Diffusion / DALL-E / Midjourneyï¼‰
3. **å®ç°äº† `client.generateImage()` æ–¹æ³•**

æ£€æŸ¥æ–‡ä»¶ï¼š`web/src/lib/ai/client.ts`

### 3. æµ‹è¯•æµç¨‹

#### 3.1 åç«¯ API æµ‹è¯•

```bash
# 1. ç”Ÿæˆæ•°å­—äºº
curl -X POST http://localhost:3000/api/projects/{projectId}/characters/{characterId}/digital-humans/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{"count": 4}'

# 2. è·å–æ•°å­—äººåˆ—è¡¨
curl http://localhost:3000/api/projects/{projectId}/characters/{characterId}/digital-humans \
  -H "Authorization: Bearer {token}"

# 3. é€‰æ‹©æ•°å­—äºº
curl -X PUT http://localhost:3000/api/projects/{projectId}/characters/{characterId}/digital-humans/{humanId}/select \
  -H "Authorization: Bearer {token}"
```

#### 3.2 å‰ç«¯åŠŸèƒ½æµ‹è¯•

1. **åˆ›å»ºè§’è‰²**
   - ç‚¹å‡»"æ·»åŠ è§’è‰²"
   - å¡«å†™è§’è‰²åç§°å’Œæè¿°
   - ä¸Šä¼ å‚è€ƒå›¾
   - ç‚¹å‡»"ç”Ÿæˆè§’è‰²æ•°å­—äºº"
   - ä»å€™é€‰ä¸­é€‰æ‹©ä¸€ä¸ª
   - ä¿å­˜è§’è‰²

2. **ç¼–è¾‘è§’è‰²**
   - ç‚¹å‡»è§’è‰²å¡ç‰‡çš„"ç¼–è¾‘"æŒ‰é’®
   - ä¿®æ”¹è§’è‰²ä¿¡æ¯
   - é‡æ–°ç”Ÿæˆæ•°å­—äºº
   - é€‰æ‹©æ–°çš„æ•°å­—äºº
   - ä¿å­˜

3. **æŸ¥çœ‹å†å²è®°å½•**
   - å¤šæ¬¡ç”Ÿæˆæ•°å­—äºº
   - æŸ¥çœ‹å†å²è®°å½•åˆ—è¡¨
   - ä»å†å²è®°å½•ä¸­é€‰æ‹©

### 4. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

å¦‚æœå†å²è®°å½•è¾ƒå¤šï¼Œå¯ä»¥æ·»åŠ ï¼š

1. **åˆ†é¡µåŠ è½½**
```typescript
// API æ·»åŠ åˆ†é¡µå‚æ•°
GET /api/projects/:id/characters/:characterId/digital-humans?page=1&limit=20
```

2. **å›¾ç‰‡æ‡’åŠ è½½**
```bash
pnpm add react-lazy-load-image-component
```

3. **è™šæ‹Ÿæ»šåŠ¨**ï¼ˆå†å²è®°å½•è¶…è¿‡ 50 ä¸ªæ—¶ï¼‰
```bash
pnpm add react-window
```

## ğŸ› å·²çŸ¥é—®é¢˜å’Œæ³¨æ„äº‹é¡¹

### 1. AI å›¾åƒç”ŸæˆæœåŠ¡

**é—®é¢˜**: å½“å‰ä»£ç å‡è®¾ `client.generateImage()` æ–¹æ³•å·²å®ç°

**è§£å†³æ–¹æ¡ˆ**: éœ€è¦åœ¨ `web/src/lib/ai/client.ts` ä¸­å®ç°è¯¥æ–¹æ³•ï¼Œæˆ–è€…ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•ã€‚

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼ˆæµ‹è¯•ç”¨ï¼‰:
```typescript
// åœ¨ generate/route.ts ä¸­ä¸´æ—¶ä½¿ç”¨å ä½å›¾
const generatedImages = Array.from({ length: count }, (_, i) =>
  `https://via.placeholder.com/512x768/667eea/ffffff?text=Digital+Human+${i + 1}`
);
```

### 2. æ–°å»ºè§’è‰²æ—¶çš„æ•°å­—äººç”Ÿæˆ

**é—®é¢˜**: æ–°å»ºè§’è‰²æ—¶è¿˜æ²¡æœ‰ `characterId`ï¼Œæ— æ³•è°ƒç”¨ç”Ÿæˆ API

**å½“å‰æ–¹æ¡ˆ**: åœ¨ `CharacterDetailEditor` ä¸­æ£€æµ‹æ˜¯å¦ä¸ºæ–°å»ºï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

**æ”¹è¿›æ–¹æ¡ˆ**:
- æ–¹æ¡ˆ Aï¼šå…ˆä¿å­˜è§’è‰²ï¼Œå†ç”Ÿæˆæ•°å­—äºº
- æ–¹æ¡ˆ Bï¼šæ”¯æŒä¸´æ—¶ç”Ÿæˆï¼Œä¿å­˜æ—¶ä¸€èµ·æäº¤

### 3. å›¾ç‰‡å­˜å‚¨

**é—®é¢˜**: ç”Ÿæˆçš„æ•°å­—äººå›¾ç‰‡éœ€è¦å­˜å‚¨

**å½“å‰æ–¹æ¡ˆ**: AI æœåŠ¡è¿”å›çš„ URL ç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“

**æ³¨æ„äº‹é¡¹**:
- ç¡®ä¿ AI æœåŠ¡è¿”å›çš„æ˜¯æ°¸ä¹… URL
- æˆ–è€…éœ€è¦ä¸‹è½½å›¾ç‰‡å¹¶ä¸Šä¼ åˆ°è‡ªå·±çš„å­˜å‚¨æœåŠ¡

### 4. æˆæœ¬æ§åˆ¶

**é—®é¢˜**: AI å›¾åƒç”Ÿæˆå¯èƒ½äº§ç”Ÿè¾ƒé«˜æˆæœ¬

**å»ºè®®**:
- æ·»åŠ ç”¨æˆ·é…é¢é™åˆ¶ï¼ˆæ¯æ—¥/æ¯æœˆç”Ÿæˆæ¬¡æ•°ï¼‰
- æ·»åŠ ç”Ÿæˆç¡®è®¤æç¤ºï¼ˆæ˜¾ç¤ºé¢„è®¡æ¶ˆè€—ï¼‰
- è®°å½• AI ä½¿ç”¨æ—¥å¿—ï¼ˆå·²æœ‰ `AIUsageLog` è¡¨ï¼‰

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·æ“ä½œ
  â†“
ç‚¹å‡»"ç”Ÿæˆè§’è‰²æ•°å­—äºº"
  â†“
CharacterDetailEditor.handleGenerate()
  â†“
è°ƒç”¨ generateDigitalHumans(projectId, characterId, 4)
  â†“
POST /api/projects/:id/characters/:characterId/digital-humans/generate
  â†“
è·å– AI é…ç½® (getEffectiveAIConfig)
  â†“
æ„å»ºæç¤ºè¯ (buildDigitalHumanPrompt)
  â†“
è°ƒç”¨ AI æœåŠ¡ (client.generateImage)
  â†“
ä¿å­˜åˆ°æ•°æ®åº“ (prisma.digitalHuman.create)
  â†“
è¿”å›ç”Ÿæˆç»“æœ
  â†“
DigitalHumanGenerator æ˜¾ç¤ºå€™é€‰
  â†“
ç”¨æˆ·é€‰æ‹©ä¸€ä¸ª
  â†“
è°ƒç”¨ selectDigitalHuman(projectId, characterId, humanId)
  â†“
PUT /api/projects/:id/characters/:characterId/digital-humans/:humanId/select
  â†“
æ›´æ–°æ•°æ®åº“ï¼ˆäº‹åŠ¡ï¼šå–æ¶ˆå…¶ä»–é€‰ä¸­ + è®¾ç½®å½“å‰é€‰ä¸­ï¼‰
  â†“
å®Œæˆ
```

## ğŸ‰ åŠŸèƒ½äº®ç‚¹

1. **æŠ½å¡å¼ä½“éªŒ**: ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªå€™é€‰ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æœ€æ»¡æ„çš„
2. **å†å²è®°å½•**: æ‰€æœ‰ç”Ÿæˆçš„æ•°å­—äººéƒ½ä¿å­˜ï¼Œå¯éšæ—¶åˆ‡æ¢
3. **å·¦å³åˆ†æ **: æ¸…æ™°çš„ä¿¡æ¯æ¶æ„ï¼Œç¼–è¾‘å’Œé¢„è§ˆåˆ†ç¦»
4. **å®æ—¶é¢„è§ˆ**: å¤§å›¾é¢„è§ˆï¼Œç‚¹å‡»æ”¾å¤§æŸ¥çœ‹ç»†èŠ‚
5. **æ¸å˜æŒ‰é’®**: AI åŠŸèƒ½ä½¿ç”¨ç´«ç²‰æ¸å˜ï¼Œè§†è§‰å¸å¼•åŠ›å¼º
6. **å“åº”å¼è®¾è®¡**: æ”¯æŒæ¡Œé¢å’Œç§»åŠ¨ç«¯

## ğŸ“ æäº¤å»ºè®®

å»ºè®®åˆ†å¤šæ¬¡æäº¤ï¼š

```bash
# 1. æ•°æ®åº“è¿ç§»
git add web/prisma/schema.prisma
git commit -m "feat: æ·»åŠ  DigitalHuman æ¨¡å‹å’Œæ•°æ®åº“è¿ç§»"

# 2. åç«¯ API
git add web/src/app/api/projects/[id]/characters/[characterId]/
git commit -m "feat: å®ç°æ•°å­—äººç”Ÿæˆã€æŸ¥è¯¢å’Œé€‰æ‹© API"

# 3. å‰ç«¯æœåŠ¡å±‚
git add client/src/services/project.ts client/src/types/index.ts
git commit -m "feat: æ·»åŠ æ•°å­—äººç›¸å…³çš„å‰ç«¯æœåŠ¡å’Œç±»å‹å®šä¹‰"

# 4. å‰ç«¯ç»„ä»¶
git add client/src/components/project/
git commit -m "feat: å®ç°æ•°å­—äººç”Ÿæˆå™¨å’Œè§’è‰²è¯¦æƒ…ç¼–è¾‘å™¨ç»„ä»¶"

# 5. å‰ç«¯é¡µé¢
git add client/src/pages/ProjectDetail.tsx
git commit -m "feat: é›†æˆæ•°å­—äººç”ŸæˆåŠŸèƒ½åˆ°é¡¹ç›®è¯¦æƒ…é¡µ"

# 6. æ–‡æ¡£
git add docs/features/
git commit -m "docs: æ·»åŠ è§’è‰²ç®¡ç†ç•Œé¢æ”¹è¿›çš„å®Œæ•´æ–‡æ¡£"
```

---

**å®ç°æ—¥æœŸ**: 2026-01-28
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… ä»£ç å®ç°å®Œæˆï¼Œå¾…æµ‹è¯•å’Œéƒ¨ç½²
