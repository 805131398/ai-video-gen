# Client 场景编辑器 - 添加其他角色显示

**日期**: 2026-01-28
**类型**: UI Enhancement
**关联**: AI生成场景-支持多角色场景-2026-01-28.md

## 问题

后端 API 已经生成了 `otherCharacters` 数据，但前端场景编辑页面没有显示这个字段，导致用户无法看到和编辑其他角色信息。

**用户反馈**：
```json
{
  "otherCharacters": [
    {
      "role": "寻求帮助的患者",
      "characterId": "38eb1278-1efe-4e8d-bd4f-22d74eef9158"
    }
  ]
}
```
数据存在，但页面上没有显示。

## 解决方案

在 `CharacterDialogueCard` 组件中添加"其他角色"部分的显示和编辑功能。

### UI 设计

#### 1. 主要角色
- 标签从"选择角色"改为"主要角色"
- 保持原有的选择框和描述显示

#### 2. 其他角色（新增）
- 标题："其他角色"
- 添加按钮："添加角色"
- 空状态提示："暂无其他角色，点击'添加角色'添加场景中的其他角色"

#### 3. 其他角色列表项
每个其他角色包含：
- 序号标识（1, 2, 3...）
- 角色选择下拉框
- 角色描述（自动显示）
- 在场景中的角色输入框（role）
- 删除按钮

### 实施细节

**文件**: `client/src/components/scene-edit/CharacterDialogueCard.tsx`

#### 1. 添加状态和处理函数

```typescript
const otherCharacters = content.otherCharacters || [];

const handleAddOtherCharacter = () => {
  onChange('content', {
    ...content,
    otherCharacters: [...otherCharacters, { characterId: '', role: '' }],
  });
};

const handleOtherCharacterChange = (index: number, field: string, value: string) => {
  const newOtherCharacters = [...otherCharacters];
  newOtherCharacters[index] = { ...newOtherCharacters[index], [field]: value };
  onChange('content', {
    ...content,
    otherCharacters: newOtherCharacters,
  });
};

const handleDeleteOtherCharacter = (index: number) => {
  const newOtherCharacters = otherCharacters.filter((_, i) => i !== index);
  onChange('content', {
    ...content,
    otherCharacters: newOtherCharacters,
  });
};
```

#### 2. 添加 UI 组件

```tsx
{/* 其他角色 */}
<div className="space-y-4">
  <div className="flex items-center justify-between">
    <h4 className="text-sm font-medium text-slate-700">其他角色</h4>
    <button onClick={handleAddOtherCharacter}>
      <Plus className="w-4 h-4" />
      添加角色
    </button>
  </div>

  {otherCharacters.length === 0 ? (
    <div className="text-center py-4 text-slate-500 text-sm bg-slate-50 rounded-lg">
      暂无其他角色，点击"添加角色"添加场景中的其他角色
    </div>
  ) : (
    <div className="space-y-3">
      {otherCharacters.map((otherChar, index) => (
        <div key={index} className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg">
          {/* 序号 */}
          <div className="w-8 h-8 rounded-full bg-slate-200">
            {index + 1}
          </div>

          {/* 角色信息 */}
          <div className="flex-1 space-y-3">
            {/* 角色选择 */}
            <div>
              <label>角色</label>
              <select
                value={otherChar.characterId}
                onChange={(e) => handleOtherCharacterChange(index, 'characterId', e.target.value)}
              >
                <option value="">请选择角色</option>
                {characters.map((character) => (
                  <option key={character.id} value={character.id}>
                    {character.name}
                  </option>
                ))}
              </select>
            </div>

            {/* 角色描述 */}
            <div>
              <label>在场景中的角色</label>
              <input
                type="text"
                value={otherChar.role}
                onChange={(e) => handleOtherCharacterChange(index, 'role', e.target.value)}
                placeholder="例如：接受治疗的患者、旁观的家人"
              />
            </div>
          </div>

          {/* 删除按钮 */}
          <button onClick={() => handleDeleteOtherCharacter(index)}>
            <Trash2 className="w-4 h-4" />
          </button>
        </div>
      ))}
    </div>
  )}
</div>
```

## UI 效果

### 空状态

```
┌─────────────────────────────────────────┐
│ 其他角色                    [+ 添加角色] │
├─────────────────────────────────────────┤
│                                         │
│  暂无其他角色，点击"添加角色"添加       │
│  场景中的其他角色                       │
│                                         │
└─────────────────────────────────────────┘
```

### 有数据状态

```
┌─────────────────────────────────────────┐
│ 其他角色                    [+ 添加角色] │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ [1] 角色: [父亲 ▼]            [🗑️] │ │
│ │     草根老中医的父亲                │ │
│ │     在场景中的角色:                 │ │
│ │     [接受治疗的患者            ]    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [2] 角色: [家人 ▼]            [🗑️] │ │
│ │     关心父亲的家人                  │ │
│ │     在场景中的角色:                 │ │
│ │     [旁观的家人                ]    │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 功能特点

### 1. 显示 AI 生成的其他角色

- ✅ 自动显示 AI 生成的 `otherCharacters` 数据
- ✅ 显示角色名称和描述
- ✅ 显示角色在场景中的作用（role）

### 2. 编辑其他角色

- ✅ 可以修改角色选择
- ✅ 可以修改角色描述（role）
- ✅ 可以添加新的其他角色
- ✅ 可以删除其他角色

### 3. 用户体验

- ✅ 清晰的视觉层次
- ✅ 直观的操作方式
- ✅ 友好的空状态提示
- ✅ 响应式设计

## 数据流

### 1. AI 生成 → 显示

```
AI 生成场景
    ↓
包含 otherCharacters 数据
    ↓
前端接收数据
    ↓
CharacterDialogueCard 显示
    ↓
用户看到其他角色列表
```

### 2. 用户编辑 → 保存

```
用户修改其他角色
    ↓
handleOtherCharacterChange
    ↓
更新 content.otherCharacters
    ↓
onChange 回调
    ↓
保存到数据库
```

## 修改的文件

1. **修改**: `client/src/components/scene-edit/CharacterDialogueCard.tsx`
   - 添加 `otherCharacters` 状态
   - 添加处理函数（添加、修改、删除）
   - 添加 UI 组件显示其他角色
   - 修改"选择角色"标签为"主要角色"

## 测试验证

### 测试用例 1：显示 AI 生成的其他角色

**前提**：
- AI 生成的场景包含 `otherCharacters` 数据

**操作**：
- 打开场景编辑页面

**预期**：
- ✅ "其他角色"部分显示角色列表
- ✅ 每个角色显示名称、描述和 role
- ✅ 可以看到角色在场景中的作用

### 测试用例 2：添加其他角色

**操作**：
- 点击"添加角色"按钮
- 选择角色
- 输入角色描述

**预期**：
- ✅ 新增一个其他角色项
- ✅ 可以选择角色
- ✅ 可以输入 role 描述

### 测试用例 3：删除其他角色

**操作**：
- 点击删除按钮

**预期**：
- ✅ 该角色从列表中移除
- ✅ 数据正确更新

## 用户体验提升

### 之前
- ❌ 看不到其他角色信息
- ❌ 无法编辑其他角色
- ❌ 多角色场景信息不完整

### 现在
- ✅ 清晰显示所有角色
- ✅ 可以编辑其他角色
- ✅ 完整展示多角色场景
- ✅ 直观的操作界面

## 总结

通过在 `CharacterDialogueCard` 组件中添加"其他角色"部分，成功实现了：

1. ✅ 显示 AI 生成的 `otherCharacters` 数据
2. ✅ 支持添加、编辑、删除其他角色
3. ✅ 清晰的 UI 设计和良好的用户体验
4. ✅ 完整展示多角色场景信息

现在用户可以在场景编辑页面看到和编辑所有角色信息，包括主要角色和其他角色，完整地展现多角色场景的全貌。
