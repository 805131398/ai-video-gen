# 角色剧本编辑功能实现总结

## 功能概述

在项目详情页面添加了"选择角色进入剧本编辑"功能，允许用户为选中的角色创建和编辑剧本。剧本编辑采用场景为主的组织方式，支持水平滚动的场景卡片布局。

## 实现内容

### 1. 数据库设计（混合存储方案）

#### 新增表结构

**ProjectScript 表（项目剧本表）**
- `id`: UUID 主键
- `projectId`: 关联项目
- `characterId`: 关联角色
- `title`: 剧本标题
- `description`: 剧本描述
- `version`: 版本号
- `isActive`: 是否为当前版本
- `createdAt`, `updatedAt`: 时间戳

**ScriptScene 表（剧本场景表）**
- `id`: UUID 主键
- `scriptId`: 关联剧本
- `title`: 场景标题
- `sortOrder`: 场景顺序
- `duration`: 预计时长（秒）
- `content`: JSON 详细内容
- `createdAt`, `updatedAt`: 时间戳

#### content JSON 结构

```json
{
  "description": "场景描述",
  "sceneType": "indoor|outdoor|special",
  "characters": [
    {
      "characterId": "角色ID",
      "characterName": "角色名称",
      "action": "动作描述",
      "emotion": "情绪",
      "position": "left|center|right"
    }
  ],
  "dialogues": [
    {
      "characterId": "角色ID",
      "text": "台词内容",
      "speed": "slow|normal|fast",
      "tone": "语气"
    }
  ],
  "camera": {
    "type": "closeup|medium|full|wide",
    "movement": "static|push|pull|follow"
  },
  "visual": {
    "transition": "转场效果",
    "effects": [],
    "subtitleStyle": "字幕样式"
  },
  "audio": {
    "bgm": "背景音乐",
    "soundEffects": []
  }
}
```

### 2. API 路由

创建了完整的 RESTful API：

**剧本管理**
- `GET /api/projects/[id]/scripts` - 获取项目的所有剧本
- `POST /api/projects/[id]/scripts` - 创建新剧本
- `GET /api/projects/[id]/scripts/[scriptId]` - 获取剧本详情
- `PUT /api/projects/[id]/scripts/[scriptId]` - 更新剧本
- `DELETE /api/projects/[id]/scripts/[scriptId]` - 删除剧本

**场景管理**
- `GET /api/projects/[id]/scripts/[scriptId]/scenes` - 获取剧本的所有场景
- `POST /api/projects/[id]/scripts/[scriptId]/scenes` - 创建新场景
- `GET /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]` - 获取场景详情
- `PUT /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]` - 更新场景
- `DELETE /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]` - 删除场景

### 3. 前端实现

#### 类型定义
- `SceneContent`: 场景内容接口
- `ScriptScene`: 剧本场景接口
- `ProjectScript`: 项目剧本接口

#### 服务层
创建了 `client/src/services/script.ts`，包含所有剧本和场景相关的 API 调用方法。

#### 页面组件
**ProjectScript 页面** (`client/src/pages/ProjectScript.tsx`)
- 水平滚动的场景卡片布局
- Tab 切换（场景视图/角色视图/时间轴视图）
- 场景编辑器（模态框）
- 添加、编辑、删除场景功能

**ProjectDetail 页面更新**
- 在"添加角色"按钮旁边添加了"选择角色"下拉选择器
- 添加了"编辑剧本"按钮
- 选择角色后自动创建剧本并跳转到剧本编辑页面

#### 路由配置
添加了新路由：`/projects/:id/script/:scriptId`

### 4. 界面设计

#### 项目详情页
```
┌─────────────────────────────────────────────┐
│ 项目标题 | 角色管理                          │
│                                             │
│ [选择角色] [添加角色]                        │
│                                             │
│ 点击"选择角色"后进入选择模式：               │
│ [取消选择] [编辑剧本 (2)] [添加角色]         │
│                                             │
│ 角色卡片显示选中状态（蓝色边框+勾选标记）    │
└─────────────────────────────────────────────┘
```

**选择角色交互流程：**
1. 点击"选择角色"按钮，进入选择模式
2. 角色卡片变为可点击状态，隐藏编辑/删除按钮
3. 点击角色卡片进行多选，选中的卡片显示蓝色边框和勾选标记
4. 选中至少一个角色后，显示"编辑剧本 (N)"按钮
5. 点击"编辑剧本"按钮，为第一个选中的角色创建剧本并跳转
6. 点击"取消选择"退出选择模式

#### 剧本编辑页
```
┌─────────────────────────────────────────────┐
│ 剧本标题 | 角色: XXX              [保存并返回] │
├─────────────────────────────────────────────┤
│ [场景视图] [角色视图] [时间轴视图]           │
├─────────────────────────────────────────────┤
│ ◀ ─────────────────────────────────────── ▶ │
│                                             │
│  ┌────────┐  ┌────────┐  ┌────────┐  [+]   │
│  │场景 1   │  │场景 2   │  │场景 3   │       │
│  │开场白   │  │产品演示 │  │用户评价 │       │
│  │⏱ 15s  │  │⏱ 30s  │  │⏱ 20s  │       │
│  │[编辑]  │  │[编辑]  │  │[编辑]  │       │
│  └────────┘  └────────┘  └────────┘       │
└─────────────────────────────────────────────┘
```

## 技术特点

1. **混合存储方案**：核心字段结构化，详细内容使用 JSON，兼顾灵活性和查询能力
2. **水平布局**：场景采用水平滚动布局，符合视频编辑软件的使用习惯
3. **Tab 预留**：为角色视图和时间轴视图预留了 Tab，便于后续扩展
4. **权限验证**：所有 API 都进行了用户身份验证和资源归属验证
5. **级联删除**：删除剧本时自动删除关联的场景
6. **多选交互**：支持多选角色，卡片显示选中状态（蓝色边框+勾选标记）
7. **模式切换**：选择模式下隐藏编辑/删除按钮，避免误操作

## 后续扩展方向

1. **场景编辑器完善**：实现完整的场景编辑表单，包含所有字段的编辑功能
2. **角色视图**：按角色组织剧本内容，便于管理单个角色的所有台词
3. **时间轴视图**：按时间顺序展示剧本，精确控制每个场景的时长
4. **拖拽排序**：支持拖拽调整场景顺序
5. **AI 辅助**：集成 AI 生成台词、场景描述等功能
6. **预览功能**：实时预览剧本效果
7. **导出功能**：导出为标准剧本格式（PDF、Word 等）

## 文件清单

### 后端（web/）
- `prisma/schema.prisma` - 数据库 schema 更新
- `src/app/api/projects/[id]/scripts/route.ts` - 剧本列表 API
- `src/app/api/projects/[id]/scripts/[scriptId]/route.ts` - 单个剧本 API
- `src/app/api/projects/[id]/scripts/[scriptId]/scenes/route.ts` - 场景列表 API
- `src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/route.ts` - 单个场景 API

### 前端（client/）
- `src/types/index.ts` - 类型定义更新
- `src/services/script.ts` - 剧本服务层
- `src/pages/ProjectScript.tsx` - 剧本编辑页面
- `src/pages/ProjectDetail.tsx` - 项目详情页面更新
- `src/App.tsx` - 路由配置更新

## 使用流程

1. 用户进入项目详情页面
2. 点击"选择角色"按钮，进入选择模式
3. 在角色卡片列表中点击选择角色（支持多选）
4. 选中的角色卡片显示蓝色边框和勾选标记
5. 点击"编辑剧本 (N)"按钮（N 为选中角色数量）
6. 系统为第一个选中的角色创建剧本并跳转到剧本编辑页面
7. 用户可以添加、编辑、删除场景
8. 每个场景包含完整的剧本信息（台词、动作、镜头等）
9. 保存后返回项目详情页面

## 注意事项

1. 场景编辑器目前是占位实现，需要后续完善
2. 角色视图和时间轴视图已预留 Tab，但功能未实现
3. 所有 API 都需要用户登录才能访问
4. 删除操作会弹出确认对话框，防止误删
5. 场景的 sortOrder 字段用于排序，创建时自动递增

## 测试建议

1. 测试创建剧本流程
2. 测试添加、编辑、删除场景
3. 测试场景的水平滚动
4. 测试权限验证（未登录、非项目所有者）
5. 测试级联删除（删除剧本时场景是否被删除）
6. 测试 Tab 切换（角色视图和时间轴视图应该显示"即将推出"）

## 完成时间

2026-01-28
