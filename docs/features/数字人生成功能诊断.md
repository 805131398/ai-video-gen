# 数字人生成功能诊断文档

## 功能概述

"生成角色数字人"按钮用于为项目角色生成 AI 数字人形象。

## 当前实现

### 1. 后端接口

**路径**: `/api/projects/[id]/characters/[characterId]/digital-humans/generate`

**文件**: `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts`

**流程**:
1. 验证用户认证（JWT token）
2. 验证项目所有权
3. 获取角色信息
4. 获取 AI 图像生成配置（AIModelType.IMAGE）
5. 构建提示词
6. 调用 AI 生成图片（批量生成 4 张）
7. 保存到数据库

**请求参数**:
```json
{
  "count": 4  // 生成数量，1-10 之间
}
```

**响应格式**:
```json
{
  "data": [
    {
      "id": "uuid",
      "characterId": "uuid",
      "imageUrl": "图片URL",
      "prompt": "生成提示词",
      "isSelected": false,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

### 2. 客户端调用

**文件**: `client/src/services/project.ts:101-111`

```typescript
export async function generateDigitalHumans(
  projectId: string,
  characterId: string,
  count: number = 4
): Promise<DigitalHuman[]> {
  const response = await api.post(
    `/projects/${projectId}/characters/${characterId}/digital-humans/generate`,
    { count }
  );
  return response.data.data || [];
}
```

### 3. UI 组件

**触发位置**: `client/src/components/project/DigitalHumanGenerator.tsx:85-101`

按钮文本: "生成角色数字人"

## 可能的问题

### 问题 1: AI 配置缺失

**症状**: 返回 500 错误，提示"未找到可用的 AI 图像生成配置"

**原因**: 数据库中没有配置 IMAGE 类型的 AI 模型

**解决方案**: 需要在数据库中添加 AI 图像生成配置

```sql
-- 检查是否有 IMAGE 类型的配置
SELECT * FROM "AIModelConfig" WHERE "modelType" = 'IMAGE' AND "isActive" = true;
```

### 问题 2: API Key 无效

**症状**: AI 生成失败，返回 500 错误

**原因**: 配置的 API Key 无效或过期

**解决方案**: 更新 AI 配置中的 API Key

### 问题 3: API URL 配置错误

**症状**: 请求超时或返回 HTML 页面

**原因**: API URL 配置不正确

**解决方案**: 检查 AI 配置中的 apiUrl 字段

### 问题 4: 认证失败

**症状**: 返回 401 错误

**原因**: Token 无效或过期

**解决方案**:
- 检查 localStorage 中的 access_token
- 重新登录获取新 token

## 诊断步骤

### 步骤 1: 检查网络请求

打开浏览器开发者工具 → Network 标签页，点击"生成角色数字人"按钮，查看：

1. 请求 URL 是否正确
2. 请求方法是否为 POST
3. 请求头是否包含 Authorization
4. 响应状态码
5. 响应内容

### 步骤 2: 检查后端日志

查看后端控制台输出：

```bash
# 在 web 目录下
pnpm dev
```

关注以下日志：
- `[AIClient.generateImage]` - AI 图像生成请求
- JWT verification failed - 认证失败
- AI Image API error - AI API 错误

### 步骤 3: 检查 AI 配置

```sql
-- 查看所有 IMAGE 类型的配置
SELECT
  id,
  "providerName",
  "modelName",
  "apiUrl",
  "isActive",
  "isDefault",
  priority
FROM "AIModelConfig"
WHERE "modelType" = 'IMAGE'
ORDER BY priority DESC;
```

### 步骤 4: 测试 AI 接口

使用 Postman 或 curl 直接测试 AI 图像生成接口：

```bash
curl -X POST "YOUR_AI_API_URL" \
  -H "Authorization: Bearer YOUR_AI_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "professional portrait of a person",
    "width": 512,
    "height": 768,
    "samples": 1
  }'
```

## 临时解决方案

如果 AI 配置有问题，可以先使用模拟数据测试 UI：

在 `CharacterDetailEditor.tsx:94-109` 中，当前已经有模拟数据逻辑：

```typescript
if (!character?.id) {
  // 返回模拟数据
  return new Promise((resolve) => {
    setTimeout(() => {
      const mockHumans: DigitalHuman[] = Array.from({ length: 4 }, (_, i) => ({
        id: `human-${Date.now()}-${i}`,
        imageUrl: `https://via.placeholder.com/400x600/667eea/ffffff?text=Digital+Human+${i + 1}`,
        prompt: `${desc.slice(0, 50)}...`,
        createdAt: new Date().toISOString(),
      }));
      resolve(mockHumans);
    }, 2000);
  });
}
```

## 下一步

1. 确认数据库中是否有 IMAGE 类型的 AI 配置
2. 如果没有，需要添加配置（可以通过管理后台或直接插入数据库）
3. 测试 AI 接口是否可用
4. 检查网络请求和响应
5. 根据错误信息进行针对性修复
