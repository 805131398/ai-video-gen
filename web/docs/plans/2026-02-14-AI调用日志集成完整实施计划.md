# AI 调用日志集成完整实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 在所有 AI 调用处集成日志记录功能，确保每次 AI 调用都记录到 AIUsageLog 表，实现完整的调用追踪和成本统计。

**Architecture:** 采用装饰器模式，在 AI 客户端层增加日志记录包装函数，在 API 路由层调用包装函数。对于异步轮询任务，在任务完成时记录日志。按 AI 类型分批实施：TEXT → IMAGE → VIDEO → VOICE。

**Tech Stack:** Next.js 16, Prisma 7, TypeScript, ai-usage-service

---

## 实施策略

**分批原则：** 按 AI 类型分批，每批包含客户端修改 + API 路由集成 + 测试验证

**批次划分：**
1. Batch 1: TEXT 类型（文案、标题、角色描述、剧本生成）
2. Batch 2: IMAGE 类型（图片生成、数字人生成）
3. Batch 3: VIDEO 类型（视频生成、轮询服务）
4. Batch 4: VOICE 类型（语音生成）
5. Batch 5: 统一测试和验证

---

## Batch 1: TEXT 类型日志集成

### Task 1.1: 增强 ai-usage-service 支持请求/响应记录

**Files:**
- Modify: `web/src/lib/services/ai-usage-service.ts`

**Step 1: 修改 LogAIUsageParams 接口**

在现有字段后添加：

```typescript
interface LogAIUsageParams {
  tenantId: string;
  userId: string;
  projectId?: string;
  modelType: AIModelType;
  modelConfigId?: string;
  inputTokens?: number;
  outputTokens?: number;
  cost?: number;
  latencyMs: number;
  status: AILogStatus;
  errorMessage?: string;
  taskId?: string;
  requestUrl?: string;      // 新增
  requestBody?: any;        // 新增
  responseBody?: any;       // 新增
}
```

**Step 2: 修改 logAIUsage 函数添加新字段**

```typescript
export async function logAIUsage(params: LogAIUsageParams) {
  try {
    const log = await prisma.aIUsageLog.create({
      data: {
        tenantId: params.tenantId,
        userId: params.userId,
        projectId: params.projectId,
        modelType: params.modelType,
        modelConfigId: params.modelConfigId,
        inputTokens: params.inputTokens || 0,
        outputTokens: params.outputTokens || 0,
        cost: params.cost || 0,
        latencyMs: params.latencyMs,
        status: params.status,
        errorMessage: params.errorMessage,
        taskId: params.taskId,
        requestUrl: params.requestUrl,         // 新增
        requestBody: params.requestBody,       // 新增
        responseBody: params.responseBody,     // 新增
      },
    });
    return log;
  } catch (error) {
    console.error("Failed to log AI usage:", error);
    return null;
  }
}
```

**Step 3: 修改 withUsageLogging 支持新字段**

```typescript
export async function withUsageLogging<T>(
  params: Omit<LogAIUsageParams, "latencyMs" | "status" | "errorMessage">,
  fn: () => Promise<{
    result: T;
    inputTokens?: number;
    outputTokens?: number;
    requestUrl?: string;      // 新增
    requestBody?: any;        // 新增
    responseBody?: any;       // 新增
  }>
): Promise<T> {
  const startTime = Date.now();

  try {
    const { result, inputTokens, outputTokens, requestUrl, requestBody, responseBody } = await fn();
    const latencyMs = Date.now() - startTime;

    const cost = estimateCost(
      params.modelType,
      inputTokens || 0,
      outputTokens || 0
    );

    await logAIUsage({
      ...params,
      inputTokens,
      outputTokens,
      cost,
      latencyMs,
      status: "SUCCESS",
      requestUrl,          // 新增
      requestBody,         // 新增
      responseBody,        // 新增
    });

    return result;
  } catch (error) {
    const latencyMs = Date.now() - startTime;

    await logAIUsage({
      ...params,
      latencyMs,
      status: "FAILED",
      errorMessage: error instanceof Error ? error.message : "Unknown error",
    });

    throw error;
  }
}
```

**Step 4: Commit**

```bash
git add src/lib/services/ai-usage-service.ts
git commit -m "feat(service): enhance ai-usage-service to support request/response logging"
```

---

### Task 1.2: 文案生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/ai/copywriting/route.ts`

**Step 1: 导入日志服务**

文件顶部添加：

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 generateCopywriting 调用**

找到 `const result = await generateCopywriting(...)` 这行，替换为：

```typescript
const result = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: body.projectId,
    modelType: "TEXT",
    modelConfigId: config.id,
    taskId: `copywriting-${Date.now()}`,
  },
  async () => {
    const copywritings = await generateCopywriting({
      config,
      title: body.title,
      attributes: body.attributes,
      count: body.count || 3,
    });

    return {
      result: copywritings,
      inputTokens: estimateTokenCount(body.title + JSON.stringify(body.attributes)),
      outputTokens: copywritings.reduce((sum, c) => sum + estimateTokenCount(c.content), 0),
      requestUrl: config.apiUrl,
      requestBody: { title: body.title, attributes: body.attributes, count: body.count },
      responseBody: { copywritings },
    };
  }
);
```

**Step 3: 添加 token 估算辅助函数**

文件末尾添加：

```typescript
function estimateTokenCount(text: string): number {
  // 粗略估算：中文 ~1.5 字符/token，英文 ~4 字符/token
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars / 1.5 + otherChars / 4);
}
```

**Step 4: Commit**

```bash
git add src/app/api/ai/copywriting/route.ts
git commit -m "feat(api): add usage logging to copywriting generation"
```

---

### Task 1.3: 标题生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/ai/titles/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 generateTitles 调用**

```typescript
const result = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: body.projectId,
    modelType: "TEXT",
    modelConfigId: config.id,
    taskId: `titles-${Date.now()}`,
  },
  async () => {
    const titles = await generateTitles({
      config,
      topic: body.topic,
      count: 5,
    });

    return {
      result: titles,
      inputTokens: estimateTokenCount(body.topic),
      outputTokens: titles.reduce((sum, t) => sum + estimateTokenCount(t.title), 0),
      requestUrl: config.apiUrl,
      requestBody: { topic: body.topic },
      responseBody: { titles },
    };
  }
);
```

**Step 3: 添加 token 估算函数**

```typescript
function estimateTokenCount(text: string): number {
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars / 1.5 + otherChars / 4);
}
```

**Step 4: Commit**

```bash
git add src/app/api/ai/titles/route.ts
git commit -m "feat(api): add usage logging to title generation"
```

---

### Task 1.4: 角色描述生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/characters/generate-description/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 AI 调用**

找到 `const text = await aiClient.generateText(...)` 这行，替换为：

```typescript
const text = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: id,
    modelType: "TEXT",
    modelConfigId: config.id,
    taskId: `character-desc-${characterId}`,
  },
  async () => {
    const description = await aiClient.generateText(
      `你是一个角色设定专家。请为以下角色生成一段简短的描述（100-200字）：

角色名称：${name}
基本信息：${JSON.stringify(body, null, 2)}

要求：
1. 突出角色的核心特点
2. 描述外貌、性格、背景
3. 语言生动、富有画面感
4. 不要分段，一段话即可`
    );

    return {
      result: description,
      inputTokens: estimateTokenCount(name + JSON.stringify(body)),
      outputTokens: estimateTokenCount(description),
      requestUrl: config.apiUrl,
      requestBody: { name, ...body },
      responseBody: { description },
    };
  }
);
```

**Step 3: 添加 token 估算函数**

```typescript
function estimateTokenCount(text: string): number {
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars / 1.5 + otherChars / 4);
}
```

**Step 4: 返回结果修改**

```typescript
return NextResponse.json({
  success: true,
  description: text,
});
```

**Step 5: Commit**

```bash
git add 'src/app/api/projects/[id]/characters/generate-description/route.ts'
git commit -m "feat(api): add usage logging to character description generation"
```

---

### Task 1.5: 剧本大纲生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/scripts/generate-synopsis/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 AI 调用**

找到 `const synopsis = await aiClient.generateText(...)` 这行，替换为：

```typescript
const synopsis = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: id,
    modelType: "TEXT",
    modelConfigId: config.id,
    taskId: `synopsis-${scriptId}`,
  },
  async () => {
    const result = await aiClient.generateText(prompt);

    return {
      result,
      inputTokens: estimateTokenCount(prompt),
      outputTokens: estimateTokenCount(result),
      requestUrl: config.apiUrl,
      requestBody: { prompt },
      responseBody: { synopsis: result },
    };
  }
);
```

**Step 3: 添加 token 估算函数**

```typescript
function estimateTokenCount(text: string): number {
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars / 1.5 + otherChars / 4);
}
```

**Step 4: Commit**

```bash
git add 'src/app/api/projects/[id]/scripts/generate-synopsis/route.ts'
git commit -m "feat(api): add usage logging to script synopsis generation"
```

---

### Task 1.6: 场景生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 AI 调用**

找到 `const scenesJson = await aiClient.generateText(...)` 这行，替换为：

```typescript
const scenesJson = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: id,
    modelType: "TEXT",
    modelConfigId: config.id,
    taskId: `scenes-${scriptId}`,
  },
  async () => {
    const result = await aiClient.generateText(prompt);

    return {
      result,
      inputTokens: estimateTokenCount(prompt),
      outputTokens: estimateTokenCount(result),
      requestUrl: config.apiUrl,
      requestBody: { prompt, synopsis: script.synopsis },
      responseBody: { scenes: result },
    };
  }
);
```

**Step 3: 添加 token 估算函数**

```typescript
function estimateTokenCount(text: string): number {
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars / 1.5 + otherChars / 4);
}
```

**Step 4: Commit**

```bash
git add 'src/app/api/projects/[id]/scripts/generate-scenes/route.ts'
git commit -m "feat(api): add usage logging to script scenes generation"
```

---

### Task 1.7: Batch 1 验证

**Step 1: 启动开发服务器**

```bash
pnpm dev
```

**Step 2: 测试文案生成**

访问应用，创建项目并生成文案，观察控制台日志。

**Step 3: 检查数据库**

访问 `/admin/ai-logs`，确认有新的 TEXT 类型日志记录。

**Step 4: 验证字段完整性**

点击详情，确认以下字段都有值：
- modelType: TEXT
- inputTokens, outputTokens (估算值)
- cost (估算值)
- latencyMs
- status: SUCCESS
- requestUrl, requestBody, responseBody
- taskId

**Step 5: Commit**

```bash
git add .
git commit -m "test: verify TEXT type AI logging integration"
```

---

## Batch 2: IMAGE 类型日志集成

### Task 2.1: 图片生成基础 API 集成日志

**Files:**
- Modify: `web/src/app/api/ai/images/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 generateImages 调用**

找到 `const images = await generateImages(...)` 这行，替换为：

```typescript
const images = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: body.projectId,
    modelType: "IMAGE",
    modelConfigId: config.id,
    taskId: `images-${Date.now()}`,
  },
  async () => {
    const result = await generateImages({
      config,
      prompt: body.prompt,
      count: body.count || 3,
    });

    return {
      result,
      inputTokens: body.prompt.length, // 图片以字符数计
      outputTokens: result.length, // 输出图片数量
      requestUrl: config.apiUrl,
      requestBody: { prompt: body.prompt, count: body.count },
      responseBody: { images: result },
    };
  }
);
```

**Step 3: Commit**

```bash
git add src/app/api/ai/images/route.ts
git commit -m "feat(api): add usage logging to basic image generation"
```

---

### Task 2.2: 项目图片生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/steps/images/generate/route.ts`

**重要说明：** 此 API 使用并发生成图片，需要为每张图片单独记录日志。

**Step 1: 导入日志服务**

```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";
```

**Step 2: 在图片生成成功回调中记录日志**

找到 `generateSingleImage()` 的成功处理部分，在更新数据库后添加日志记录：

```typescript
// 生成成功后
await prisma.projectStepOption.update({
  where: { id: option.id },
  data: {
    content: {
      ...(option.content as any),
      imageUrl: imageUrl,
      imageStatus: "COMPLETED",
      imageTaskId: taskId,
    },
  },
});

// 记录日志
await logAIUsage({
  tenantId: user.tenantId,
  userId: user.id,
  projectId: id,
  modelType: "IMAGE",
  modelConfigId: config.id,
  inputTokens: imagePrompt.length,
  outputTokens: 1, // 生成 1 张图
  cost: 0.02, // 根据模型调整
  latencyMs: Date.now() - startTime, // 需要在开始时记录 startTime
  status: "SUCCESS",
  taskId: taskId,
  requestUrl: config.apiUrl,
  requestBody: { prompt: imagePrompt },
  responseBody: { imageUrl },
});
```

**Step 3: 在图片生成失败回调中记录日志**

找到错误处理部分，添加：

```typescript
// 生成失败后
await prisma.projectStepOption.update({
  where: { id: option.id },
  data: {
    content: {
      ...(option.content as any),
      imageStatus: "FAILED",
      imageError: error,
    },
  },
});

// 记录日志
await logAIUsage({
  tenantId: user.tenantId,
  userId: user.id,
  projectId: id,
  modelType: "IMAGE",
  modelConfigId: config.id,
  inputTokens: imagePrompt.length,
  outputTokens: 0,
  cost: 0,
  latencyMs: Date.now() - startTime,
  status: "FAILED",
  errorMessage: error,
  taskId: taskId || `image-failed-${Date.now()}`,
  requestUrl: config.apiUrl,
  requestBody: { prompt: imagePrompt },
});
```

**Step 4: 记录生成开始时间**

在 `generateSingleImage()` 调用前添加：

```typescript
const startTime = Date.now();
```

**Step 5: Commit**

```bash
git add 'src/app/api/projects/[id]/steps/images/generate/route.ts'
git commit -m "feat(api): add usage logging to project image generation with async tracking"
```

---

### Task 2.3: 数字人生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts`

**Step 1: 导入日志服务**

```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";
```

**Step 2: 在生成成功回调中记录日志**

找到数字人记录创建后的位置，添加：

```typescript
// 数字人记录创建成功后
const dh = await prisma.digitalHuman.create({
  data: {
    characterId,
    imageUrl,
    prompt: finalPrompt,
    status: "COMPLETED",
    taskId,
  },
});

// 记录日志
await logAIUsage({
  tenantId: user.tenantId,
  userId: user.id,
  projectId: id,
  modelType: "IMAGE",
  modelConfigId: config.id,
  inputTokens: finalPrompt.length,
  outputTokens: 1,
  cost: 0.02,
  latencyMs: Date.now() - startTime,
  status: "SUCCESS",
  taskId: taskId,
  requestUrl: config.apiUrl,
  requestBody: { prompt: finalPrompt, characterId },
  responseBody: { imageUrl, digitalHumanId: dh.id },
});
```

**Step 3: 在生成失败回调中记录日志**

```typescript
// 数字人生成失败
const dh = await prisma.digitalHuman.create({
  data: {
    characterId,
    prompt: finalPrompt,
    status: "FAILED",
    errorMessage: error,
    taskId: taskId || undefined,
  },
});

// 记录日志
await logAIUsage({
  tenantId: user.tenantId,
  userId: user.id,
  projectId: id,
  modelType: "IMAGE",
  modelConfigId: config.id,
  inputTokens: finalPrompt.length,
  outputTokens: 0,
  cost: 0,
  latencyMs: Date.now() - startTime,
  status: "FAILED",
  errorMessage: error,
  taskId: taskId || `dh-failed-${Date.now()}`,
  requestUrl: config.apiUrl,
  requestBody: { prompt: finalPrompt, characterId },
});
```

**Step 4: 记录开始时间**

在批量生成开始前：

```typescript
const startTime = Date.now();
```

**Step 5: Commit**

```bash
git add 'src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts'
git commit -m "feat(api): add usage logging to digital human generation"
```

---

### Task 2.4: Batch 2 验证

**Step 1: 测试图片生成**

访问应用，生成项目图片和数字人。

**Step 2: 检查数据库**

访问 `/admin/ai-logs`，筛选 modelType=IMAGE，确认日志记录。

**Step 3: 验证异步任务日志**

确认每张图片都有独立的日志记录，包含 taskId。

**Step 4: Commit**

```bash
git add .
git commit -m "test: verify IMAGE type AI logging integration"
```

---

## Batch 3: VIDEO 类型日志集成

### Task 3.1: 单场景视频生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts`

**重要说明：** 视频生成是异步任务，需要在轮询完成时记录日志。

**Step 1: 导入日志服务**

```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";
```

**Step 2: 在视频任务提交时创建初始日志**

找到 `VideoClient.submit()` 后，添加：

```typescript
const taskId = response.taskId;
const videoTaskStartTime = Date.now();

// 创建场景视频记录
const sceneVideo = await prisma.sceneVideo.create({
  data: {
    sceneId,
    prompt: finalPrompt,
    referenceImage: finalReferenceImage,
    taskId,
    status: "PENDING",
    // ...
  },
});

// 记录初始日志（PENDING 状态）
const aiLogId = await logAIUsage({
  tenantId: user.tenantId,
  userId: user.id,
  projectId: id,
  modelType: "VIDEO",
  modelConfigId: config.id,
  inputTokens: finalPrompt.length,
  outputTokens: 0,
  cost: 0,
  latencyMs: 0,
  status: "PENDING",
  taskId: taskId,
  requestUrl: config.apiUrl,
  requestBody: {
    prompt: finalPrompt,
    duration: finalDuration,
    aspectRatio: body.aspectRatio,
    referenceImage: finalReferenceImage,
  },
});

// 保存日志 ID 到场景视频记录（用于后续更新）
await prisma.sceneVideo.update({
  where: { id: sceneVideo.id },
  data: {
    metadata: {
      ...(sceneVideo.metadata as any),
      aiLogId: aiLogId?.id,
      startTime: videoTaskStartTime,
    },
  },
});
```

**Step 3: Commit**

```bash
git add 'src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts'
git commit -m "feat(api): add initial usage logging to video generation (PENDING)"
```

---

### Task 3.2: 视频轮询服务集成日志更新

**Files:**
- Modify: `web/src/lib/services/video-polling-service.ts`

**Step 1: 导入日志服务**

```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";
import { prisma } from "@/lib/prisma";
```

**Step 2: 在轮询成功时更新日志**

找到视频状态更新为 COMPLETED 的位置，在数据库更新后添加：

```typescript
// 视频生成成功
await prisma.sceneVideo.update({
  where: { id: sceneVideo.id },
  data: {
    status: "COMPLETED",
    videoUrl: result.videoUrl,
    // ...
  },
});

// 更新 AI 日志（创建新记录标记为 SUCCESS）
const metadata = sceneVideo.metadata as any;
const aiLogId = metadata?.aiLogId;
const startTime = metadata?.startTime || Date.now();

if (aiLogId) {
  // 如果有初始日志 ID，可以选择更新（但 Prisma 中 AIUsageLog 没有 update 方法）
  // 所以我们创建一个新的 SUCCESS 记录
  await logAIUsage({
    tenantId: sceneVideo.scene.script.project.tenant?.id || "",
    userId: sceneVideo.scene.script.project.userId,
    projectId: sceneVideo.scene.script.projectId,
    modelType: "VIDEO",
    modelConfigId: config.id,
    inputTokens: sceneVideo.prompt.length,
    outputTokens: finalDuration, // 以秒数作为输出
    cost: estimateVideoCost(finalDuration),
    latencyMs: Date.now() - startTime,
    status: "SUCCESS",
    taskId: sceneVideo.taskId,
    requestUrl: config.apiUrl,
    responseBody: {
      videoUrl: result.videoUrl,
      duration: result.duration,
    },
  });
}
```

**Step 3: 在轮询失败时更新日志**

找到视频状态更新为 FAILED 的位置：

```typescript
// 视频生成失败
await prisma.sceneVideo.update({
  where: { id: sceneVideo.id },
  data: {
    status: "FAILED",
    error: result.message || "视频生成失败",
  },
});

// 记录失败日志
const metadata = sceneVideo.metadata as any;
const startTime = metadata?.startTime || Date.now();

await logAIUsage({
  tenantId: sceneVideo.scene.script.project.tenant?.id || "",
  userId: sceneVideo.scene.script.project.userId,
  projectId: sceneVideo.scene.script.projectId,
  modelType: "VIDEO",
  modelConfigId: config.id,
  inputTokens: sceneVideo.prompt.length,
  outputTokens: 0,
  cost: 0,
  latencyMs: Date.now() - startTime,
  status: "FAILED",
  errorMessage: result.message || "视频生成失败",
  taskId: sceneVideo.taskId,
  requestUrl: config.apiUrl,
});
```

**Step 4: 添加视频成本估算函数**

文件末尾添加：

```typescript
function estimateVideoCost(durationSeconds: number): number {
  // 视频成本估算：10s = $0.05, 15s = $0.075
  return durationSeconds <= 10 ? 0.05 : 0.075;
}
```

**Step 5: Commit**

```bash
git add src/lib/services/video-polling-service.ts
git commit -m "feat(service): add usage logging to video polling completion"
```

---

### Task 3.3: 多场景视频生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts`

**Step 1: 导入日志服务**

```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";
```

**Step 2: 在每个场景视频提交时记录日志**

找到循环提交视频任务的位置，为每个任务添加：

```typescript
for (const scene of scenes) {
  const startTime = Date.now();

  // 提交视频生成任务
  const response = await videoClient.submit({
    prompt: scene.prompt,
    // ...
  });

  const taskId = response.taskId;

  // 创建场景视频记录
  const sceneVideo = await prisma.sceneVideo.create({
    data: {
      sceneId: scene.id,
      taskId,
      prompt: scene.prompt,
      status: "PENDING",
      metadata: { startTime },
    },
  });

  // 记录初始日志
  await logAIUsage({
    tenantId: user.tenantId,
    userId: user.id,
    projectId: id,
    modelType: "VIDEO",
    modelConfigId: config.id,
    inputTokens: scene.prompt.length,
    outputTokens: 0,
    cost: 0,
    latencyMs: 0,
    status: "PENDING",
    taskId: taskId,
    requestUrl: config.apiUrl,
    requestBody: { prompt: scene.prompt, sceneId: scene.id },
  });
}
```

**Step 3: Commit**

```bash
git add 'src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts'
git commit -m "feat(api): add usage logging to batch video generation"
```

---

### Task 3.4: Batch 3 验证

**Step 1: 测试视频生成**

访问应用，生成场景视频。

**Step 2: 检查初始日志**

访问 `/admin/ai-logs`，筛选 modelType=VIDEO，确认有 PENDING 状态的日志。

**Step 3: 等待视频完成**

等待轮询完成，刷新日志页面，确认有 SUCCESS 状态的日志，且包含：
- latencyMs（完整的生成时长）
- cost（根据时长估算）
- responseBody（包含 videoUrl）

**Step 4: Commit**

```bash
git add .
git commit -m "test: verify VIDEO type AI logging integration"
```

---

## Batch 4: VOICE 类型日志集成

### Task 4.1: 语音生成 API 集成日志

**Files:**
- Modify: `web/src/app/api/ai/voice/route.ts`

**Step 1: 导入日志服务**

```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";
```

**Step 2: 包装 generateVoice 调用**

找到 `const audioUrl = await generateVoice(...)` 这行，替换为：

```typescript
const audioUrl = await withUsageLogging(
  {
    tenantId: user.tenantId,
    userId: user.id,
    projectId: body.projectId,
    modelType: "VOICE",
    modelConfigId: config.id,
    taskId: `voice-${Date.now()}`,
  },
  async () => {
    const result = await generateVoice({
      config,
      text: body.text,
      voiceId: body.voiceId,
    });

    return {
      result,
      inputTokens: body.text.length, // 字符数
      outputTokens: 1, // 音频文件数
      requestUrl: config.apiUrl,
      requestBody: { text: body.text, voiceId: body.voiceId },
      responseBody: { audioUrl: result },
    };
  }
);
```

**Step 3: Commit**

```bash
git add src/app/api/ai/voice/route.ts
git commit -m "feat(api): add usage logging to voice generation"
```

---

### Task 4.2: Batch 4 验证

**Step 1: 测试语音生成**

访问应用，生成配音。

**Step 2: 检查数据库**

访问 `/admin/ai-logs`，筛选 modelType=VOICE，确认日志记录。

**Step 3: Commit**

```bash
git add .
git commit -m "test: verify VOICE type AI logging integration"
```

---

## Batch 5: 统一测试和验证

### Task 5.1: 完整功能测试

**Step 1: 创建测试清单**

创建文件 `docs/testing/ai-logging-integration-test.md`：

```markdown
# AI 日志集成测试清单

## TEXT 类型
- [ ] 文案生成 - /api/ai/copywriting
- [ ] 标题生成 - /api/ai/titles
- [ ] 角色描述生成 - /api/projects/[id]/characters/generate-description
- [ ] 剧本大纲生成 - /api/projects/[id]/scripts/generate-synopsis
- [ ] 场景生成 - /api/projects/[id]/scripts/generate-scenes

## IMAGE 类型
- [ ] 基础图片生成 - /api/ai/images
- [ ] 项目图片生成 - /api/projects/[id]/steps/images/generate
- [ ] 数字人生成 - /api/projects/[id]/characters/[characterId]/digital-humans/generate

## VIDEO 类型
- [ ] 单场景视频生成 - /api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video
- [ ] 多场景视频生成 - /api/projects/[id]/scripts/[scriptId]/generate-videos
- [ ] 视频轮询完成日志更新

## VOICE 类型
- [ ] 语音生成 - /api/ai/voice

## 验证项
- [ ] 所有日志包含 requestUrl
- [ ] 所有日志包含 requestBody
- [ ] 成功的日志包含 responseBody
- [ ] 失败的日志包含 errorMessage
- [ ] 所有日志包含合理的 inputTokens/outputTokens
- [ ] 所有日志包含 cost 估算
- [ ] 所有日志包含 latencyMs
- [ ] 视频日志的 taskId 与 SceneVideo.taskId 一致
```

**Step 2: 执行测试**

按清单逐项测试。

**Step 3: Commit**

```bash
git add docs/testing/ai-logging-integration-test.md
git commit -m "docs: add AI logging integration test checklist"
```

---

### Task 5.2: 日志统计功能验证

**Step 1: 访问统计页面**

访问 `/admin/ai-stats`，确认统计数据正确：
- 总调用次数
- 成功/失败次数
- 各类型使用量
- 总成本

**Step 2: 访问日志列表**

访问 `/admin/ai-logs`，测试所有筛选功能：
- 时间范围筛选
- 模型类型筛选
- 状态筛选
- 用户筛选
- 项目筛选
- 关键词搜索
- 任务 ID 搜索

**Step 3: 测试详情抽屉**

点击"查看详情"，确认显示完整信息：
- 基本信息
- 请求信息（格式化 JSON）
- 响应信息（格式化 JSON）
- 错误信息（如有）
- 任务关联（点击跳转）

**Step 4: Commit**

```bash
git add .
git commit -m "test: verify AI logging statistics and UI features"
```

---

### Task 5.3: 性能和安全检查

**Step 1: 检查日志记录对性能的影响**

使用浏览器开发工具测量 API 响应时间，确认日志记录不会显著增加延迟（<50ms）。

**Step 2: 检查敏感信息**

确认日志中不包含：
- API Key
- 用户密码
- 其他敏感凭证

**Step 3: 检查日志失败处理**

在 `ai-usage-service.ts` 中，确认 `logAIUsage()` 失败时不会中断主流程（已实现 try-catch）。

**Step 4: Commit**

```bash
git add .
git commit -m "test: verify AI logging performance and security"
```

---

### Task 5.4: 文档更新

**Step 1: 更新 CLAUDE.md**

在 `CLAUDE.md` 中添加 AI 日志相关说明：

```markdown
## AI 调用日志

所有 AI 调用都会自动记录到 `AIUsageLog` 表，包括：
- 请求和响应详情
- Token 使用量和成本估算
- 调用延迟和状态
- 任务 ID（用于关联异步任务）

查看日志：访问后台管理 `/admin/ai-logs`

### 集成方式

**同步调用：**
```typescript
import { withUsageLogging } from "@/lib/services/ai-usage-service";

const result = await withUsageLogging(
  { tenantId, userId, modelType: "TEXT", ... },
  async () => {
    const data = await aiClient.generate(...);
    return {
      result: data,
      inputTokens: estimateTokens(input),
      outputTokens: estimateTokens(data),
      requestUrl: config.apiUrl,
      requestBody: { input },
      responseBody: { output: data },
    };
  }
);
```

**异步调用（视频等）：**
```typescript
import { logAIUsage } from "@/lib/services/ai-usage-service";

// 任务提交时记录 PENDING
await logAIUsage({ ..., status: "PENDING", taskId });

// 任务完成时记录 SUCCESS/FAILED
await logAIUsage({ ..., status: "SUCCESS", latencyMs, responseBody });
```
```

**Step 2: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: add AI logging integration guide to CLAUDE.md"
```

---

### Task 5.5: 最终验证和清理

**Step 1: 移除调试日志**

如果在 API 路由中添加了临时的 `console.log("[AI Logs API] ...")`，可以选择保留或移除。

**Step 2: 运行 Lint**

```bash
pnpm lint
```

Expected: 无错误

**Step 3: 构建测试**

```bash
pnpm build
```

Expected: 构建成功

**Step 4: 最终 Commit**

```bash
git add .
git commit -m "feat: complete AI usage logging integration for all AI types

- TEXT: copywriting, titles, character desc, script generation
- IMAGE: basic images, project images, digital humans
- VIDEO: scene generation with polling status tracking
- VOICE: voice generation

All AI calls now logged to AIUsageLog table with complete tracking."
```

---

## 文件清单

| 批次 | 操作 | 文件 |
|------|------|------|
| Task 1.1 | 修改 | `web/src/lib/services/ai-usage-service.ts` |
| Task 1.2 | 修改 | `web/src/app/api/ai/copywriting/route.ts` |
| Task 1.3 | 修改 | `web/src/app/api/ai/titles/route.ts` |
| Task 1.4 | 修改 | `web/src/app/api/projects/[id]/characters/generate-description/route.ts` |
| Task 1.5 | 修改 | `web/src/app/api/projects/[id]/scripts/generate-synopsis/route.ts` |
| Task 1.6 | 修改 | `web/src/app/api/projects/[id]/scripts/generate-scenes/route.ts` |
| Task 2.1 | 修改 | `web/src/app/api/ai/images/route.ts` |
| Task 2.2 | 修改 | `web/src/app/api/projects/[id]/steps/images/generate/route.ts` |
| Task 2.3 | 修改 | `web/src/app/api/projects/[id]/characters/[characterId]/digital-humans/generate/route.ts` |
| Task 3.1 | 修改 | `web/src/app/api/projects/[id]/scripts/[scriptId]/scenes/[sceneId]/generate-video/route.ts` |
| Task 3.2 | 修改 | `web/src/lib/services/video-polling-service.ts` |
| Task 3.3 | 修改 | `web/src/app/api/projects/[id]/scripts/[scriptId]/generate-videos/route.ts` |
| Task 4.1 | 修改 | `web/src/app/api/ai/voice/route.ts` |
| Task 5.1 | 新增 | `docs/testing/ai-logging-integration-test.md` |
| Task 5.4 | 修改 | `CLAUDE.md` |

**总计：** 15 个文件修改/新增

---

## 估算工作量

- Batch 1 (TEXT): 6 个任务 × 10 分钟 = 60 分钟
- Batch 2 (IMAGE): 4 个任务 × 15 分钟 = 60 分钟
- Batch 3 (VIDEO): 4 个任务 × 20 分钟 = 80 分钟
- Batch 4 (VOICE): 2 个任务 × 10 分钟 = 20 分钟
- Batch 5 (测试): 5 个任务 × 15 分钟 = 75 分钟

**总计：** ~295 分钟（约 5 小时）

---

## 注意事项

1. **Token 估算：** 当前使用简单的字符数估算，可以后续优化为调用 tokenizer
2. **成本估算：** `estimateCost()` 中的价格需要根据实际 AI 模型调整
3. **异步任务：** 视频和图片生成的异步任务需要在完成时更新日志，确保 taskId 一致
4. **错误处理：** 所有 `logAIUsage()` 调用都不应中断主流程（已实现 try-catch）
5. **性能影响：** 日志记录是额外的数据库写入，但由于是异步且有错误处理，对主流程影响很小
